[
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "companies_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE companies.companies ADD CONSTRAINT companies_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "company_id",
        "data_type": "companies.companies.id",
        "is_nullable": "rating_company_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE companies.ratings ADD CONSTRAINT rating_company_id_fkey FOREIGN KEY (company_id) REFERENCES companies.companies(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "rating_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE companies.ratings ADD CONSTRAINT rating_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "mission_id",
        "data_type": "missions.missions.id",
        "is_nullable": "ratings_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE companies.ratings ADD CONSTRAINT ratings_mission_id_fkey FOREIGN KEY (mission_id) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "domain_id",
        "data_type": "jobs.domains.id",
        "is_nullable": "fk_domain",
        "column_default": null,
        "full_definition": "ALTER TABLE jobs.categories ADD CONSTRAINT fk_domain FOREIGN KEY (domain_id) REFERENCES jobs.domains(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "category_id",
        "data_type": "jobs.categories.id",
        "is_nullable": "fk_category",
        "column_default": null,
        "full_definition": "ALTER TABLE jobs.jobs ADD CONSTRAINT fk_category FOREIGN KEY (category_id) REFERENCES jobs.categories(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "trame",
        "data_type": "public.trames.id",
        "is_nullable": "contrats_trame_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.contrats ADD CONSTRAINT contrats_trame_fkey FOREIGN KEY (trame) REFERENCES public.trames(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "profile_mission",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "contrats_profile_mission_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.contrats ADD CONSTRAINT contrats_profile_mission_fkey FOREIGN KEY (profile_mission) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "resolved_by",
        "data_type": "public.profiles.id",
        "is_nullable": "disputes_resolved_by_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.disputes ADD CONSTRAINT disputes_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "profile_mission",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "disputes_profile_mission_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.disputes ADD CONSTRAINT disputes_profile_mission_fkey FOREIGN KEY (profile_mission) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "opened_by_profile",
        "data_type": "public.profiles.id",
        "is_nullable": "disputes_opened_by_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.disputes ADD CONSTRAINT disputes_opened_by_profile_fkey FOREIGN KEY (opened_by_profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_id",
        "data_type": "providers.providers.id",
        "is_nullable": "invoices_issuer_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.invoices ADD CONSTRAINT invoices_issuer_id_fkey FOREIGN KEY (issuer_id) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "mission_id",
        "data_type": "missions.missions.id",
        "is_nullable": "invoices_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.invoices ADD CONSTRAINT invoices_mission_id_fkey FOREIGN KEY (mission_id) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "profile_mission_id",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "invoices_profile_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.invoices ADD CONSTRAINT invoices_profile_mission_id_fkey FOREIGN KEY (profile_mission_id) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_company_id",
        "data_type": "companies.companies.id",
        "is_nullable": "invoices_recipient_company_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.invoices ADD CONSTRAINT invoices_recipient_company_id_fkey FOREIGN KEY (recipient_company_id) REFERENCES companies.companies(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "sender_id",
        "data_type": "public.profiles.id",
        "is_nullable": "messages_sender_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.messages ADD CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "profile_mission_id",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "messages_profile_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.messages ADD CONSTRAINT messages_profile_mission_id_fkey FOREIGN KEY (profile_mission_id) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "mission_id",
        "data_type": "missions.missions.id",
        "is_nullable": "mission_schedules_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.mission_schedules ADD CONSTRAINT mission_schedules_mission_id_fkey FOREIGN KEY (mission_id) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "job",
        "data_type": "jobs.jobs.id",
        "is_nullable": "missions_job_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.missions ADD CONSTRAINT missions_job_fkey FOREIGN KEY (job) REFERENCES jobs.jobs(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "company_id",
        "data_type": "companies.companies.id",
        "is_nullable": "missions_company_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.missions ADD CONSTRAINT missions_company_id_fkey FOREIGN KEY (company_id) REFERENCES companies.companies(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "payment_flow_id",
        "data_type": "missions.payment_flows.id",
        "is_nullable": "payment_events_payment_flow_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.payment_events ADD CONSTRAINT payment_events_payment_flow_id_fkey FOREIGN KEY (payment_flow_id) REFERENCES missions.payment_flows(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "profile_mission_id",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "payment_flows_profile_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.payment_flows ADD CONSTRAINT payment_flows_profile_mission_id_fkey FOREIGN KEY (profile_mission_id) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "mission",
        "data_type": "missions.missions.id",
        "is_nullable": "profile_missions_mission_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.profile_missions ADD CONSTRAINT profile_missions_mission_fkey FOREIGN KEY (mission) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "profile_missions_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.profile_missions ADD CONSTRAINT profile_missions_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider",
        "data_type": "providers.providers.id",
        "is_nullable": "profile_missions_provider_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE missions.profile_missions ADD CONSTRAINT profile_missions_provider_fkey FOREIGN KEY (provider) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "provider",
        "data_type": "providers.providers.id",
        "is_nullable": "availabilities_provider_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.availabilities ADD CONSTRAINT availabilities_provider_fkey FOREIGN KEY (provider) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "provider_id",
        "data_type": "providers.providers.id",
        "is_nullable": "cancellation_logs_provider_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.cancellation_logs ADD CONSTRAINT cancellation_logs_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "profile_mission_id",
        "data_type": "missions.profile_missions.id",
        "is_nullable": "cancellation_logs_profile_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.cancellation_logs ADD CONSTRAINT cancellation_logs_profile_mission_id_fkey FOREIGN KEY (profile_mission_id) REFERENCES missions.profile_missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "mission_id",
        "data_type": "missions.missions.id",
        "is_nullable": "cancellation_logs_mission_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.cancellation_logs ADD CONSTRAINT cancellation_logs_mission_id_fkey FOREIGN KEY (mission_id) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "diplomes_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.diplomes ADD CONSTRAINT diplomes_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "provider_job",
        "data_type": "providers.provider_jobs.id",
        "is_nullable": "diplomes_provider_job_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.diplomes ADD CONSTRAINT diplomes_provider_job_fkey FOREIGN KEY (provider_job) REFERENCES providers.provider_jobs(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "provider_job",
        "data_type": "providers.provider_jobs.id",
        "is_nullable": "experiences_provider_job_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.experiences ADD CONSTRAINT experiences_provider_job_fkey FOREIGN KEY (provider_job) REFERENCES providers.provider_jobs(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "experiences_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.experiences ADD CONSTRAINT experiences_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "provider_id",
        "data_type": "providers.providers.id",
        "is_nullable": "google_tokens_provider_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.google_tokens ADD CONSTRAINT google_tokens_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "provider",
        "data_type": "providers.providers.id",
        "is_nullable": "provider_jobs_provider_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.provider_jobs ADD CONSTRAINT provider_jobs_provider_fkey FOREIGN KEY (provider) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "job",
        "data_type": "jobs.jobs.id",
        "is_nullable": "provider_jobs_job_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.provider_jobs ADD CONSTRAINT provider_jobs_job_fkey FOREIGN KEY (job) REFERENCES jobs.jobs(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "document_id",
        "data_type": "public.documents.id",
        "is_nullable": "provider_portfolio_document_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.provider_portfolio ADD CONSTRAINT provider_portfolio_document_id_fkey FOREIGN KEY (document_id) REFERENCES public.documents(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "provider_id",
        "data_type": "providers.providers.id",
        "is_nullable": "provider_portfolio_provider_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.provider_portfolio ADD CONSTRAINT provider_portfolio_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "providers_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.providers ADD CONSTRAINT providers_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "attestation_vigilance",
        "data_type": "public.documents.id",
        "is_nullable": "providers_attestation_vigilance_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.providers ADD CONSTRAINT providers_attestation_vigilance_fkey FOREIGN KEY (attestation_vigilance) REFERENCES public.documents(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "avis_situ_siren",
        "data_type": "public.documents.id",
        "is_nullable": "providers_avis_situ_siren_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.providers ADD CONSTRAINT providers_avis_situ_siren_fkey FOREIGN KEY (avis_situ_siren) REFERENCES public.documents(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "provider",
        "data_type": "providers.providers.id",
        "is_nullable": "ratings_provider_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.ratings ADD CONSTRAINT ratings_provider_fkey FOREIGN KEY (provider) REFERENCES providers.providers(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "company",
        "data_type": "companies.companies.id",
        "is_nullable": "ratings_company_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.ratings ADD CONSTRAINT ratings_company_fkey FOREIGN KEY (company) REFERENCES companies.companies(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "mission",
        "data_type": "missions.missions.id",
        "is_nullable": "ratings_mission_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE providers.ratings ADD CONSTRAINT ratings_mission_fkey FOREIGN KEY (mission) REFERENCES missions.missions(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "contract_id",
        "data_type": "missions.contrats.id",
        "is_nullable": "contract_evidence_checks_contract_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE public.contract_evidence_checks ADD CONSTRAINT contract_evidence_checks_contract_id_fkey FOREIGN KEY (contract_id) REFERENCES missions.contrats(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "profile",
        "data_type": "public.profiles.id",
        "is_nullable": "documents_profile_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE public.documents ADD CONSTRAINT documents_profile_fkey FOREIGN KEY (profile) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "profile_id",
        "data_type": "public.profiles.id",
        "is_nullable": "email_alert_logs_profile_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE public.email_alert_logs ADD CONSTRAINT email_alert_logs_profile_id_fkey FOREIGN KEY (profile_id) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "photo",
        "data_type": "public.documents.id",
        "is_nullable": "profiles_photo_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE public.profiles ADD CONSTRAINT profiles_photo_fkey FOREIGN KEY (photo) REFERENCES public.documents(id);"
    },
    {
        "object_type": "FOREIGN_KEY",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "user_id",
        "data_type": "public.profiles.id",
        "is_nullable": "push_subscriptions_user_id_fkey",
        "column_default": null,
        "full_definition": "ALTER TABLE public.push_subscriptions ADD CONSTRAINT push_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id);"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "companies",
        "object_name": "get_company_rating",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION companies.get_company_rating(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result JSON;\r\nBEGIN\r\n  SELECT json_build_object(\r\n    'average_rating', COALESCE(ROUND(AVG(rate)::numeric, 1), 0),\r\n    'total_reviews', COUNT(*)\r\n  ) INTO result\r\n  FROM companies.ratings\r\n  WHERE company_id = p_company_id;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "companies",
        "object_name": "set_email_alert_preferences",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION companies.set_email_alert_preferences(p_accept_all boolean DEFAULT NULL::boolean, p_alerts jsonb DEFAULT NULL::jsonb)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'companies', 'public'\nAS $function$\r\nDECLARE\r\n    v_profile_id UUID := auth.uid();\r\n    v_current JSONB;\r\n    v_result JSONB;\r\nBEGIN\r\n    IF v_profile_id IS NULL THEN\r\n        RAISE EXCEPTION 'Utilisateur non authentifie';\r\n    END IF;\r\n\r\n    IF p_accept_all IS NULL AND p_alerts IS NULL THEN\r\n        RAISE EXCEPTION 'Parametres invalides';\r\n    END IF;\r\n\r\n    SELECT accept_emails_alert\r\n    INTO v_current\r\n    FROM companies.companies\r\n    WHERE profile = v_profile_id\r\n    FOR UPDATE;\r\n\r\n    IF NOT FOUND THEN\r\n        RAISE EXCEPTION 'Entreprise introuvable';\r\n    END IF;\r\n\r\n    IF p_accept_all IS NOT NULL THEN\r\n        v_result := jsonb_build_object(\r\n            'mission_candidates_threshold', p_accept_all,\r\n            'mission_candidates_waiting', p_accept_all,\r\n            'provider_confirmed_availability', p_accept_all,\r\n            'mission_report_followup', p_accept_all\r\n        );\r\n    ELSE\r\n        v_result := COALESCE(v_current, jsonb_build_object(\r\n            'mission_candidates_threshold', false,\r\n            'mission_candidates_waiting', false,\r\n            'provider_confirmed_availability', false,\r\n            'mission_report_followup', false\r\n        ));\r\n    END IF;\r\n\r\n    IF p_alerts IS NOT NULL THEN\r\n        v_result := jsonb_build_object(\r\n            'mission_candidates_threshold', CASE\r\n                WHEN jsonb_typeof(p_alerts->'mission_candidates_threshold') = 'boolean'\r\n                    THEN (p_alerts->>'mission_candidates_threshold')::BOOLEAN\r\n                ELSE COALESCE((v_result->>'mission_candidates_threshold')::BOOLEAN, false)\r\n            END,\r\n            'mission_candidates_waiting', CASE\r\n                WHEN jsonb_typeof(p_alerts->'mission_candidates_waiting') = 'boolean'\r\n                    THEN (p_alerts->>'mission_candidates_waiting')::BOOLEAN\r\n                ELSE COALESCE((v_result->>'mission_candidates_waiting')::BOOLEAN, false)\r\n            END,\r\n            'provider_confirmed_availability', CASE\r\n                WHEN jsonb_typeof(p_alerts->'provider_confirmed_availability') = 'boolean'\r\n                    THEN (p_alerts->>'provider_confirmed_availability')::BOOLEAN\r\n                ELSE COALESCE((v_result->>'provider_confirmed_availability')::BOOLEAN, false)\r\n            END,\r\n            'mission_report_followup', CASE\r\n                WHEN jsonb_typeof(p_alerts->'mission_report_followup') = 'boolean'\r\n                    THEN (p_alerts->>'mission_report_followup')::BOOLEAN\r\n                ELSE COALESCE((v_result->>'mission_report_followup')::BOOLEAN, false)\r\n            END\r\n        );\r\n    END IF;\r\n\r\n    UPDATE companies.companies\r\n    SET accept_emails_alert = v_result\r\n    WHERE profile = v_profile_id;\r\n\r\n    RETURN jsonb_build_object(\r\n        'success', true,\r\n        'accept_emails_alert', v_result\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "calculate_signature_deadline",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.calculate_signature_deadline(p_mission_start_time timestamp with time zone, p_company_signed_at timestamp with time zone)\n RETURNS timestamp with time zone\n LANGUAGE plpgsql\n IMMUTABLE\nAS $function$\r\nDECLARE\r\n    v_time_until_mission INTERVAL;\r\n    v_one_day INTERVAL := INTERVAL '1 day';\r\nBEGIN\r\n    -- Calculate time until mission starts\r\n    v_time_until_mission := p_mission_start_time - p_company_signed_at;\r\n\r\n    -- If mission is more than 1 day away, provider has 1 day to sign\r\n    IF v_time_until_mission > v_one_day THEN\r\n        RETURN p_company_signed_at + v_one_day;\r\n    ELSE\r\n        -- If mission is less than 1 day away, provider has half the remaining time\r\n        RETURN p_company_signed_at + (v_time_until_mission / 2);\r\n    END IF;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "calculate_vat_amounts",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.calculate_vat_amounts(p_profile_mission_id uuid, p_hours_worked numeric, p_hours_supp numeric DEFAULT 0)\n RETURNS TABLE(amount_ht numeric, tva_rate numeric, tva_amount numeric, amount_ttc numeric, commission numeric, total_company_pays numeric)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_price_hour NUMERIC;\r\n  v_price_hour_supp NUMERIC;\r\n  v_regime_tva BOOLEAN;\r\n  v_base_ht NUMERIC;\r\n  v_supp_ht NUMERIC;\r\n  v_subtotal_ht NUMERIC;\r\n  v_tva_rate NUMERIC;\r\n  v_tva_amount NUMERIC;\r\n  v_subtotal_ttc NUMERIC;\r\n  v_commission NUMERIC;\r\n  v_total NUMERIC;\r\nBEGIN\r\n  -- Récupérer les données du profile_mission et du provider\r\n  SELECT\r\n    pm.price_hour,\r\n    pm.price_hour_supp,\r\n    COALESCE(prov.regime_tva, false)\r\n  INTO\r\n    v_price_hour,\r\n    v_price_hour_supp,\r\n    v_regime_tva\r\n  FROM missions.profile_missions pm\r\n  LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  -- Calculer montant HT\r\n  v_base_ht := p_hours_worked * v_price_hour;\r\n  v_supp_ht := p_hours_supp * COALESCE(v_price_hour_supp, v_price_hour * 1.25);\r\n  v_subtotal_ht := v_base_ht + v_supp_ht;\r\n\r\n  -- Calculer TVA\r\n  v_tva_rate := CASE WHEN v_regime_tva THEN 0.20 ELSE 0 END;\r\n  v_tva_amount := v_subtotal_ht * v_tva_rate;\r\n  v_subtotal_ttc := v_subtotal_ht + v_tva_amount;\r\n\r\n  -- Calculer commission (sur HT uniquement)\r\n  v_commission := v_subtotal_ht * 0.125;\r\n\r\n  -- Total entreprise paie\r\n  v_total := v_subtotal_ttc + v_commission;\r\n\r\n  RETURN QUERY SELECT\r\n    v_subtotal_ht as amount_ht,\r\n    v_tva_rate as tva_rate,\r\n    v_tva_amount as tva_amount,\r\n    v_subtotal_ttc as amount_ttc,\r\n    v_commission as commission,\r\n    v_total as total_company_pays;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "cancel_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.cancel_mission(p_profile_mission_id uuid, p_cancel_type text, p_user_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_profile_mission RECORD;\r\n  v_mission RECORD;\r\n  v_company_profile_id UUID;\r\n  v_provider_profile_id UUID;\r\n  v_hours_until_start NUMERIC;\r\n  v_result JSONB;\r\nBEGIN\r\n  -- 1. Get profile_mission with related data\r\n  SELECT\r\n    pm.*,\r\n    m.id AS mission_id,\r\n    m.start_time,\r\n    m.status AS mission_status,\r\n    m.company_id,\r\n    m.title AS mission_title\r\n  INTO v_profile_mission\r\n  FROM missions.profile_missions pm\r\n  JOIN missions.missions m ON m.id = pm.mission\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Profile mission not found');\r\n  END IF;\r\n\r\n  -- 2. Get company profile id\r\n  SELECT c.profile INTO v_company_profile_id\r\n  FROM companies.companies c\r\n  WHERE c.id = v_profile_mission.company_id;\r\n\r\n  -- 3. Get provider profile id\r\n  v_provider_profile_id := v_profile_mission.profile;\r\n\r\n  -- 4. Verify authorization\r\n  IF p_cancel_type = 'provider' THEN\r\n    IF p_user_id != v_provider_profile_id THEN\r\n      RETURN jsonb_build_object('success', false, 'error', 'Not authorized to cancel this mission');\r\n    END IF;\r\n  ELSIF p_cancel_type = 'company' THEN\r\n    IF p_user_id != v_company_profile_id THEN\r\n      RETURN jsonb_build_object('success', false, 'error', 'Not authorized to cancel this mission');\r\n    END IF;\r\n  ELSE\r\n    RETURN jsonb_build_object('success', false, 'error', 'Invalid cancel_type');\r\n  END IF;\r\n\r\n  -- 5. Check if already canceled\r\n  IF v_profile_mission.state = 'canceled' THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Mission already canceled');\r\n  END IF;\r\n\r\n  -- 6. Check 24h limit\r\n  v_hours_until_start := EXTRACT(EPOCH FROM (v_profile_mission.start_time - NOW())) / 3600;\r\n\r\n  IF v_hours_until_start < 24 THEN\r\n    RETURN jsonb_build_object(\r\n      'success', false,\r\n      'error', 'Cannot cancel less than 24 hours before mission start',\r\n      'hours_until_start', v_hours_until_start\r\n    );\r\n  END IF;\r\n\r\n  -- 7. Update profile_mission state to canceled\r\n  UPDATE missions.profile_missions\r\n  SET\r\n    state = 'canceled',\r\n    canceled_at = NOW(),\r\n    canceled_by = p_cancel_type\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  -- 8. Handle mission status based on cancel_type\r\n  IF p_cancel_type = 'provider' THEN\r\n    -- Provider cancels: mission goes back to 'open' so company can choose another provider\r\n    UPDATE missions.missions\r\n    SET status = 'open'\r\n    WHERE id = v_profile_mission.mission_id;\r\n\r\n    -- Delete/cancel associated contract if exists\r\n    UPDATE missions.contrats\r\n    SET status = 'canceled'\r\n    WHERE profile_mission = p_profile_mission_id;\r\n\r\n  ELSIF p_cancel_type = 'company' THEN\r\n    -- Company cancels: mission is definitively canceled\r\n    UPDATE missions.missions\r\n    SET status = 'canceled'\r\n    WHERE id = v_profile_mission.mission_id;\r\n\r\n    -- Cancel ALL profile_missions for this mission (not just the current one)\r\n    UPDATE missions.profile_missions\r\n    SET\r\n      state = 'canceled',\r\n      canceled_at = NOW(),\r\n      canceled_by = 'company'\r\n    WHERE mission = v_profile_mission.mission_id\r\n      AND id != p_profile_mission_id\r\n      AND state NOT IN ('canceled', 'completed');\r\n\r\n    -- Cancel all associated contracts\r\n    UPDATE missions.contrats\r\n    SET status = 'canceled'\r\n    WHERE profile_mission IN (\r\n      SELECT id FROM missions.profile_missions WHERE mission = v_profile_mission.mission_id\r\n    );\r\n  END IF;\r\n\r\n  -- 9. Build result with payment info for Stripe cancellation\r\n  v_result := jsonb_build_object(\r\n    'success', true,\r\n    'profile_mission_id', p_profile_mission_id,\r\n    'mission_id', v_profile_mission.mission_id,\r\n    'mission_title', v_profile_mission.mission_title,\r\n    'cancel_type', p_cancel_type,\r\n    'payment_intent_id', v_profile_mission.payment_intent_id,\r\n    'payment_status', v_profile_mission.payment_status,\r\n    'provider_profile_id', v_provider_profile_id,\r\n    'company_profile_id', v_company_profile_id\r\n  );\r\n\r\n  RETURN v_result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "cancel_mission_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.cancel_mission_v2(p_profile_mission_id uuid, p_cancel_type text, p_user_id uuid, p_reason text DEFAULT NULL::text)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_profile_mission RECORD;\r\n    v_mission RECORD;\r\n    v_contract RECORD;\r\n    v_company_profile_id UUID;\r\n    v_provider_profile_id UUID;\r\n    v_provider RECORD;\r\n    v_hours_until_start NUMERIC;\r\n    v_contract_both_signed BOOLEAN;\r\n    v_provider_paid BOOLEAN := FALSE;\r\n    v_sanction_result JSONB;\r\n    v_result JSONB;\r\nBEGIN\r\n    -- 1. Get profile_mission with related data\r\n    SELECT\r\n        pm.*,\r\n        m.id AS mission_id,\r\n        m.start_time,\r\n        m.end_time,\r\n        m.status AS mission_status,\r\n        m.company_id,\r\n        m.title AS mission_title,\r\n        m.job\r\n    INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF NOT FOUND THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- 2. Get company profile id\r\n    SELECT c.profile INTO v_company_profile_id\r\n    FROM companies.companies c\r\n    WHERE c.id = v_profile_mission.company_id;\r\n\r\n    -- 3. Get provider profile id and provider record\r\n    v_provider_profile_id := v_profile_mission.profile;\r\n\r\n    SELECT * INTO v_provider\r\n    FROM providers.providers\r\n    WHERE profile = v_provider_profile_id;\r\n\r\n    -- 4. Verify authorization\r\n    IF p_cancel_type = 'provider' THEN\r\n        IF p_user_id != v_provider_profile_id THEN\r\n            RETURN jsonb_build_object('success', false, 'error', 'Not authorized to cancel this mission');\r\n        END IF;\r\n\r\n        -- Check if provider is suspended\r\n        IF v_provider.suspension_status IN ('suspended_7d', 'suspended_30d', 'banned') THEN\r\n            IF v_provider.suspension_expires_at IS NULL OR v_provider.suspension_expires_at > NOW() THEN\r\n                RETURN jsonb_build_object('success', false, 'error', 'Votre compte est actuellement suspendu');\r\n            END IF;\r\n        END IF;\r\n    ELSIF p_cancel_type = 'company' THEN\r\n        IF p_user_id != v_company_profile_id THEN\r\n            RETURN jsonb_build_object('success', false, 'error', 'Not authorized to cancel this mission');\r\n        END IF;\r\n    ELSE\r\n        RETURN jsonb_build_object('success', false, 'error', 'Invalid cancel_type');\r\n    END IF;\r\n\r\n    -- 5. Check if already canceled\r\n    IF v_profile_mission.state = 'canceled' THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Mission already canceled');\r\n    END IF;\r\n\r\n    -- 6. Check mission hasn't started\r\n    IF v_profile_mission.start_time <= NOW() THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Impossible d''annuler une mission déjà commencée');\r\n    END IF;\r\n\r\n    -- 7. Calculate hours until start\r\n    v_hours_until_start := EXTRACT(EPOCH FROM (v_profile_mission.start_time - NOW())) / 3600;\r\n\r\n    -- 8. Get contract status\r\n    SELECT * INTO v_contract\r\n    FROM missions.contrats\r\n    WHERE profile_mission = p_profile_mission_id;\r\n\r\n    v_contract_both_signed := (v_contract.provider_signed_at IS NOT NULL AND v_contract.company_signed_at IS NOT NULL);\r\n\r\n    -- 9. Apply cancellation rules based on cancel_type\r\n    IF p_cancel_type = 'company' THEN\r\n        -- COMPANY CANCELLATION RULES:\r\n        -- If contract signed by both: cancellation allowed BUT provider paid 100%\r\n        -- If >= 48h before AND not both signed: free cancellation\r\n        -- If < 48h before AND provider signed: not allowed\r\n\r\n        IF v_contract_both_signed THEN\r\n            -- Contract signed by both: provider gets paid 100%\r\n            v_provider_paid := TRUE;\r\n        ELSIF v_hours_until_start < 48 AND v_contract.provider_signed_at IS NOT NULL THEN\r\n            -- Less than 48h AND provider already signed their part = no cancellation\r\n            RETURN jsonb_build_object(\r\n                'success', false,\r\n                'error', 'Impossible d''annuler moins de 48h avant le début de la mission lorsque le prestataire s''est déjà engagé',\r\n                'hours_until_start', v_hours_until_start\r\n            );\r\n        END IF;\r\n        -- >= 48h or provider hasn't signed = free cancellation\r\n\r\n    ELSIF p_cancel_type = 'provider' THEN\r\n        -- PROVIDER CANCELLATION RULES:\r\n        -- Cancellation is allowed anytime before mission starts\r\n        -- But sanctions apply if less than 48h before start\r\n        IF v_hours_until_start < 48 AND v_provider.id IS NOT NULL THEN\r\n            -- Apply progressive sanctions only if < 48h\r\n            v_sanction_result := providers.apply_cancellation_sanction(\r\n                v_provider.id,\r\n                p_profile_mission_id,\r\n                v_profile_mission.mission_id,\r\n                v_hours_until_start,\r\n                v_contract_both_signed,\r\n                p_reason\r\n            );\r\n        END IF;\r\n    END IF;\r\n\r\n    -- 10. Update profile_mission state to canceled\r\n    UPDATE missions.profile_missions\r\n    SET\r\n        state = 'canceled',\r\n        canceled_at = NOW(),\r\n        canceled_by = p_cancel_type,\r\n        cancellation_reason = p_reason,\r\n        provider_paid_on_cancel = v_provider_paid,\r\n        cancellation_hours_before_start = v_hours_until_start\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    -- 11. Handle mission status based on cancel_type\r\n    IF p_cancel_type = 'provider' THEN\r\n        -- Provider cancels: mission goes back to 'open' so company can choose another provider\r\n        UPDATE missions.missions\r\n        SET status = 'open'\r\n        WHERE id = v_profile_mission.mission_id;\r\n\r\n        -- Cancel associated contract if exists\r\n        UPDATE missions.contrats\r\n        SET status = 'canceled'\r\n        WHERE profile_mission = p_profile_mission_id;\r\n\r\n    ELSIF p_cancel_type = 'company' THEN\r\n        -- Company cancels: mission is definitively canceled\r\n        UPDATE missions.missions\r\n        SET status = 'canceled'\r\n        WHERE id = v_profile_mission.mission_id;\r\n\r\n        -- Cancel ALL profile_missions for this mission\r\n        UPDATE missions.profile_missions\r\n        SET\r\n            state = 'canceled',\r\n            canceled_at = NOW(),\r\n            canceled_by = 'company',\r\n            provider_paid_on_cancel = v_provider_paid\r\n        WHERE mission = v_profile_mission.mission_id\r\n            AND id != p_profile_mission_id\r\n            AND state NOT IN ('canceled', 'completed');\r\n\r\n        -- Cancel all associated contracts\r\n        UPDATE missions.contrats\r\n        SET status = 'canceled'\r\n        WHERE profile_mission IN (\r\n            SELECT id FROM missions.profile_missions WHERE mission = v_profile_mission.mission_id\r\n        );\r\n    END IF;\r\n\r\n    -- 12. Build result\r\n    v_result := jsonb_build_object(\r\n        'success', true,\r\n        'profile_mission_id', p_profile_mission_id,\r\n        'mission_id', v_profile_mission.mission_id,\r\n        'mission_title', v_profile_mission.mission_title,\r\n        'job_id', v_profile_mission.job,\r\n        'cancel_type', p_cancel_type,\r\n        'payment_intent_id', v_profile_mission.payment_intent_id,\r\n        'payment_status', v_profile_mission.payment_status,\r\n        'provider_profile_id', v_provider_profile_id,\r\n        'company_profile_id', v_company_profile_id,\r\n        'contract_both_signed', v_contract_both_signed,\r\n        'provider_paid', v_provider_paid,\r\n        'hours_until_start', v_hours_until_start\r\n    );\r\n\r\n    -- Add sanction info if provider canceled\r\n    IF v_sanction_result IS NOT NULL THEN\r\n        v_result := v_result || jsonb_build_object('sanction', v_sanction_result);\r\n    END IF;\r\n\r\n    RETURN v_result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "capture_payment_complete",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.capture_payment_complete(p_profile_mission_id uuid, p_payment_status text, p_payment_amount numeric, p_payment_captured_at timestamp with time zone, p_hours_worked numeric, p_hours_supp_worked numeric, p_commission_rate numeric, p_commission_amount numeric, p_state text DEFAULT 'completed'::text)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_mission_id uuid;\r\nBEGIN\r\n  -- Update profile_missions (removed updated_at which doesn't exist)\r\n  UPDATE missions.profile_missions\r\n  SET\r\n    payment_status = p_payment_status,\r\n    payment_amount = p_payment_amount,\r\n    payment_captured_at = p_payment_captured_at,\r\n    hours_worked = p_hours_worked,\r\n    hours_supp_worked = p_hours_supp_worked,\r\n    commission_rate = p_commission_rate,\r\n    commission_amount = p_commission_amount,\r\n    state = p_state\r\n  WHERE id = p_profile_mission_id\r\n  RETURNING mission INTO v_mission_id;\r\n\r\n  -- Mettre is_paid = TRUE sur la mission\r\n  UPDATE missions.missions\r\n  SET is_paid = TRUE\r\n  WHERE id = v_mission_id;\r\n\r\n  RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "check_can_capture_payment",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.check_can_capture_payment(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_pm RECORD;\r\nBEGIN\r\n    SELECT * INTO v_pm\r\n    FROM missions.profile_missions\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    IF v_pm IS NULL THEN\r\n        RETURN json_build_object('can_capture', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- Check if report was submitted\r\n    IF v_pm.report_submitted_at IS NULL THEN\r\n        RETURN json_build_object('can_capture', false, 'error', 'Report not yet submitted');\r\n    END IF;\r\n\r\n    -- Check validation status\r\n    IF v_pm.provider_validation_status IS NULL OR v_pm.provider_validation_status = 'pending' THEN\r\n        RETURN json_build_object('can_capture', false, 'error', 'Awaiting provider validation', 'status', 'pending');\r\n    END IF;\r\n\r\n    IF v_pm.provider_validation_status = 'disputed' THEN\r\n        RETURN json_build_object('can_capture', false, 'error', 'Mission is disputed', 'status', 'disputed');\r\n    END IF;\r\n\r\n    IF v_pm.provider_validation_status = 'approved' THEN\r\n        RETURN json_build_object(\r\n            'can_capture', true,\r\n            'hours_worked', v_pm.report_hours_worked,\r\n            'hours_supp', v_pm.report_hours_supp\r\n        );\r\n    END IF;\r\n\r\n    RETURN json_build_object('can_capture', false, 'error', 'Unknown validation status');\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "check_signature_deadline",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.check_signature_deadline()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n    -- Only check when state transitions to 'assigned'\r\n    IF NEW.state = 'assigned' AND (OLD.state IS DISTINCT FROM 'assigned') THEN\r\n        -- If there is a signature deadline and it has passed, block the transition\r\n        IF NEW.provider_signature_deadline IS NOT NULL\r\n           AND NOW() > NEW.provider_signature_deadline THEN\r\n            RAISE EXCEPTION 'Cannot assign provider: signature deadline has passed (%).',\r\n                NEW.provider_signature_deadline;\r\n        END IF;\r\n    END IF;\r\n\r\n    RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_contract_for_company_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_contract_for_company_v2(p_profile_mission_id uuid, p_trame_key text DEFAULT 'contrat_prestation'::text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_trame RECORD;\r\n    v_mission RECORD;\r\n    v_provider_profile RECORD;\r\n    v_provider RECORD;\r\n    v_company RECORD;\r\n    v_company_profile RECORD;\r\n    v_profile_mission RECORD;\r\n    v_markdown TEXT;\r\n    v_vars JSONB;\r\n    v_contract_id UUID;\r\n    v_hours NUMERIC;\r\n    v_base_amount NUMERIC;\r\n    v_key TEXT;\r\n    v_value TEXT;\r\n    v_schedules JSON;\r\n    v_total_hours NUMERIC := 0;\r\n    v_schedule RECORD;\r\n    v_regime_tva BOOLEAN;\r\n    v_taux_tva NUMERIC;\r\n    v_montant_tva NUMERIC;\r\n    v_montant_ttc NUMERIC;\r\n    v_horaires_par_jour TEXT;\r\n    v_already_existed BOOLEAN := false;\r\nBEGIN\r\n    -- Get the profile_mission\r\n    SELECT pm.* INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- Get mission and verify that the caller is the company owner\r\n    SELECT m.*, j.name as job_name\r\n    INTO v_mission\r\n    FROM missions.missions m\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    WHERE m.id = v_profile_mission.mission;\r\n\r\n    -- Get the company\r\n    SELECT c.* INTO v_company\r\n    FROM companies.companies c\r\n    WHERE c.id = v_mission.company_id;\r\n\r\n    -- Verify that the current user is the company owner\r\n    IF v_company.profile != auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized - you are not the company owner');\r\n    END IF;\r\n\r\n    -- Check that profile_mission is in valid state\r\n    IF v_profile_mission.state NOT IN ('confirmed', 'accepted') THEN\r\n        RETURN json_build_object('success', false, 'error', 'Le prestataire doit confirmer sa disponibilité avant de pouvoir signer le contrat');\r\n    END IF;\r\n\r\n    -- Check if a contract already exists (idempotent: return markdown without creating)\r\n    IF EXISTS (SELECT 1 FROM missions.contrats WHERE profile_mission = p_profile_mission_id) THEN\r\n        SELECT id INTO v_contract_id FROM missions.contrats WHERE profile_mission = p_profile_mission_id;\r\n        v_already_existed := true;\r\n    END IF;\r\n\r\n    -- ========================================================================\r\n    -- Generate markdown from trame (always, even if contract exists - for crash recovery)\r\n    -- ========================================================================\r\n\r\n    -- Get the template\r\n    SELECT * INTO v_trame FROM public.trames WHERE key = p_trame_key;\r\n    IF v_trame IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template ' || p_trame_key || ' not found');\r\n    END IF;\r\n\r\n    -- Get provider profile info\r\n    SELECT p.* INTO v_provider_profile\r\n    FROM public.profiles p\r\n    WHERE p.id = v_profile_mission.profile;\r\n\r\n    SELECT pr.* INTO v_provider\r\n    FROM providers.providers pr\r\n    WHERE pr.profile = v_profile_mission.profile;\r\n\r\n    -- Get company profile\r\n    SELECT p.* INTO v_company_profile\r\n    FROM public.profiles p\r\n    WHERE p.id = v_company.profile;\r\n\r\n    -- Fetch schedules for this mission\r\n    SELECT COALESCE(json_agg(\r\n        json_build_object(\r\n            'schedule_date', ms.schedule_date,\r\n            'start_time', ms.start_time,\r\n            'end_time', ms.end_time\r\n        ) ORDER BY ms.schedule_date ASC\r\n    ), '[]'::json)\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Build markdown lines for schedules (one line per day/time)\r\n    SELECT STRING_AGG(\r\n        '- '\r\n        || CASE EXTRACT(DOW FROM ms.schedule_date)\r\n            WHEN 0 THEN 'Dimanche'\r\n            WHEN 1 THEN 'Lundi'\r\n            WHEN 2 THEN 'Mardi'\r\n            WHEN 3 THEN 'Mercredi'\r\n            WHEN 4 THEN 'Jeudi'\r\n            WHEN 5 THEN 'Vendredi'\r\n            WHEN 6 THEN 'Samedi'\r\n           END\r\n        || ' ' || TO_CHAR(ms.schedule_date, 'DD/MM/YYYY')\r\n        || ' : '\r\n        || TO_CHAR(ms.start_time, 'HH24:MI')\r\n        || ' à '\r\n        || TO_CHAR(ms.end_time, 'HH24:MI'),\r\n        E'\\n'\r\n        ORDER BY ms.schedule_date ASC, ms.start_time ASC\r\n    )\r\n    INTO v_horaires_par_jour\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Fallback if no mission_schedules exists\r\n    IF COALESCE(v_horaires_par_jour, '') = '' THEN\r\n        v_horaires_par_jour := '- '\r\n            || CASE EXTRACT(DOW FROM (v_mission.start_time AT TIME ZONE 'Europe/Paris')::date)\r\n                WHEN 0 THEN 'Dimanche'\r\n                WHEN 1 THEN 'Lundi'\r\n                WHEN 2 THEN 'Mardi'\r\n                WHEN 3 THEN 'Mercredi'\r\n                WHEN 4 THEN 'Jeudi'\r\n                WHEN 5 THEN 'Vendredi'\r\n                WHEN 6 THEN 'Samedi'\r\n               END\r\n            || ' '\r\n            || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY')\r\n            || ' : '\r\n            || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI')\r\n            || ' à '\r\n            || TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI');\r\n    END IF;\r\n\r\n    -- Calculate total hours from schedules if multi-day, otherwise from start/end time\r\n    IF v_mission.is_multi_day = true THEN\r\n        FOR v_schedule IN\r\n            SELECT\r\n                ms.start_time,\r\n                ms.end_time\r\n            FROM missions.mission_schedules ms\r\n            WHERE ms.mission_id = v_mission.id\r\n        LOOP\r\n            v_total_hours := v_total_hours + EXTRACT(EPOCH FROM (v_schedule.end_time - v_schedule.start_time)) / 3600;\r\n        END LOOP;\r\n    ELSE\r\n        v_total_hours := EXTRACT(EPOCH FROM (v_mission.end_time - v_mission.start_time)) / 3600;\r\n    END IF;\r\n\r\n    v_hours := v_total_hours;\r\n    v_base_amount := v_hours * COALESCE(v_profile_mission.price_hour, 0);\r\n\r\n    -- TVA calculation based on regime_tva (BOOLEAN)\r\n    v_regime_tva := COALESCE(v_provider.regime_tva, false::boolean);\r\n\r\n    IF v_regime_tva THEN\r\n        v_taux_tva := 20.0;\r\n        v_montant_tva := v_base_amount * 0.20;\r\n        v_montant_ttc := v_base_amount * 1.20;\r\n    ELSE\r\n        v_taux_tva := 0.0;\r\n        v_montant_tva := 0.0;\r\n        v_montant_ttc := v_base_amount;\r\n    END IF;\r\n\r\n    -- Build variables for template\r\n    v_vars := jsonb_build_object(\r\n        'entreprise_nom', COALESCE(v_company.nom_commercial, v_company.siret, 'Entreprise'),\r\n        'entreprise_siret', COALESCE(v_company.siret, 'N/A'),\r\n        'entreprise_adresse', COALESCE(\r\n            CONCAT_WS(' ',\r\n                v_company.siret_gouv_infos::jsonb #>> '{etablissement,adresseEtablissement,numeroVoieEtablissement}',\r\n                v_company.siret_gouv_infos::jsonb #>> '{etablissement,adresseEtablissement,typeVoieEtablissement}',\r\n                v_company.siret_gouv_infos::jsonb #>> '{etablissement,adresseEtablissement,libelleVoieEtablissement}'\r\n            )\r\n            || ', '\r\n            || CONCAT_WS(' ',\r\n                v_company.siret_gouv_infos::jsonb #>> '{etablissement,adresseEtablissement,codePostalEtablissement}',\r\n                v_company.siret_gouv_infos::jsonb #>> '{etablissement,adresseEtablissement,libelleCommuneEtablissement}'\r\n            ),\r\n            'Adresse non spécifiée'\r\n        ),\r\n        'entreprise_email', COALESCE(v_company_profile.email, 'N/A'),\r\n        'entreprise_phone', COALESCE(v_company_profile.phone, 'N/A'),\r\n        'entreprise_representant', COALESCE(v_company_profile.first_name || ' ' || v_company_profile.last_name, v_company.nom_commercial, 'Le représentant légal')\r\n    );\r\n\r\n    -- Provider variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'prestataire_nom', UPPER(COALESCE(v_provider_profile.last_name, '')),\r\n        'prestataire_prenom', COALESCE(v_provider_profile.first_name, ''),\r\n        'prestataire_nom_complet', COALESCE(v_provider_profile.first_name, '') || ' ' || UPPER(COALESCE(v_provider_profile.last_name, '')),\r\n        'prestataire_civilite', CASE WHEN v_provider_profile.gender = 'male' THEN 'M.' WHEN v_provider_profile.gender = 'female' THEN 'Mme' ELSE '' END,\r\n        'prestataire_date_naissance', COALESCE(TO_CHAR(v_provider_profile.birth_date, 'DD/MM/YYYY'), 'N/A'),\r\n        'prestataire_nationalite', COALESCE(v_provider_profile.nationality, 'Française'),\r\n        'prestataire_adresse', COALESCE((v_provider.adresse_facturation::jsonb ->> 'value'), 'N/A'),\r\n        'prestataire_email', COALESCE(v_provider_profile.email, 'N/A'),\r\n        'prestataire_phone', COALESCE(v_provider_profile.phone, 'N/A'),\r\n        'prestataire_siret', COALESCE(v_provider.siret, 'N/A'),\r\n        'prestataire_regime_tva', v_regime_tva\r\n    );\r\n\r\n    -- Mission variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'mission_title', COALESCE(v_mission.title, 'Mission'),\r\n        'mission_description', COALESCE(v_mission.description, ''),\r\n        'poste', COALESCE(v_mission.job_name, 'Intervenant'),\r\n        'date_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_debut_court', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'heure_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'heure_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'horaires_par_jour', COALESCE(v_horaires_par_jour, ''),\r\n        'duree_heures', ROUND(v_hours, 1)::TEXT,\r\n        'lieu_mission', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non spécifié'),\r\n        'ville_mission', COALESCE(v_mission.city, 'N/A'),\r\n        'code_postal_mission', COALESCE(v_mission.postal_code, 'N/A'),\r\n        'lieu_travail', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non spécifié'),\r\n        'duree_totale', ROUND(v_hours, 1)::TEXT || ' heures',\r\n        'duree_travail', ROUND(v_hours, 1)::TEXT,\r\n        'is_multi_day', COALESCE(v_mission.is_multi_day, false)::TEXT,\r\n        'schedules', v_schedules::TEXT\r\n    );\r\n\r\n    -- Financial variables (with TVA)\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'taux_horaire', TO_CHAR(COALESCE(v_profile_mission.price_hour, 0), 'FM999G999D00'),\r\n        'taux_horaire_supp', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'taux_heures_sup', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'remuneration_brute', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'remuneration_totale', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'commission_gotcha', '12,5',\r\n        'total_avec_commission', TO_CHAR(v_base_amount * 1.125, 'FM999G999D00'),\r\n        'montant_ht_prestataire', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'taux_tva', CASE WHEN v_regime_tva THEN '20%' ELSE '0%' END,\r\n        'montant_tva_prestataire', TO_CHAR(v_montant_tva, 'FM999G999D00'),\r\n        'montant_ttc_prestataire', TO_CHAR(v_montant_ttc, 'FM999G999D00')\r\n    );\r\n\r\n    -- Date variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'date_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'lieu_signature', COALESCE(v_mission.city, 'N/A'),\r\n        'date_heure_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_generation', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI')\r\n    );\r\n\r\n    -- Get the markdown template from pdfkit_template\r\n    v_markdown := v_trame.pdfkit_template->>'markdown';\r\n    IF v_markdown IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template markdown not found');\r\n    END IF;\r\n\r\n    -- Replace all variables in markdown\r\n    FOR v_key, v_value IN SELECT * FROM jsonb_each_text(v_vars)\r\n    LOOP\r\n        v_markdown := REPLACE(v_markdown, '{{' || v_key || '}}', COALESCE(v_value, ''));\r\n    END LOOP;\r\n\r\n    -- ========================================================================\r\n    -- Insert contract if it doesn't exist yet\r\n    -- ========================================================================\r\n    IF NOT v_already_existed THEN\r\n        INSERT INTO missions.contrats (\r\n            profile_mission,\r\n            trame,\r\n            status,\r\n            signature_status\r\n        ) VALUES (\r\n            p_profile_mission_id,\r\n            v_trame.id,\r\n            'pending_company',\r\n            'pending'\r\n        )\r\n        RETURNING id INTO v_contract_id;\r\n    END IF;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'contract_id', v_contract_id,\r\n        'markdown_content', v_markdown,\r\n        'already_existed', v_already_existed\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_contract_for_company_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_contract_for_company_v2(p_profile_mission_id uuid, p_trame_key text DEFAULT 'contrat_prestation'::text, p_company_siret text DEFAULT NULL::text, p_company_address text DEFAULT NULL::text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_trame RECORD;\r\n    v_mission RECORD;\r\n    v_provider_profile RECORD;\r\n    v_provider RECORD;\r\n    v_company RECORD;\r\n    v_company_profile RECORD;\r\n    v_profile_mission RECORD;\r\n    v_markdown TEXT;\r\n    v_vars JSONB;\r\n    v_contract_id UUID;\r\n    v_hours NUMERIC;\r\n    v_base_amount NUMERIC;\r\n    v_key TEXT;\r\n    v_value TEXT;\r\n    v_schedules JSON;\r\n    v_total_hours NUMERIC := 0;\r\n    v_schedule RECORD;\r\n    v_regime_tva BOOLEAN;\r\n    v_taux_tva NUMERIC;\r\n    v_montant_tva NUMERIC;\r\n    v_montant_ttc NUMERIC;\r\n    v_horaires_par_jour TEXT;\r\n    v_already_existed BOOLEAN := false;\r\nBEGIN\r\n    -- Get the profile_mission\r\n    SELECT pm.* INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- Get mission and verify that the caller is the company owner\r\n    SELECT m.*, j.name as job_name\r\n    INTO v_mission\r\n    FROM missions.missions m\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    WHERE m.id = v_profile_mission.mission;\r\n\r\n    -- Get the company\r\n    SELECT c.* INTO v_company\r\n    FROM companies.companies c\r\n    WHERE c.id = v_mission.company_id;\r\n\r\n    -- Verify that the current user is the company owner\r\n    IF v_company.profile != auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized - you are not the company owner');\r\n    END IF;\r\n\r\n    -- Check that profile_mission is in valid state\r\n    IF v_profile_mission.state NOT IN ('confirmed', 'accepted') THEN\r\n        RETURN json_build_object('success', false, 'error', 'Le prestataire doit confirmer sa disponibilité avant de pouvoir signer le contrat');\r\n    END IF;\r\n\r\n    -- Check if a contract already exists (idempotent: return markdown without creating)\r\n    IF EXISTS (SELECT 1 FROM missions.contrats WHERE profile_mission = p_profile_mission_id) THEN\r\n        SELECT id INTO v_contract_id FROM missions.contrats WHERE profile_mission = p_profile_mission_id;\r\n        v_already_existed := true;\r\n    END IF;\r\n\r\n    -- ========================================================================\r\n    -- Generate markdown from trame (always, even if contract exists - for crash recovery)\r\n    -- ========================================================================\r\n\r\n    -- Get the template\r\n    SELECT * INTO v_trame FROM public.trames WHERE key = p_trame_key;\r\n    IF v_trame IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template ' || p_trame_key || ' not found');\r\n    END IF;\r\n\r\n    -- Get provider profile info\r\n    SELECT p.* INTO v_provider_profile\r\n    FROM public.profiles p\r\n    WHERE p.id = v_profile_mission.profile;\r\n\r\n    SELECT pr.* INTO v_provider\r\n    FROM providers.providers pr\r\n    WHERE pr.profile = v_profile_mission.profile;\r\n\r\n    -- Get company profile\r\n    SELECT p.* INTO v_company_profile\r\n    FROM public.profiles p\r\n    WHERE p.id = v_company.profile;\r\n\r\n    -- Fetch schedules for this mission\r\n    SELECT COALESCE(json_agg(\r\n        json_build_object(\r\n            'schedule_date', ms.schedule_date,\r\n            'start_time', ms.start_time,\r\n            'end_time', ms.end_time\r\n        ) ORDER BY ms.schedule_date ASC\r\n    ), '[]'::json)\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Build markdown lines for schedules (one line per day/time)\r\n    SELECT STRING_AGG(\r\n        '- '\r\n        || CASE EXTRACT(DOW FROM ms.schedule_date)\r\n            WHEN 0 THEN 'Dimanche'\r\n            WHEN 1 THEN 'Lundi'\r\n            WHEN 2 THEN 'Mardi'\r\n            WHEN 3 THEN 'Mercredi'\r\n            WHEN 4 THEN 'Jeudi'\r\n            WHEN 5 THEN 'Vendredi'\r\n            WHEN 6 THEN 'Samedi'\r\n           END\r\n        || ' ' || TO_CHAR(ms.schedule_date, 'DD/MM/YYYY')\r\n        || ' : '\r\n        || TO_CHAR(ms.start_time, 'HH24:MI')\r\n        || ' à '\r\n        || TO_CHAR(ms.end_time, 'HH24:MI'),\r\n        E'\\n'\r\n        ORDER BY ms.schedule_date ASC, ms.start_time ASC\r\n    )\r\n    INTO v_horaires_par_jour\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Fallback if no mission_schedules exists\r\n    IF COALESCE(v_horaires_par_jour, '') = '' THEN\r\n        v_horaires_par_jour := '- '\r\n            || CASE EXTRACT(DOW FROM (v_mission.start_time AT TIME ZONE 'Europe/Paris')::date)\r\n                WHEN 0 THEN 'Dimanche'\r\n                WHEN 1 THEN 'Lundi'\r\n                WHEN 2 THEN 'Mardi'\r\n                WHEN 3 THEN 'Mercredi'\r\n                WHEN 4 THEN 'Jeudi'\r\n                WHEN 5 THEN 'Vendredi'\r\n                WHEN 6 THEN 'Samedi'\r\n               END\r\n            || ' '\r\n            || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY')\r\n            || ' : '\r\n            || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI')\r\n            || ' à '\r\n            || TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI');\r\n    END IF;\r\n\r\n    -- Calculate total hours from schedules if multi-day, otherwise from start/end time\r\n    IF v_mission.is_multi_day = true THEN\r\n        FOR v_schedule IN\r\n            SELECT\r\n                ms.start_time,\r\n                ms.end_time\r\n            FROM missions.mission_schedules ms\r\n            WHERE ms.mission_id = v_mission.id\r\n        LOOP\r\n            v_total_hours := v_total_hours + EXTRACT(EPOCH FROM (v_schedule.end_time - v_schedule.start_time)) / 3600;\r\n        END LOOP;\r\n    ELSE\r\n        v_total_hours := EXTRACT(EPOCH FROM (v_mission.end_time - v_mission.start_time)) / 3600;\r\n    END IF;\r\n\r\n    v_hours := v_total_hours;\r\n    v_base_amount := v_hours * COALESCE(v_profile_mission.price_hour, 0);\r\n\r\n    -- TVA calculation based on regime_tva (BOOLEAN)\r\n    v_regime_tva := COALESCE(v_provider.regime_tva, false::boolean);\r\n\r\n    IF v_regime_tva THEN\r\n        v_taux_tva := 20.0;\r\n        v_montant_tva := v_base_amount * 0.20;\r\n        v_montant_ttc := v_base_amount * 1.20;\r\n    ELSE\r\n        v_taux_tva := 0.0;\r\n        v_montant_tva := 0.0;\r\n        v_montant_ttc := v_base_amount;\r\n    END IF;\r\n\r\n    -- Build variables for template\r\n    -- HOTFIX: p_company_siret et p_company_address passés par le serveur (déchiffrés)\r\n    v_vars := jsonb_build_object(\r\n        'entreprise_nom', COALESCE(v_company.nom_commercial, p_company_siret, 'Entreprise'),\r\n        'entreprise_siret', COALESCE(p_company_siret, 'N/A'),\r\n        'entreprise_adresse', COALESCE(p_company_address, 'Adresse non spécifiée'),\r\n        'entreprise_email', COALESCE(v_company_profile.email, 'N/A'),\r\n        'entreprise_phone', COALESCE(v_company_profile.phone, 'N/A'),\r\n        'entreprise_representant', COALESCE(v_company_profile.first_name || ' ' || v_company_profile.last_name, v_company.nom_commercial, 'Le représentant légal')\r\n    );\r\n\r\n    -- Provider variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'prestataire_nom', UPPER(COALESCE(v_provider_profile.last_name, '')),\r\n        'prestataire_prenom', COALESCE(v_provider_profile.first_name, ''),\r\n        'prestataire_nom_complet', COALESCE(v_provider_profile.first_name, '') || ' ' || UPPER(COALESCE(v_provider_profile.last_name, '')),\r\n        'prestataire_civilite', CASE WHEN v_provider_profile.gender = 'male' THEN 'M.' WHEN v_provider_profile.gender = 'female' THEN 'Mme' ELSE '' END,\r\n        'prestataire_date_naissance', COALESCE(TO_CHAR(v_provider_profile.birth_date, 'DD/MM/YYYY'), 'N/A'),\r\n        'prestataire_nationalite', COALESCE(v_provider_profile.nationality, 'Française'),\r\n        'prestataire_adresse', COALESCE((v_provider.adresse_facturation::jsonb ->> 'value'), 'N/A'),\r\n        'prestataire_email', COALESCE(v_provider_profile.email, 'N/A'),\r\n        'prestataire_phone', COALESCE(v_provider_profile.phone, 'N/A'),\r\n        'prestataire_siret', COALESCE(v_provider.siret, 'N/A'),\r\n        'prestataire_regime_tva', v_regime_tva\r\n    );\r\n\r\n    -- Mission variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'mission_title', COALESCE(v_mission.title, 'Mission'),\r\n        'mission_description', COALESCE(v_mission.description, ''),\r\n        'poste', COALESCE(v_mission.job_name, 'Intervenant'),\r\n        'date_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_debut_court', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'heure_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'heure_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'horaires_par_jour', COALESCE(v_horaires_par_jour, ''),\r\n        'duree_heures', ROUND(v_hours, 1)::TEXT,\r\n        'lieu_mission', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non spécifié'),\r\n        'ville_mission', COALESCE(v_mission.city, 'N/A'),\r\n        'code_postal_mission', COALESCE(v_mission.postal_code, 'N/A'),\r\n        'lieu_travail', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non spécifié'),\r\n        'duree_totale', ROUND(v_hours, 1)::TEXT || ' heures',\r\n        'duree_travail', ROUND(v_hours, 1)::TEXT,\r\n        'is_multi_day', COALESCE(v_mission.is_multi_day, false)::TEXT,\r\n        'schedules', v_schedules::TEXT\r\n    );\r\n\r\n    -- Financial variables (with TVA)\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'taux_horaire', TO_CHAR(COALESCE(v_profile_mission.price_hour, 0), 'FM999G999D00'),\r\n        'taux_horaire_supp', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'taux_heures_sup', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'remuneration_brute', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'remuneration_totale', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'commission_gotcha', '12,5',\r\n        'total_avec_commission', TO_CHAR(v_base_amount * 1.125, 'FM999G999D00'),\r\n        'montant_ht_prestataire', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'taux_tva', CASE WHEN v_regime_tva THEN '20%' ELSE '0%' END,\r\n        'montant_tva_prestataire', TO_CHAR(v_montant_tva, 'FM999G999D00'),\r\n        'montant_ttc_prestataire', TO_CHAR(v_montant_ttc, 'FM999G999D00')\r\n    );\r\n\r\n    -- Date variables\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'date_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'lieu_signature', COALESCE(v_mission.city, 'N/A'),\r\n        'date_heure_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI'),\r\n        'date_generation', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY à HH24:MI')\r\n    );\r\n\r\n    -- Get the markdown template from pdfkit_template\r\n    v_markdown := v_trame.pdfkit_template->>'markdown';\r\n    IF v_markdown IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template markdown not found');\r\n    END IF;\r\n\r\n    -- Replace all variables in markdown\r\n    FOR v_key, v_value IN SELECT * FROM jsonb_each_text(v_vars)\r\n    LOOP\r\n        v_markdown := REPLACE(v_markdown, '{{' || v_key || '}}', COALESCE(v_value, ''));\r\n    END LOOP;\r\n\r\n    -- ========================================================================\r\n    -- Insert contract if it doesn't exist yet\r\n    -- ========================================================================\r\n    IF NOT v_already_existed THEN\r\n        INSERT INTO missions.contrats (\r\n            profile_mission,\r\n            trame,\r\n            status,\r\n            signature_status\r\n        ) VALUES (\r\n            p_profile_mission_id,\r\n            v_trame.id,\r\n            'pending_company',\r\n            'pending'\r\n        )\r\n        RETURNING id INTO v_contract_id;\r\n    END IF;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'contract_id', v_contract_id,\r\n        'markdown_content', v_markdown,\r\n        'already_existed', v_already_existed\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_contract_for_company_v4",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_contract_for_company_v4(p_profile_mission_id uuid, p_trame_key text DEFAULT 'contrat_prestation'::text, p_company_siret text DEFAULT NULL::text, p_company_address text DEFAULT NULL::text, p_provider_siret text DEFAULT NULL::text, p_company_profile_json jsonb DEFAULT NULL::jsonb, p_provider_profile_json jsonb DEFAULT NULL::jsonb)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_trame RECORD;\r\n    v_mission RECORD;\r\n    v_provider RECORD;\r\n    v_company RECORD;\r\n    v_profile_mission RECORD;\r\n    v_markdown TEXT;\r\n    v_vars JSONB;\r\n    v_contract_id UUID;\r\n    v_hours NUMERIC;\r\n    v_base_amount NUMERIC;\r\n    v_key TEXT;\r\n    v_value TEXT;\r\n    v_schedules JSON;\r\n    v_total_hours NUMERIC := 0;\r\n    v_schedule RECORD;\r\n    v_regime_tva BOOLEAN;\r\n    v_taux_tva NUMERIC;\r\n    v_montant_tva NUMERIC;\r\n    v_montant_ttc NUMERIC;\r\n    v_horaires_par_jour TEXT;\r\n    v_already_existed BOOLEAN := false;\r\n    v_avantages_benevolat TEXT := '';\r\n    v_materiel_requis TEXT := '';\r\n    -- Profile data from JSON params (decrypted by Node)\r\n    v_provider_first_name TEXT;\r\n    v_provider_last_name TEXT;\r\n    v_provider_email TEXT;\r\n    v_provider_phone TEXT;\r\n    v_provider_gender TEXT;\r\n    v_provider_birth_date TEXT;\r\n    v_provider_nationality TEXT;\r\n    v_provider_address TEXT;\r\n    v_company_first_name TEXT;\r\n    v_company_last_name TEXT;\r\n    v_company_email TEXT;\r\n    v_company_phone TEXT;\r\nBEGIN\r\n    -- Extract profile data from JSON params\r\n    v_provider_first_name := p_provider_profile_json->>'first_name';\r\n    v_provider_last_name := p_provider_profile_json->>'last_name';\r\n    v_provider_email := p_provider_profile_json->>'email';\r\n    v_provider_phone := p_provider_profile_json->>'phone';\r\n    v_provider_gender := p_provider_profile_json->>'gender';\r\n    v_provider_birth_date := p_provider_profile_json->>'birth_date';\r\n    v_provider_nationality := p_provider_profile_json->>'nationality';\r\n    v_provider_address := p_provider_profile_json->>'address';\r\n    v_company_first_name := p_company_profile_json->>'first_name';\r\n    v_company_last_name := p_company_profile_json->>'last_name';\r\n    v_company_email := p_company_profile_json->>'email';\r\n    v_company_phone := p_company_profile_json->>'phone';\r\n\r\n    -- Get the profile_mission\r\n    SELECT pm.* INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- Get mission\r\n    SELECT m.*, j.name as job_name\r\n    INTO v_mission\r\n    FROM missions.missions m\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    WHERE m.id = v_profile_mission.mission;\r\n\r\n    -- Get the company\r\n    SELECT c.* INTO v_company\r\n    FROM companies.companies c\r\n    WHERE c.id = v_mission.company_id;\r\n\r\n    -- Verify caller is company owner\r\n    IF v_company.profile != auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized - you are not the company owner');\r\n    END IF;\r\n\r\n    -- Check valid state\r\n    IF v_profile_mission.state NOT IN ('confirmed', 'accepted') THEN\r\n        RETURN json_build_object('success', false, 'error', 'Le prestataire doit confirmer sa disponibilite avant de pouvoir signer le contrat');\r\n    END IF;\r\n\r\n    -- Check if contract already exists (idempotent)\r\n    IF EXISTS (SELECT 1 FROM missions.contrats WHERE profile_mission = p_profile_mission_id) THEN\r\n        SELECT id INTO v_contract_id FROM missions.contrats WHERE profile_mission = p_profile_mission_id;\r\n        v_already_existed := true;\r\n    END IF;\r\n\r\n    -- Get template\r\n    SELECT * INTO v_trame FROM public.trames WHERE key = p_trame_key;\r\n    IF v_trame IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template ' || p_trame_key || ' not found');\r\n    END IF;\r\n\r\n    -- Get provider info (non-profile data)\r\n    SELECT pr.* INTO v_provider\r\n    FROM providers.providers pr\r\n    WHERE pr.profile = v_profile_mission.profile;\r\n\r\n    -- Fetch schedules\r\n    SELECT COALESCE(json_agg(\r\n        json_build_object(\r\n            'schedule_date', ms.schedule_date,\r\n            'start_time', ms.start_time,\r\n            'end_time', ms.end_time\r\n        ) ORDER BY ms.schedule_date ASC\r\n    ), '[]'::json)\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Build schedule text\r\n    SELECT STRING_AGG(\r\n        '- '\r\n        || CASE EXTRACT(DOW FROM ms.schedule_date)\r\n            WHEN 0 THEN 'Dimanche' WHEN 1 THEN 'Lundi' WHEN 2 THEN 'Mardi'\r\n            WHEN 3 THEN 'Mercredi' WHEN 4 THEN 'Jeudi' WHEN 5 THEN 'Vendredi' WHEN 6 THEN 'Samedi'\r\n           END\r\n        || ' ' || TO_CHAR(ms.schedule_date, 'DD/MM/YYYY')\r\n        || ' : ' || TO_CHAR(ms.start_time, 'HH24:MI')\r\n        || ' a ' || TO_CHAR(ms.end_time, 'HH24:MI'),\r\n        E'\\n' ORDER BY ms.schedule_date ASC, ms.start_time ASC\r\n    )\r\n    INTO v_horaires_par_jour\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission.id;\r\n\r\n    -- Fallback if no schedules\r\n    IF COALESCE(v_horaires_par_jour, '') = '' THEN\r\n        v_horaires_par_jour := '- '\r\n            || CASE EXTRACT(DOW FROM (v_mission.start_time AT TIME ZONE 'Europe/Paris')::date)\r\n                WHEN 0 THEN 'Dimanche' WHEN 1 THEN 'Lundi' WHEN 2 THEN 'Mardi'\r\n                WHEN 3 THEN 'Mercredi' WHEN 4 THEN 'Jeudi' WHEN 5 THEN 'Vendredi' WHEN 6 THEN 'Samedi'\r\n               END\r\n            || ' ' || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY')\r\n            || ' : ' || TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI')\r\n            || ' a ' || TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI');\r\n    END IF;\r\n\r\n    -- Calculate hours\r\n    IF v_mission.is_multi_day = true THEN\r\n        FOR v_schedule IN\r\n            SELECT ms.start_time, ms.end_time\r\n            FROM missions.mission_schedules ms\r\n            WHERE ms.mission_id = v_mission.id\r\n        LOOP\r\n            v_total_hours := v_total_hours + EXTRACT(EPOCH FROM (v_schedule.end_time - v_schedule.start_time)) / 3600;\r\n        END LOOP;\r\n    ELSE\r\n        v_total_hours := EXTRACT(EPOCH FROM (v_mission.end_time - v_mission.start_time)) / 3600;\r\n    END IF;\r\n\r\n    v_hours := v_total_hours;\r\n    v_base_amount := v_hours * COALESCE(v_profile_mission.price_hour, 0);\r\n\r\n    -- Build volunteer-specific fields from mission columns\r\n    IF COALESCE(BTRIM(v_mission.avantages), '') <> '' THEN\r\n        v_avantages_benevolat := '- ' || REPLACE(\r\n            REGEXP_REPLACE(v_mission.avantages, E'\\\\r\\\\n?', E'\\\\n', 'g'),\r\n            E'\\n',\r\n            E'\\n- '\r\n        );\r\n    END IF;\r\n\r\n    IF COALESCE(array_length(v_mission.items_to_bring, 1), 0) > 0 THEN\r\n        SELECT STRING_AGG('- ' || item, E'\\n')\r\n        INTO v_materiel_requis\r\n        FROM unnest(v_mission.items_to_bring) AS item\r\n        WHERE COALESCE(BTRIM(item), '') <> '';\r\n    END IF;\r\n\r\n    v_avantages_benevolat := COALESCE(NULLIF(v_avantages_benevolat, ''), '- Aucun avantage specifie');\r\n    v_materiel_requis := COALESCE(NULLIF(v_materiel_requis, ''), '- Aucun materiel specifique');\r\n\r\n    -- TVA\r\n    v_regime_tva := COALESCE(v_provider.regime_tva, false::boolean);\r\n    IF v_regime_tva THEN\r\n        v_taux_tva := 20.0;\r\n        v_montant_tva := v_base_amount * 0.20;\r\n        v_montant_ttc := v_base_amount * 1.20;\r\n    ELSE\r\n        v_taux_tva := 0.0;\r\n        v_montant_tva := 0.0;\r\n        v_montant_ttc := v_base_amount;\r\n    END IF;\r\n\r\n    -- Build template variables using JSON params instead of reading profiles\r\n    v_vars := jsonb_build_object(\r\n        'entreprise_nom', COALESCE(v_company.nom_commercial, p_company_siret, 'Entreprise'),\r\n        'entreprise_siret', COALESCE(p_company_siret, 'N/A'),\r\n        'entreprise_adresse', COALESCE(p_company_address, 'Adresse non specifiee'),\r\n        'entreprise_email', COALESCE(v_company_email, 'N/A'),\r\n        'entreprise_phone', COALESCE(v_company_phone, 'N/A'),\r\n        'entreprise_representant', COALESCE(v_company_first_name || ' ' || v_company_last_name, v_company.nom_commercial, 'Le representant legal')\r\n    );\r\n\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'prestataire_nom', UPPER(COALESCE(v_provider_last_name, '')),\r\n        'prestataire_prenom', COALESCE(v_provider_first_name, ''),\r\n        'prestataire_nom_complet', COALESCE(v_provider_first_name, '') || ' ' || UPPER(COALESCE(v_provider_last_name, '')),\r\n        'prestataire_civilite', CASE WHEN v_provider_gender = 'male' THEN 'M.' WHEN v_provider_gender = 'female' THEN 'Mme' ELSE '' END,\r\n        'prestataire_date_naissance', COALESCE(v_provider_birth_date, 'N/A'),\r\n        'prestataire_nationalite', COALESCE(v_provider_nationality, 'Francaise'),\r\n        'prestataire_adresse', COALESCE(v_provider_address, 'N/A'),\r\n        'prestataire_email', COALESCE(v_provider_email, 'N/A'),\r\n        'prestataire_phone', COALESCE(v_provider_phone, 'N/A'),\r\n        'prestataire_siret', COALESCE(p_provider_siret, 'N/A'),\r\n        'prestataire_regime_tva', v_regime_tva\r\n    );\r\n\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'mission_title', COALESCE(v_mission.title, 'Mission'),\r\n        'mission_description', COALESCE(v_mission.description, ''),\r\n        'poste', COALESCE(v_mission.job_name, 'Intervenant'),\r\n        'date_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY a HH24:MI'),\r\n        'date_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY a HH24:MI'),\r\n        'date_debut_court', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'heure_debut', TO_CHAR(v_mission.start_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'heure_fin', TO_CHAR(v_mission.end_time AT TIME ZONE 'Europe/Paris', 'HH24:MI'),\r\n        'horaires_par_jour', COALESCE(v_horaires_par_jour, ''),\r\n        'duree_heures', ROUND(v_hours, 1)::TEXT,\r\n        'lieu_mission', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non specifie'),\r\n        'ville_mission', COALESCE(v_mission.city, 'N/A'),\r\n        'code_postal_mission', COALESCE(v_mission.postal_code, 'N/A'),\r\n        'lieu_travail', COALESCE(v_mission.location || ', ' || v_mission.postal_code || ' ' || v_mission.city, 'Lieu non specifie'),\r\n        'duree_totale', ROUND(v_hours, 1)::TEXT || ' heures',\r\n        'duree_travail', ROUND(v_hours, 1)::TEXT,\r\n        'is_multi_day', COALESCE(v_mission.is_multi_day, false)::TEXT,\r\n        'schedules', v_schedules::TEXT,\r\n        'nb_participants', COALESCE(v_mission.nb_participants::TEXT, ''),\r\n        'avantages_benevolat', v_avantages_benevolat,\r\n        'materiel_requis', v_materiel_requis\r\n    );\r\n\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'taux_horaire', TO_CHAR(COALESCE(v_profile_mission.price_hour, 0), 'FM999G999D00'),\r\n        'taux_horaire_supp', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'taux_heures_sup', TO_CHAR(COALESCE(v_profile_mission.price_hour_supp, 0), 'FM999G999D00'),\r\n        'remuneration_brute', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'remuneration_totale', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'commission_gotcha', '12,5',\r\n        'total_avec_commission', TO_CHAR(v_base_amount * 1.125, 'FM999G999D00'),\r\n        'montant_ht_prestataire', TO_CHAR(v_base_amount, 'FM999G999D00'),\r\n        'taux_tva', CASE WHEN v_regime_tva THEN '20%' ELSE '0%' END,\r\n        'montant_tva_prestataire', TO_CHAR(v_montant_tva, 'FM999G999D00'),\r\n        'montant_ttc_prestataire', TO_CHAR(v_montant_ttc, 'FM999G999D00')\r\n    );\r\n\r\n    v_vars := v_vars || jsonb_build_object(\r\n        'date_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY'),\r\n        'lieu_signature', COALESCE(v_mission.city, 'N/A'),\r\n        'date_heure_signature', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY a HH24:MI'),\r\n        'date_generation', TO_CHAR(NOW() AT TIME ZONE 'Europe/Paris', 'DD/MM/YYYY a HH24:MI')\r\n    );\r\n\r\n    -- Get markdown template\r\n    v_markdown := v_trame.pdfkit_template->>'markdown';\r\n    IF v_markdown IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Template markdown not found');\r\n    END IF;\r\n\r\n    -- Replace all variables\r\n    FOR v_key, v_value IN SELECT * FROM jsonb_each_text(v_vars)\r\n    LOOP\r\n        v_markdown := REPLACE(v_markdown, '{{' || v_key || '}}', COALESCE(v_value, ''));\r\n    END LOOP;\r\n\r\n    -- Insert contract if new\r\n    IF NOT v_already_existed THEN\r\n        INSERT INTO missions.contrats (\r\n            profile_mission, trame, status, signature_status\r\n        ) VALUES (\r\n            p_profile_mission_id, v_trame.id, 'pending_company', 'pending'\r\n        )\r\n        RETURNING id INTO v_contract_id;\r\n    END IF;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'contract_id', v_contract_id,\r\n        'markdown_content', v_markdown,\r\n        'already_existed', v_already_existed\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_mission(p_company_id uuid, p_title text, p_description text, p_location text, p_postal_code character varying, p_city character varying, p_latitude double precision, p_longitude double precision, p_start_time timestamp without time zone, p_end_time timestamp without time zone, p_job integer, p_benevole boolean DEFAULT false, p_requires_mobility boolean DEFAULT false, p_items_to_bring text[] DEFAULT NULL::text[], p_nb_participants integer DEFAULT 1, p_avantages text[] DEFAULT NULL::text[])\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_mission_id uuid;\r\nBEGIN\r\n    INSERT INTO missions.missions (\r\n        company_id,\r\n        title,\r\n        description,\r\n        location,\r\n        postal_code,\r\n        city,\r\n        latitude,\r\n        longitude,\r\n        start_time,\r\n        end_time,\r\n        job,\r\n        benevole,\r\n        requires_mobility,\r\n        items_to_bring,\r\n        nb_participants,\r\n        avantages,\r\n        status,\r\n        is_paid\r\n    ) VALUES (\r\n        p_company_id,\r\n        p_title,\r\n        p_description,\r\n        p_location,\r\n        p_postal_code,\r\n        p_city,\r\n        p_latitude,\r\n        p_longitude,\r\n        p_start_time,\r\n        p_end_time,\r\n        p_job,\r\n        p_benevole,\r\n        p_requires_mobility,\r\n        p_items_to_bring,\r\n        p_nb_participants,\r\n        p_avantages,\r\n        'open',  -- Changed from 'ouverte' to 'open'\r\n        false\r\n    )\r\n    RETURNING id INTO v_mission_id;\r\n\r\n    RETURN v_mission_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_mission_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_mission_v2(p_company_id uuid, p_title text, p_description text, p_location text, p_postal_code character varying, p_city character varying, p_latitude double precision, p_longitude double precision, p_job integer, p_benevole boolean DEFAULT false, p_requires_mobility boolean DEFAULT false, p_items_to_bring text[] DEFAULT NULL::text[], p_nb_participants integer DEFAULT 1, p_avantages text[] DEFAULT NULL::text[], p_schedules jsonb DEFAULT '[]'::jsonb)\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_mission_id UUID;\r\n  v_schedule JSONB;\r\n  v_start_date DATE;\r\n  v_end_date DATE;\r\n  v_first_schedule_start TIMESTAMP;\r\n  v_last_schedule_end TIMESTAMP;\r\n  v_schedule_count INTEGER;\r\n  v_schedule_date DATE;\r\n  v_start_time TIME;\r\n  v_end_time TIME;\r\n  v_start_hour INTEGER;\r\n  v_start_minute INTEGER;\r\n  v_end_hour INTEGER;\r\n  v_end_minute INTEGER;\r\nBEGIN\r\n  -- Get schedule count\r\n  v_schedule_count := jsonb_array_length(p_schedules);\r\n\r\n  -- Validate that we have at least one schedule\r\n  IF v_schedule_count = 0 THEN\r\n    RAISE EXCEPTION 'At least one schedule is required';\r\n  END IF;\r\n\r\n  -- Calculate start_date and end_date from schedules\r\n  SELECT\r\n    MIN((schedule->>'date')::DATE),\r\n    MAX((schedule->>'date')::DATE)\r\n  INTO v_start_date, v_end_date\r\n  FROM jsonb_array_elements(p_schedules) AS schedule;\r\n\r\n  -- Calculate the first schedule's start datetime for the mission's start_time\r\n  -- (used for backward compatibility and sorting)\r\n  SELECT schedule->>'date',\r\n         (schedule->>'start_hour')::INTEGER,\r\n         (schedule->>'start_minute')::INTEGER,\r\n         (schedule->>'end_hour')::INTEGER,\r\n         (schedule->>'end_minute')::INTEGER\r\n  INTO v_schedule_date, v_start_hour, v_start_minute, v_end_hour, v_end_minute\r\n  FROM jsonb_array_elements(p_schedules) AS schedule\r\n  ORDER BY (schedule->>'date')::DATE ASC\r\n  LIMIT 1;\r\n\r\n  v_first_schedule_start := (v_schedule_date || ' ' ||\r\n    LPAD(v_start_hour::TEXT, 2, '0') || ':' ||\r\n    LPAD(v_start_minute::TEXT, 2, '0') || ':00')::TIMESTAMP;\r\n\r\n  -- Calculate the last schedule's end datetime for the mission's end_time\r\n  SELECT schedule->>'date',\r\n         (schedule->>'start_hour')::INTEGER,\r\n         (schedule->>'start_minute')::INTEGER,\r\n         (schedule->>'end_hour')::INTEGER,\r\n         (schedule->>'end_minute')::INTEGER\r\n  INTO v_schedule_date, v_start_hour, v_start_minute, v_end_hour, v_end_minute\r\n  FROM jsonb_array_elements(p_schedules) AS schedule\r\n  ORDER BY (schedule->>'date')::DATE DESC\r\n  LIMIT 1;\r\n\r\n  -- Handle case where end time is before start time (next day)\r\n  IF (v_end_hour * 60 + v_end_minute) <= (v_start_hour * 60 + v_start_minute) THEN\r\n    v_last_schedule_end := ((v_schedule_date + INTERVAL '1 day') || ' ' ||\r\n      LPAD(v_end_hour::TEXT, 2, '0') || ':' ||\r\n      LPAD(v_end_minute::TEXT, 2, '0') || ':00')::TIMESTAMP;\r\n  ELSE\r\n    v_last_schedule_end := (v_schedule_date || ' ' ||\r\n      LPAD(v_end_hour::TEXT, 2, '0') || ':' ||\r\n      LPAD(v_end_minute::TEXT, 2, '0') || ':00')::TIMESTAMP;\r\n  END IF;\r\n\r\n  -- Insert the mission\r\n  INSERT INTO missions.missions (\r\n    company_id,\r\n    title,\r\n    description,\r\n    location,\r\n    postal_code,\r\n    city,\r\n    latitude,\r\n    longitude,\r\n    start_time,\r\n    end_time,\r\n    start_date,\r\n    end_date,\r\n    is_multi_day,\r\n    job,\r\n    benevole,\r\n    requires_mobility,\r\n    items_to_bring,\r\n    nb_participants,\r\n    avantages,\r\n    status,\r\n    is_paid\r\n  ) VALUES (\r\n    p_company_id,\r\n    p_title,\r\n    p_description,\r\n    p_location,\r\n    p_postal_code,\r\n    p_city,\r\n    p_latitude,\r\n    p_longitude,\r\n    v_first_schedule_start,\r\n    v_last_schedule_end,\r\n    v_start_date,\r\n    v_end_date,\r\n    v_schedule_count > 1,\r\n    p_job,\r\n    p_benevole,\r\n    p_requires_mobility,\r\n    p_items_to_bring,\r\n    p_nb_participants,\r\n    p_avantages,\r\n    'open',\r\n    false\r\n  )\r\n  RETURNING id INTO v_mission_id;\r\n\r\n  -- Insert all schedules\r\n  FOR v_schedule IN SELECT * FROM jsonb_array_elements(p_schedules)\r\n  LOOP\r\n    v_schedule_date := (v_schedule->>'date')::DATE;\r\n    v_start_hour := (v_schedule->>'start_hour')::INTEGER;\r\n    v_start_minute := (v_schedule->>'start_minute')::INTEGER;\r\n    v_end_hour := (v_schedule->>'end_hour')::INTEGER;\r\n    v_end_minute := (v_schedule->>'end_minute')::INTEGER;\r\n\r\n    v_start_time := (LPAD(v_start_hour::TEXT, 2, '0') || ':' || LPAD(v_start_minute::TEXT, 2, '0') || ':00')::TIME;\r\n    v_end_time := (LPAD(v_end_hour::TEXT, 2, '0') || ':' || LPAD(v_end_minute::TEXT, 2, '0') || ':00')::TIME;\r\n\r\n    INSERT INTO missions.mission_schedules (\r\n      mission_id,\r\n      schedule_date,\r\n      start_time,\r\n      end_time\r\n    ) VALUES (\r\n      v_mission_id,\r\n      v_schedule_date,\r\n      v_start_time,\r\n      v_end_time\r\n    );\r\n  END LOOP;\r\n\r\n  RETURN v_mission_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_sourced_application",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_sourced_application(p_mission_id uuid, p_profile_id uuid, p_provider_id uuid, p_price_hour numeric, p_price_hour_supp numeric)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_company_id UUID;\r\n  v_mission_job INTEGER;\r\n  v_existing_accepted BOOLEAN;\r\n  v_existing_application BOOLEAN;\r\n  v_job_match BOOLEAN;\r\n  v_new_pm_id UUID;\r\n  v_can_create_new_mission BOOLEAN;\r\nBEGIN\r\n  SELECT m.company_id, m.job INTO v_company_id, v_mission_job\r\n  FROM missions.missions m\r\n  JOIN companies.companies c ON c.id = m.company_id\r\n  WHERE m.id = p_mission_id AND c.profile = auth.uid();\r\n\r\n  IF v_company_id IS NULL THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Mission non trouvee ou non autorisee');\r\n  END IF;\r\n\r\n  v_can_create_new_mission := providers.can_provider_create_new_mission(p_profile_id);\r\n  IF NOT v_can_create_new_mission THEN\r\n    RETURN jsonb_build_object(\r\n      'success', false,\r\n      'error', 'Le prestataire doit fournir des documents legaux valides pour continuer'\r\n    );\r\n  END IF;\r\n\r\n  SELECT EXISTS(\r\n    SELECT 1 FROM missions.profile_missions\r\n    WHERE mission = p_mission_id AND state = 'accepted'\r\n  ) INTO v_existing_accepted;\r\n\r\n  IF v_existing_accepted THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Cette mission a deja un candidat accepte');\r\n  END IF;\r\n\r\n  SELECT EXISTS(\r\n    SELECT 1 FROM providers.provider_jobs pj\r\n    WHERE pj.provider = p_provider_id AND pj.job = v_mission_job\r\n  ) INTO v_job_match;\r\n\r\n  IF NOT v_job_match THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Le prestataire ne possede pas le metier requis pour cette mission');\r\n  END IF;\r\n\r\n  SELECT EXISTS(\r\n    SELECT 1 FROM missions.profile_missions\r\n    WHERE mission = p_mission_id AND profile = p_profile_id\r\n  ) INTO v_existing_application;\r\n\r\n  IF v_existing_application THEN\r\n    RETURN jsonb_build_object('success', false, 'error', 'Une candidature existe deja pour ce prestataire sur cette mission');\r\n  END IF;\r\n\r\n  INSERT INTO missions.profile_missions (\r\n    mission, profile, provider, state, origin, price_hour, price_hour_supp\r\n  ) VALUES (\r\n    p_mission_id, p_profile_id, p_provider_id, 'accepted', 'sourced', p_price_hour, p_price_hour_supp\r\n  ) RETURNING id INTO v_new_pm_id;\r\n\r\n  RETURN jsonb_build_object('success', true, 'profile_mission_id', v_new_pm_id);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "create_sourced_application_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.create_sourced_application_v2(p_mission_id uuid, p_profile_id uuid, p_provider_id uuid, p_price_hour numeric, p_price_hour_supp numeric)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_company_id UUID;\r\n    v_mission_job INTEGER;\r\n    v_existing_blocking BOOLEAN;\r\n    v_existing_application BOOLEAN;\r\n    v_job_match BOOLEAN;\r\n    v_new_pm_id UUID;\r\n    v_is_volunteer_multi BOOLEAN;\r\n    v_nb_participants INTEGER;\r\n    v_slots_occupied INTEGER;\r\n    v_can_create_new_mission BOOLEAN;\r\nBEGIN\r\n    SELECT\r\n        m.company_id,\r\n        m.job,\r\n        (m.benevole = true AND COALESCE(m.nb_participants, 1) > 1),\r\n        COALESCE(m.nb_participants, 1)\r\n    INTO\r\n        v_company_id,\r\n        v_mission_job,\r\n        v_is_volunteer_multi,\r\n        v_nb_participants\r\n    FROM missions.missions m\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE m.id = p_mission_id\r\n      AND c.profile = auth.uid();\r\n\r\n    IF v_company_id IS NULL THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Mission non trouvee ou non autorisee');\r\n    END IF;\r\n\r\n    v_can_create_new_mission := providers.can_provider_create_new_mission(p_profile_id);\r\n    IF NOT v_can_create_new_mission THEN\r\n        RETURN jsonb_build_object(\r\n          'success', false,\r\n          'error', 'Le prestataire doit fournir des documents legaux valides pour continuer'\r\n        );\r\n    END IF;\r\n\r\n    IF v_is_volunteer_multi THEN\r\n        SELECT COUNT(*)\r\n        INTO v_slots_occupied\r\n        FROM missions.profile_missions pm\r\n        WHERE pm.mission = p_mission_id\r\n          AND pm.state IN ('confirmed', 'employer_signed', 'assigned', 'completed');\r\n\r\n        IF v_slots_occupied >= v_nb_participants THEN\r\n            RETURN jsonb_build_object('success', false, 'error', 'Tous les slots benevoles sont deja occupes');\r\n        END IF;\r\n    ELSE\r\n        SELECT EXISTS(\r\n            SELECT 1\r\n            FROM missions.profile_missions\r\n            WHERE mission = p_mission_id\r\n              AND state IN ('accepted', 'confirmed', 'employer_signed', 'assigned', 'completed')\r\n        ) INTO v_existing_blocking;\r\n\r\n        IF v_existing_blocking THEN\r\n            RETURN jsonb_build_object('success', false, 'error', 'Cette mission a deja un candidat accepte');\r\n        END IF;\r\n    END IF;\r\n\r\n    SELECT EXISTS(\r\n        SELECT 1\r\n        FROM providers.provider_jobs pj\r\n        WHERE pj.provider = p_provider_id\r\n          AND pj.job = v_mission_job\r\n    ) INTO v_job_match;\r\n\r\n    IF NOT v_job_match THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Le prestataire ne possede pas le metier requis pour cette mission');\r\n    END IF;\r\n\r\n    SELECT EXISTS(\r\n        SELECT 1\r\n        FROM missions.profile_missions\r\n        WHERE mission = p_mission_id\r\n          AND profile = p_profile_id\r\n    ) INTO v_existing_application;\r\n\r\n    IF v_existing_application THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Une candidature existe deja pour ce prestataire sur cette mission');\r\n    END IF;\r\n\r\n    INSERT INTO missions.profile_missions (\r\n        mission,\r\n        profile,\r\n        provider,\r\n        state,\r\n        origin,\r\n        price_hour,\r\n        price_hour_supp\r\n    ) VALUES (\r\n        p_mission_id,\r\n        p_profile_id,\r\n        p_provider_id,\r\n        'accepted',\r\n        'sourced',\r\n        p_price_hour,\r\n        p_price_hour_supp\r\n    )\r\n    RETURNING id INTO v_new_pm_id;\r\n\r\n    RETURN jsonb_build_object('success', true, 'profile_mission_id', v_new_pm_id);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "delete_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.delete_mission(p_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_company_id uuid;\r\n  v_user_company_id uuid;\r\n  v_mission_status text;\r\n  v_has_signed_contracts boolean;\r\nBEGIN\r\n  -- Vérifier que la mission existe et récupérer ses infos\r\n  SELECT company_id, status \r\n  INTO v_company_id, v_mission_status\r\n  FROM missions.missions \r\n  WHERE id = p_mission_id;\r\n\r\n  IF v_company_id IS NULL THEN\r\n    RETURN json_build_object(\r\n      'success', false,\r\n      'error', 'Mission non trouvée'\r\n    );\r\n  END IF;\r\n\r\n  -- Récupérer l'ID de la company de l'utilisateur connecté\r\n  SELECT c.id INTO v_user_company_id\r\n  FROM companies.companies c\r\n  WHERE c.profile = auth.uid();\r\n\r\n  -- Vérifier que l'utilisateur est bien le propriétaire de la mission\r\n  IF v_company_id != v_user_company_id THEN\r\n    RETURN json_build_object(\r\n      'success', false,\r\n      'error', 'Vous n''êtes pas autorisé à supprimer cette mission'\r\n    );\r\n  END IF;\r\n\r\n  -- Vérifier s'il y a des contrats signés (par company OU provider)\r\n  SELECT EXISTS (\r\n    SELECT 1 \r\n    FROM missions.contrats ct\r\n    JOIN missions.profile_missions pm ON pm.id = ct.profile_mission\r\n    WHERE pm.mission = p_mission_id\r\n    AND (ct.company_signed_at IS NOT NULL OR ct.provider_signed_at IS NOT NULL)\r\n  ) INTO v_has_signed_contracts;\r\n\r\n  IF v_has_signed_contracts THEN\r\n    RETURN json_build_object(\r\n      'success', false,\r\n      'error', 'Impossible de supprimer une mission avec des contrats signés'\r\n    );\r\n  END IF;\r\n\r\n  -- Vérifier que la mission n'est pas en cours ou terminée\r\n  IF v_mission_status IN ('assigned', 'completed', 'in_progress') THEN\r\n    RETURN json_build_object(\r\n      'success', false,\r\n      'error', 'Impossible de supprimer une mission ' || \r\n        CASE v_mission_status\r\n          WHEN 'assigned' THEN 'assignée'\r\n          WHEN 'completed' THEN 'terminée'\r\n          WHEN 'in_progress' THEN 'en cours'\r\n        END\r\n    );\r\n  END IF;\r\n\r\n  -- Supprimer les contrats liés (non signés)\r\n  DELETE FROM missions.contrats\r\n  WHERE profile_mission IN (\r\n    SELECT id FROM missions.profile_missions WHERE mission = p_mission_id\r\n  );\r\n\r\n  -- Supprimer les candidatures (profile_missions)\r\n  DELETE FROM missions.profile_missions\r\n  WHERE mission = p_mission_id;\r\n\r\n  -- Supprimer les ratings liés à cette mission (companies.ratings)\r\n  DELETE FROM companies.ratings\r\n  WHERE mission_id = p_mission_id;\r\n\r\n  -- Supprimer les ratings liés à cette mission (providers.ratings)\r\n  DELETE FROM providers.ratings\r\n  WHERE mission = p_mission_id;\r\n\r\n  -- Supprimer la mission\r\n  DELETE FROM missions.missions\r\n  WHERE id = p_mission_id;\r\n\r\n  RETURN json_build_object(\r\n    'success', true,\r\n    'message', 'Mission supprimée avec succès'\r\n  );\r\n\r\nEXCEPTION\r\n  WHEN OTHERS THEN\r\n    RETURN json_build_object(\r\n      'success', false,\r\n      'error', 'Erreur lors de la suppression: ' || SQLERRM\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "expire_signature",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.expire_signature(p_profile_mission_id uuid, p_reason text DEFAULT 'Provider did not sign before deadline'::text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_pm RECORD;\r\n    v_provider_id UUID;\r\nBEGIN\r\n    -- Get profile_mission\r\n    SELECT pm.*, prov.id as real_provider_id\r\n    INTO v_pm\r\n    FROM missions.profile_missions pm\r\n    LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_pm IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    -- Check state is employer_signed\r\n    IF v_pm.state != 'employer_signed' THEN\r\n        RETURN json_build_object('success', false, 'error', 'Invalid state: ' || v_pm.state);\r\n    END IF;\r\n\r\n    -- Update profile_mission state to signature_expired\r\n    UPDATE missions.profile_missions\r\n    SET\r\n        state = 'signature_expired',\r\n        payment_status = 'canceled',\r\n        canceled_at = NOW(),\r\n        canceled_by = 'system',\r\n        cancellation_reason = p_reason\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    -- Log the cancellation/sanction\r\n    INSERT INTO providers.cancellation_logs (\r\n        provider,\r\n        mission,\r\n        profile_mission,\r\n        event_type,\r\n        event_description,\r\n        penalty_applied,\r\n        created_at\r\n    ) VALUES (\r\n        v_pm.real_provider_id,\r\n        v_pm.mission,\r\n        p_profile_mission_id,\r\n        'signature_expired',\r\n        'Provider did not sign contract before deadline',\r\n        'warning',\r\n        NOW()\r\n    );\r\n\r\n    -- Return mission to open status if no other assigned provider\r\n    -- (This allows the company to select another provider)\r\n    UPDATE missions.missions\r\n    SET status = 'open'\r\n    WHERE id = v_pm.mission\r\n      AND NOT EXISTS (\r\n          SELECT 1 FROM missions.profile_missions pm2\r\n          WHERE pm2.mission = v_pm.mission\r\n            AND pm2.state IN ('assigned', 'completed')\r\n            AND pm2.id != p_profile_mission_id\r\n      );\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'profile_mission_id', p_profile_mission_id,\r\n        'provider_id', v_pm.real_provider_id,\r\n        'mission_id', v_pm.mission\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_assigned_provider_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_assigned_provider_v2(p_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_result json;\r\nBEGIN\r\n  SELECT json_build_object(\r\n    'id', pm.provider,\r\n    'profile_id', pm.profile,\r\n    'profile_mission_id', pm.id,\r\n    'first_name_enc', p.first_name_enc,\r\n    'last_name_enc', p.last_name_enc,\r\n    'photo', p.photo,\r\n    'price_hour', pm.price_hour,\r\n    'state', pm.state\r\n  ) INTO v_result\r\n  FROM missions.profile_missions pm\r\n  JOIN public.profiles p ON p.id = pm.profile\r\n  WHERE pm.mission = p_mission_id\r\n    AND pm.state IN ('assigned', 'accepted')\r\n  LIMIT 1;\r\n\r\n  RETURN v_result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_company_contracts_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_company_contracts_v2(p_profile_id uuid, p_company_id uuid)\n RETURNS TABLE(contract_id uuid, contract_status text, contract_created_at timestamp with time zone, contract_provider_signed_at timestamp with time zone, contract_company_signed_at timestamp with time zone, profile_mission_id uuid, mission_id uuid, mission_title text, mission_job character varying, mission_start_time timestamp without time zone, mission_end_time timestamp without time zone, provider_id uuid, provider_first_name_enc text, provider_last_name_enc text, company_name text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  IF p_profile_id != auth.uid() THEN\r\n    RAISE EXCEPTION 'Not authorized';\r\n  END IF;\r\n\r\n  IF NOT EXISTS (\r\n    SELECT 1 FROM companies.companies\r\n    WHERE id = p_company_id AND profile = p_profile_id\r\n  ) THEN\r\n    RAISE EXCEPTION 'Company does not belong to this user';\r\n  END IF;\r\n\r\n  RETURN QUERY\r\n  SELECT\r\n    c.id AS contract_id,\r\n    c.status AS contract_status,\r\n    c.created_at AS contract_created_at,\r\n    c.provider_signed_at AS contract_provider_signed_at,\r\n    c.company_signed_at AS contract_company_signed_at,\r\n    pm.id AS profile_mission_id,\r\n    m.id AS mission_id,\r\n    m.title AS mission_title,\r\n    j.name AS mission_job,\r\n    m.start_time AS mission_start_time,\r\n    m.end_time AS mission_end_time,\r\n    p.id AS provider_id,\r\n    p.first_name_enc AS provider_first_name_enc,\r\n    p.last_name_enc AS provider_last_name_enc,\r\n    co.nom_commercial AS company_name\r\n  FROM missions.contrats c\r\n    INNER JOIN missions.profile_missions pm ON pm.id = c.profile_mission\r\n    INNER JOIN missions.missions m ON m.id = pm.mission\r\n    INNER JOIN public.profiles p ON p.id = pm.profile\r\n    INNER JOIN companies.companies co ON co.id = m.company_id\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n  WHERE m.company_id = p_company_id\r\n    AND c.provider_signed_at IS NOT NULL\r\n  ORDER BY c.created_at DESC;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_company_for_messaging",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_company_for_messaging(p_company_id uuid)\n RETURNS TABLE(id uuid, nom_commercial text, verified boolean, photo uuid)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    c.id,\r\n    c.nom_commercial,\r\n    c.verified,\r\n    (SELECT p.photo FROM public.profiles p WHERE p.id = c.profile) as photo\r\n  FROM companies.companies c\r\n  WHERE c.id = p_company_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_company_profile_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_company_profile_v2(p_company_id uuid)\n RETURNS TABLE(id uuid, nom_commercial text, description text, verified boolean, employee_count text, code_ape text, logo uuid)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    c.id,\r\n    c.nom_commercial,\r\n    c.description,\r\n    c.verified,\r\n    c.employee_count,\r\n    c.code_ape,\r\n    (SELECT p.photo FROM public.profiles p WHERE p.id = c.profile) as logo\r\n  FROM companies.companies c\r\n  WHERE c.id = p_company_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contract_for_company_by_pm_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contract_for_company_by_pm_v2(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    result JSON;\r\n    v_company_owner UUID;\r\n    v_mission_id UUID;\r\n    v_schedules JSON;\r\nBEGIN\r\n    SELECT c.profile, m.id\r\n    INTO v_company_owner, v_mission_id\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_company_owner IS NULL THEN\r\n        RETURN json_build_object('error', 'Not found');\r\n    END IF;\r\n\r\n    IF v_company_owner <> auth.uid() THEN\r\n        RETURN json_build_object('error', 'Not authorized');\r\n    END IF;\r\n\r\n    SELECT COALESCE(\r\n        json_agg(\r\n            json_build_object(\r\n                'schedule_date', ms.schedule_date,\r\n                'start_time', ms.start_time,\r\n                'end_time', ms.end_time\r\n            ) ORDER BY ms.schedule_date ASC\r\n        ),\r\n        '[]'::json\r\n    )\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission_id;\r\n\r\n    SELECT json_build_object(\r\n        'contrat', CASE WHEN co.id IS NOT NULL THEN json_build_object(\r\n            'id', co.id,\r\n            'status', co.status,\r\n            'provider_signed_at', co.provider_signed_at,\r\n            'company_signed_at', co.company_signed_at,\r\n            'created_at', co.created_at,\r\n            'profile_mission_id', pm.id\r\n        ) ELSE NULL END,\r\n        'mission', json_build_object(\r\n            'id', m.id,\r\n            'title', m.title,\r\n            'description', m.description,\r\n            'location', m.location,\r\n            'city', m.city,\r\n            'postal_code', m.postal_code,\r\n            'start_time', m.start_time,\r\n            'end_time', m.end_time,\r\n            'start_date', m.start_date,\r\n            'end_date', m.end_date,\r\n            'is_multi_day', COALESCE(m.is_multi_day, false),\r\n            'schedules', v_schedules,\r\n            'job_name', j.name,\r\n            'benevole', m.benevole,\r\n            'salary', m.salary,\r\n            'nb_participants', m.nb_participants,\r\n            'avantages', m.avantages,\r\n            'items_to_bring', m.items_to_bring\r\n        ),\r\n        'provider', json_build_object(\r\n            'profile_mission_id', pm.id,\r\n            'profile_id', pm.profile,\r\n            'provider_id', pm.provider,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc,\r\n            'photo', p.photo,\r\n            'price_hour', pm.price_hour,\r\n            'price_hour_supp', pm.price_hour_supp,\r\n            'stripe_id', prov.stripe_id_enc,\r\n            'regime_tva', prov.regime_tva,\r\n            'state', pm.state\r\n        ),\r\n        'company', json_build_object(\r\n            'id', c.id,\r\n            'nom_commercial', c.nom_commercial,\r\n            'siret', NULL,\r\n            'profile_id', c.profile,\r\n            'photo', cp.photo,\r\n            'first_name_enc', cp.first_name_enc,\r\n            'last_name_enc', cp.last_name_enc\r\n        )\r\n    )\r\n    INTO result\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    JOIN public.profiles cp ON cp.id = c.profile\r\n    JOIN public.profiles p ON p.id = pm.profile\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n    LEFT JOIN missions.contrats co ON co.profile_mission = pm.id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contract_for_company_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contract_for_company_v2(p_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result JSON;\r\n  v_company_id UUID;\r\n  v_schedules JSON;\r\nBEGIN\r\n  -- Verify user is the company owner\r\n  SELECT c.id INTO v_company_id\r\n  FROM missions.missions m\r\n  JOIN companies.companies c ON c.id = m.company_id\r\n  WHERE m.id = p_mission_id\r\n  AND c.profile = auth.uid();\r\n\r\n  IF v_company_id IS NULL THEN\r\n    RETURN json_build_object('error', 'Not authorized');\r\n  END IF;\r\n\r\n  -- Fetch schedules for this mission\r\n  SELECT COALESCE(json_agg(\r\n    json_build_object(\r\n      'schedule_date', ms.schedule_date,\r\n      'start_time', ms.start_time,\r\n      'end_time', ms.end_time\r\n    ) ORDER BY ms.schedule_date ASC\r\n  ), '[]'::json)\r\n  INTO v_schedules\r\n  FROM missions.mission_schedules ms\r\n  WHERE ms.mission_id = p_mission_id;\r\n\r\n  SELECT json_build_object(\r\n    'contrat', CASE WHEN co.id IS NOT NULL THEN json_build_object(\r\n      'id', co.id,\r\n      'status', co.status,\r\n      'provider_signed_at', co.provider_signed_at,\r\n      'company_signed_at', co.company_signed_at,\r\n      'created_at', co.created_at,\r\n      'profile_mission_id', pm.id\r\n    ) ELSE NULL END,\r\n    'mission', json_build_object(\r\n      'id', m.id,\r\n      'title', m.title,\r\n      'description', m.description,\r\n      'location', m.location,\r\n      'city', m.city,\r\n      'postal_code', m.postal_code,\r\n      'start_time', m.start_time,\r\n      'end_time', m.end_time,\r\n      'start_date', m.start_date,\r\n      'end_date', m.end_date,\r\n      'is_multi_day', COALESCE(m.is_multi_day, false),\r\n      'schedules', v_schedules,\r\n      'job_name', j.name,\r\n      'benevole', m.benevole,\r\n      'salary', m.salary\r\n    ),\r\n    'provider', CASE WHEN pm.id IS NOT NULL THEN json_build_object(\r\n      'profile_mission_id', pm.id,\r\n      'profile_id', pm.profile,\r\n      'provider_id', pm.provider,\r\n      'first_name', p.first_name,\r\n      'last_name', p.last_name,\r\n      'photo', p.photo,\r\n      'price_hour', pm.price_hour,\r\n      'price_hour_supp', pm.price_hour_supp,\r\n      'stripe_id', prov.stripe_id,\r\n      'regime_tva', prov.regime_tva\r\n    ) ELSE NULL END,\r\n    'company', json_build_object(\r\n      'id', c.id,\r\n      'nom_commercial', c.nom_commercial,\r\n      'siret', NULL,\r\n      'profile_id', c.profile,\r\n      'photo', cp.photo,\r\n      'first_name', cp.first_name,\r\n      'last_name', cp.last_name\r\n    )\r\n  ) INTO result\r\n  FROM missions.missions m\r\n  JOIN companies.companies c ON c.id = m.company_id\r\n  JOIN public.profiles cp ON cp.id = c.profile\r\n  LEFT JOIN jobs.jobs j ON j.id = m.job\r\n  LEFT JOIN missions.profile_missions pm ON pm.mission = m.id AND pm.state IN ('confirmed', 'employer_signed', 'assigned')\r\n  LEFT JOIN public.profiles p ON p.id = pm.profile\r\n  LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n  LEFT JOIN missions.contrats co ON co.profile_mission = pm.id\r\n  WHERE m.id = p_mission_id;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contract_for_company_v4",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contract_for_company_v4(p_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    result JSON;\r\n    v_company_id UUID;\r\n    v_schedules JSON;\r\nBEGIN\r\n    SELECT c.id INTO v_company_id\r\n    FROM missions.missions m\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE m.id = p_mission_id\r\n      AND c.profile = auth.uid();\r\n\r\n    IF v_company_id IS NULL THEN\r\n        RETURN json_build_object('error', 'Not authorized');\r\n    END IF;\r\n\r\n    SELECT COALESCE(json_agg(\r\n        json_build_object(\r\n            'schedule_date', ms.schedule_date,\r\n            'start_time', ms.start_time,\r\n            'end_time', ms.end_time\r\n        ) ORDER BY ms.schedule_date ASC\r\n    ), '[]'::json)\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = p_mission_id;\r\n\r\n    SELECT json_build_object(\r\n        'contrat', CASE WHEN co.id IS NOT NULL THEN json_build_object(\r\n            'id', co.id,\r\n            'status', co.status,\r\n            'provider_signed_at', co.provider_signed_at,\r\n            'company_signed_at', co.company_signed_at,\r\n            'created_at', co.created_at,\r\n            'profile_mission_id', pm.id\r\n        ) ELSE NULL END,\r\n        'mission', json_build_object(\r\n            'id', m.id,\r\n            'title', m.title,\r\n            'description', m.description,\r\n            'location', m.location,\r\n            'city', m.city,\r\n            'postal_code', m.postal_code,\r\n            'start_time', m.start_time,\r\n            'end_time', m.end_time,\r\n            'start_date', m.start_date,\r\n            'end_date', m.end_date,\r\n            'is_multi_day', COALESCE(m.is_multi_day, false),\r\n            'schedules', v_schedules,\r\n            'job_name', j.name,\r\n            'benevole', m.benevole,\r\n            'salary', m.salary\r\n        ),\r\n        'provider', CASE WHEN pm.id IS NOT NULL THEN json_build_object(\r\n            'profile_mission_id', pm.id,\r\n            'profile_id', pm.profile,\r\n            'provider_id', pm.provider,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc,\r\n            'photo', p.photo,\r\n            'price_hour', pm.price_hour,\r\n            'price_hour_supp', pm.price_hour_supp,\r\n            'stripe_id', prov.stripe_id_enc,\r\n            'regime_tva', prov.regime_tva\r\n        ) ELSE NULL END,\r\n        'company', json_build_object(\r\n            'id', c.id,\r\n            'nom_commercial', c.nom_commercial,\r\n            'siret', NULL,\r\n            'profile_id', c.profile,\r\n            'photo', cp.photo,\r\n            'first_name_enc', cp.first_name_enc,\r\n            'last_name_enc', cp.last_name_enc\r\n        )\r\n    ) INTO result\r\n    FROM missions.missions m\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    JOIN public.profiles cp ON cp.id = c.profile\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    LEFT JOIN missions.profile_missions pm ON pm.mission = m.id AND pm.state IN ('confirmed', 'employer_signed', 'assigned')\r\n    LEFT JOIN public.profiles p ON p.id = pm.profile\r\n    LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n    LEFT JOIN missions.contrats co ON co.profile_mission = pm.id\r\n    WHERE m.id = p_mission_id;\r\n\r\n    RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contract_for_provider_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contract_for_provider_v2(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result JSON;\r\n  v_profile_id UUID;\r\n  v_mission_id UUID;\r\n  v_schedules JSON;\r\nBEGIN\r\n  -- Verify user is the provider\r\n  SELECT pm.profile, pm.mission INTO v_profile_id, v_mission_id\r\n  FROM missions.profile_missions pm\r\n  WHERE pm.id = p_profile_mission_id\r\n  AND pm.profile = auth.uid();\r\n\r\n  IF v_profile_id IS NULL THEN\r\n    RETURN json_build_object('error', 'Not authorized');\r\n  END IF;\r\n\r\n  -- Fetch schedules for this mission\r\n  SELECT COALESCE(json_agg(\r\n    json_build_object(\r\n      'schedule_date', ms.schedule_date,\r\n      'start_time', ms.start_time,\r\n      'end_time', ms.end_time\r\n    ) ORDER BY ms.schedule_date ASC\r\n  ), '[]'::json)\r\n  INTO v_schedules\r\n  FROM missions.mission_schedules ms\r\n  WHERE ms.mission_id = v_mission_id;\r\n\r\n  SELECT json_build_object(\r\n    'contrat', CASE WHEN co.id IS NOT NULL THEN json_build_object(\r\n      'id', co.id,\r\n      'status', co.status,\r\n      'provider_signed_at', co.provider_signed_at,\r\n      'company_signed_at', co.company_signed_at,\r\n      'created_at', co.created_at\r\n    ) ELSE NULL END,\r\n    'mission', json_build_object(\r\n      'id', m.id,\r\n      'title', m.title,\r\n      'description', m.description,\r\n      'location', m.location,\r\n      'city', m.city,\r\n      'postal_code', m.postal_code,\r\n      'start_time', m.start_time,\r\n      'end_time', m.end_time,\r\n      'start_date', m.start_date,\r\n      'end_date', m.end_date,\r\n      'is_multi_day', COALESCE(m.is_multi_day, false),\r\n      'schedules', v_schedules,\r\n      'job_name', j.name\r\n    ),\r\n    'provider', json_build_object(\r\n      'profile_mission_id', pm.id,\r\n      'profile_id', pm.profile,\r\n      'provider_id', pm.provider,\r\n      'first_name', p.first_name,\r\n      'last_name', p.last_name,\r\n      'photo', p.photo,\r\n      'price_hour', pm.price_hour,\r\n      'price_hour_supp', pm.price_hour_supp,\r\n      'regime_tva', prov.regime_tva\r\n    ),\r\n    'company', json_build_object(\r\n      'id', c.id,\r\n      'name', c.nom_commercial,\r\n      'siret', NULL,\r\n      'profile_id', c.profile,\r\n      'photo', cp.photo,\r\n      'first_name', cp.first_name,\r\n      'last_name', cp.last_name\r\n    )\r\n  ) INTO result\r\n  FROM missions.profile_missions pm\r\n  JOIN missions.missions m ON m.id = pm.mission\r\n  JOIN companies.companies c ON c.id = m.company_id\r\n  JOIN public.profiles cp ON cp.id = c.profile\r\n  JOIN public.profiles p ON p.id = pm.profile\r\n  LEFT JOIN jobs.jobs j ON j.id = m.job\r\n  LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n  LEFT JOIN missions.contrats co ON co.profile_mission = pm.id\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contract_for_provider_v4",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contract_for_provider_v4(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    result JSON;\r\n    v_profile_id UUID;\r\n    v_mission_id UUID;\r\n    v_schedules JSON;\r\nBEGIN\r\n    SELECT pm.profile, pm.mission INTO v_profile_id, v_mission_id\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.id = p_profile_mission_id\r\n      AND pm.profile = auth.uid();\r\n\r\n    IF v_profile_id IS NULL THEN\r\n        RETURN json_build_object('error', 'Not authorized');\r\n    END IF;\r\n\r\n    SELECT COALESCE(json_agg(\r\n        json_build_object(\r\n            'schedule_date', ms.schedule_date,\r\n            'start_time', ms.start_time,\r\n            'end_time', ms.end_time\r\n        ) ORDER BY ms.schedule_date ASC\r\n    ), '[]'::json)\r\n    INTO v_schedules\r\n    FROM missions.mission_schedules ms\r\n    WHERE ms.mission_id = v_mission_id;\r\n\r\n    SELECT json_build_object(\r\n        'contrat', CASE WHEN co.id IS NOT NULL THEN json_build_object(\r\n            'id', co.id,\r\n            'status', co.status,\r\n            'provider_signed_at', co.provider_signed_at,\r\n            'company_signed_at', co.company_signed_at,\r\n            'created_at', co.created_at\r\n        ) ELSE NULL END,\r\n        'mission', json_build_object(\r\n            'id', m.id,\r\n            'title', m.title,\r\n            'description', m.description,\r\n            'location', m.location,\r\n            'city', m.city,\r\n            'postal_code', m.postal_code,\r\n            'start_time', m.start_time,\r\n            'end_time', m.end_time,\r\n            'start_date', m.start_date,\r\n            'end_date', m.end_date,\r\n            'is_multi_day', COALESCE(m.is_multi_day, false),\r\n            'schedules', v_schedules,\r\n            'job_name', j.name\r\n        ),\r\n        'provider', json_build_object(\r\n            'profile_mission_id', pm.id,\r\n            'profile_id', pm.profile,\r\n            'provider_id', pm.provider,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc,\r\n            'photo', p.photo,\r\n            'price_hour', pm.price_hour,\r\n            'price_hour_supp', pm.price_hour_supp,\r\n            'regime_tva', prov.regime_tva\r\n        ),\r\n        'company', json_build_object(\r\n            'id', c.id,\r\n            'name', c.nom_commercial,\r\n            'siret', NULL,\r\n            'profile_id', c.profile,\r\n            'photo', cp.photo,\r\n            'first_name_enc', cp.first_name_enc,\r\n            'last_name_enc', cp.last_name_enc\r\n        )\r\n    ) INTO result\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    JOIN public.profiles cp ON cp.id = c.profile\r\n    JOIN public.profiles p ON p.id = pm.profile\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n    LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n    LEFT JOIN missions.contrats co ON co.profile_mission = pm.id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contracts_for_company",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contracts_for_company(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        c.id,\r\n        c.status,\r\n        c.company_signed_at,\r\n        c.profile_mission,\r\n        pm.mission as mission_id\r\n      FROM missions.contrats c\r\n      JOIN missions.profile_missions pm ON pm.id = c.profile_mission\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      WHERE m.company_id = p_company_id\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_contracts_needing_deadline_reminder",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_contracts_needing_deadline_reminder()\n RETURNS TABLE(profile_mission_id uuid, provider_profile_id uuid, mission_title text, company_name text, deadline timestamp with time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT\r\n        pm.id as profile_mission_id,\r\n        pm.profile as provider_profile_id,\r\n        m.title as mission_title,\r\n        c.nom_commercial as company_name,\r\n        pm.provider_signature_deadline as deadline\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.state = 'employer_signed'\r\n      AND pm.provider_signature_deadline IS NOT NULL\r\n      AND pm.deadline_reminder_sent = FALSE\r\n      AND pm.provider_signature_deadline > NOW()\r\n      AND pm.provider_signature_deadline <= NOW() + INTERVAL '1 hour 15 minutes';\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_dispute_for_mission_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_dispute_for_mission_v2(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_profile_mission RECORD;\r\nBEGIN\r\n    SELECT\r\n        pm.*,\r\n        c.profile as company_profile\r\n    INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    IF v_profile_mission.company_profile IS DISTINCT FROM auth.uid() AND v_profile_mission.profile IS DISTINCT FROM auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized');\r\n    END IF;\r\n\r\n    RETURN COALESCE((\r\n        SELECT json_agg(row_to_json(t))\r\n        FROM (\r\n            SELECT\r\n                d.*,\r\n                p.first_name_enc as opened_by_first_name_enc,\r\n                p.last_name_enc as opened_by_last_name_enc\r\n            FROM missions.disputes d\r\n            JOIN public.profiles p ON p.id = d.opened_by_profile\r\n            WHERE d.profile_mission = p_profile_mission_id\r\n            ORDER BY d.created_at DESC\r\n        ) t\r\n    ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_expired_signature_deadlines",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_expired_signature_deadlines()\n RETURNS TABLE(profile_mission_id uuid, payment_intent_id text, provider_profile_id uuid, company_profile_id uuid, mission_id uuid, mission_title text, company_name text, deadline timestamp with time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    RETURN QUERY\r\n    SELECT\r\n        pm.id as profile_mission_id,\r\n        pm.payment_intent_id,\r\n        pm.profile as provider_profile_id,\r\n        c.profile as company_profile_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        c.nom_commercial as company_name,\r\n        pm.provider_signature_deadline as deadline\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.state = 'employer_signed'\r\n      AND pm.provider_signature_deadline IS NOT NULL\r\n      AND pm.provider_signature_deadline < NOW();\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_finalized_contract_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_finalized_contract_missions(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_date,\r\n        pm.provider as provider_id,\r\n        pm.profile as provider_profile_id,\r\n        p.first_name as provider_first_name,\r\n        p.photo as provider_photo,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as provider_job_name,\r\n        c.provider_signed_at,\r\n        c.company_signed_at\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN public.profiles p ON p.id = pm.profile\r\n      JOIN missions.contrats c ON c.profile_mission = pm.id\r\n      WHERE m.company_id = p_company_id\r\n        AND c.status = 'signed'  -- Contract is fully signed (source of truth)\r\n        AND c.provider_signed_at IS NOT NULL\r\n        AND c.company_signed_at IS NOT NULL\r\n        AND (pm.popup_contract_finalized_seen = false OR pm.popup_contract_finalized_seen IS NULL)\r\n      ORDER BY c.provider_signed_at DESC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_finished_missions_popup",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_finished_missions_popup(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_start_time,\r\n        m.end_time as mission_end_time,\r\n        m.end_time as mission_end_date,\r\n        m.benevole as mission_benevole,\r\n        m.salary as mission_salary,\r\n        pm.provider as provider_id,\r\n        pm.profile as provider_profile_id,\r\n        pm.price_hour,\r\n        pm.price_hour_supp,\r\n        p.first_name as provider_first_name,\r\n        p.photo as provider_photo,\r\n        pr.regime_tva as provider_regime_tva,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as provider_job_name,\r\n        (\r\n          SELECT COALESCE(\r\n            json_agg(\r\n              json_build_object(\r\n                'schedule_date', ms.schedule_date,\r\n                'start_time', ms.start_time,\r\n                'end_time', ms.end_time\r\n              )\r\n            ORDER BY ms.schedule_date, ms.start_time\r\n          ),\r\n          '[]'::json\r\n          )\r\n        FROM missions.mission_schedules ms\r\n        WHERE ms.mission_id = m.id\r\n        ) AS mission_schedules\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN public.profiles p ON p.id = pm.profile\r\n      JOIN providers.providers pr ON pr.id = pm.provider\r\n      WHERE m.company_id = p_company_id\r\n        AND pm.state = 'assigned'\r\n        AND m.end_time < NOW()\r\n        AND (pm.popup_mission_finished = false OR pm.popup_mission_finished IS NULL)\r\n      ORDER BY m.end_time ASC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_finished_missions_popup_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_finished_missions_popup_provider(p_profile_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_start_time,\r\n        m.end_time as mission_end_time,\r\n        m.end_time as mission_end_date,\r\n        m.benevole as mission_benevole,\r\n        m.salary as mission_salary,\r\n        m.company_id as company_id,\r\n        c.nom_commercial as company_name,\r\n        (SELECT p.photo FROM public.profiles p WHERE p.id = c.profile) as company_logo,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as job_name,\r\n        -- Add report_submitted_at to know if company submitted report\r\n        pm.report_submitted_at as report_submitted_at,\r\n        -- Check if provider already rated this company for this mission\r\n        EXISTS(\r\n          SELECT 1 FROM companies.ratings cr\r\n          WHERE cr.profile = p_profile_id\r\n            AND cr.mission_id = m.id\r\n        ) as already_rated\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN companies.companies c ON c.id = m.company_id\r\n      WHERE pm.profile = p_profile_id\r\n        AND pm.state = 'assigned'\r\n        AND m.end_time < NOW()\r\n        AND (pm.popup_mission_finished_provider = false OR pm.popup_mission_finished_provider IS NULL)\r\n      ORDER BY m.end_time ASC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_messages_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_messages_v3(p_profile_mission_id uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)\n RETURNS TABLE(id uuid, sender_id uuid, sender_first_name_enc text, sender_photo uuid, content_enc text, message_type text, system_event text, created_at timestamp with time zone, is_read boolean, read_at timestamp with time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_user_id UUID;\r\nBEGIN\r\n  v_user_id := auth.uid();\r\n\r\n  IF NOT EXISTS (\r\n    SELECT 1\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id\r\n      AND (pm.profile = v_user_id OR c.profile = v_user_id)\r\n  ) THEN\r\n    RETURN;\r\n  END IF;\r\n\r\n  RETURN QUERY\r\n  SELECT\r\n    msg.id,\r\n    msg.sender_id,\r\n    p.first_name_enc AS sender_first_name_enc,\r\n    p.photo AS sender_photo,\r\n    msg.content_enc,\r\n    msg.message_type,\r\n    msg.system_event,\r\n    msg.created_at,\r\n    msg.is_read,\r\n    msg.read_at\r\n  FROM missions.messages msg\r\n  LEFT JOIN public.profiles p ON p.id = msg.sender_id\r\n  WHERE msg.profile_mission_id = p_profile_mission_id\r\n  ORDER BY msg.created_at ASC\r\n  LIMIT p_limit\r\n  OFFSET p_offset;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_mission_by_id",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_mission_by_id(p_mission_id uuid)\n RETURNS TABLE(id uuid, company_id uuid, title text, description text, location text, postal_code character varying, city character varying, latitude double precision, longitude double precision, start_time timestamp without time zone, end_time timestamp without time zone, salary numeric, status text, is_paid boolean, created_at timestamp without time zone, benevole boolean, requires_mobility boolean, items_to_bring text[], company_name text, company_siret text, company_description text, profile_photo uuid, job_name text, job_id integer, average_hourly_rate numeric, company_rating json)\n LANGUAGE sql\n SECURITY DEFINER\nAS $function$\r\n    SELECT\r\n        m.id, m.company_id, m.title, m.description, m.location,\r\n        m.postal_code, m.city, m.latitude, m.longitude,\r\n        m.start_time, m.end_time, m.salary, m.status, m.is_paid,\r\n        m.created_at, m.benevole, m.requires_mobility, m.items_to_bring,\r\n        c.nom_commercial AS company_name,\r\n        NULL::text AS company_siret,\r\n        c.description AS company_description,\r\n        p.photo AS profile_photo,\r\n        j.name AS job_name,\r\n        j.id AS job_id,\r\n        j.average_hourly_rate,\r\n        (\r\n            SELECT json_build_object(\r\n                'id', r.id,\r\n                'rate', r.rate,\r\n                'description', r.description,\r\n                'created_at', r.created_at\r\n            )\r\n            FROM providers.ratings r\r\n            WHERE r.mission = m.id\r\n                AND r.company = m.company_id\r\n            LIMIT 1\r\n        ) as company_rating\r\n    FROM missions.missions m\r\n    LEFT JOIN companies.companies c ON m.company_id = c.id\r\n    LEFT JOIN public.profiles p ON c.profile = p.id\r\n    LEFT JOIN jobs.jobs j ON m.job = j.id\r\n    WHERE m.id = p_mission_id;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_mission_candidates_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_mission_candidates_v2(p_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result json;\r\nBEGIN\r\n  SELECT json_agg(candidate_data ORDER BY candidate_data.created_at DESC)\r\n  INTO result\r\n  FROM (\r\n    SELECT\r\n      pm.id,\r\n      pm.mission,\r\n      pm.profile as profile_id,\r\n      pm.provider as provider_id,\r\n      pm.state,\r\n      pm.origin,\r\n      pm.price_hour,\r\n      pm.price_hour_supp,\r\n      pm.created_at,\r\n      p.first_name_enc,\r\n      p.last_name_enc,\r\n      p.photo,\r\n      p.vehicule as has_vehicule,\r\n      (\r\n        SELECT json_build_object(\r\n          'id', prov.id,\r\n          'bio', prov.more,\r\n          'regime_tva', prov.regime_tva\r\n        )\r\n        FROM providers.providers prov\r\n        WHERE prov.id = pm.provider\r\n      ) as provider_info,\r\n      (\r\n        SELECT j.name\r\n        FROM missions.missions m\r\n        JOIN jobs.jobs j ON j.id = m.job\r\n        WHERE m.id = pm.mission\r\n      ) as job_name,\r\n      (\r\n        SELECT json_agg(j.name)\r\n        FROM providers.provider_jobs pj\r\n        JOIN jobs.jobs j ON j.id = pj.job\r\n        WHERE pj.provider = pm.provider\r\n      ) as jobs,\r\n      (\r\n        SELECT COALESCE(ROUND(AVG(r.rate)::numeric, 1), 0)\r\n        FROM providers.ratings r\r\n        WHERE r.provider = pm.provider\r\n      ) as average_rating,\r\n      (\r\n        SELECT COUNT(*)::int\r\n        FROM providers.ratings r\r\n        WHERE r.provider = pm.provider\r\n      ) as ratings_count,\r\n      (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', e.id,\r\n            'intitule', e.intitule,\r\n            'description', e.description,\r\n            'start', e.start,\r\n            'end', e.\"end\"\r\n          ) ORDER BY e.start DESC\r\n        ), '[]'::json)\r\n        FROM (\r\n          SELECT * FROM providers.experiences exp\r\n          WHERE exp.profile = pm.profile\r\n          ORDER BY exp.start DESC\r\n          LIMIT 3\r\n        ) e\r\n      ) as experiences,\r\n      (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', rat.id,\r\n            'rate', rat.rate,\r\n            'description', rat.description,\r\n            'created_at', rat.created_at,\r\n            'company_name', (SELECT comp.nom_commercial FROM companies.companies comp WHERE comp.id = rat.company)\r\n          ) ORDER BY rat.created_at DESC\r\n        ), '[]'::json)\r\n        FROM (\r\n          SELECT * FROM providers.ratings r\r\n          WHERE r.provider = pm.provider\r\n          ORDER BY r.created_at DESC\r\n          LIMIT 3\r\n        ) rat\r\n      ) as recent_ratings\r\n    FROM missions.profile_missions pm\r\n    LEFT JOIN public.profiles p ON p.id = pm.profile\r\n    WHERE pm.mission = p_mission_id\r\n  ) as candidate_data;\r\n\r\n  RETURN COALESCE(result, '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_mission_schedules",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_mission_schedules(p_mission_id uuid)\n RETURNS TABLE(id uuid, schedule_date date, start_time time without time zone, end_time time without time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    ms.id,\r\n    ms.schedule_date,\r\n    ms.start_time,\r\n    ms.end_time\r\n  FROM missions.mission_schedules ms\r\n  WHERE ms.mission_id = p_mission_id\r\n  ORDER BY ms.schedule_date ASC;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_my_missions_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_my_missions_v2(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result json;\r\nBEGIN\r\n  SELECT json_agg(mission_data ORDER BY mission_data.start_time ASC)\r\n  INTO result\r\n  FROM (\r\n    SELECT\r\n      m.id,\r\n      m.title,\r\n      m.description,\r\n      m.location,\r\n      m.city,\r\n      m.postal_code,\r\n      m.latitude,\r\n      m.longitude,\r\n      m.start_time,\r\n      m.end_time,\r\n      m.salary,\r\n      m.status,\r\n      m.is_paid,\r\n      m.benevole,\r\n      m.job,\r\n      m.requires_mobility,\r\n      m.items_to_bring,\r\n      m.created_at,\r\n      (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as job_name,\r\n      (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', pm.id,\r\n            'profile_id', pm.profile,\r\n            'provider_id', pm.provider,\r\n            'state', pm.state,\r\n            'price_hour', pm.price_hour,\r\n            'price_hour_supp', pm.price_hour_supp,\r\n            'created_at', pm.created_at,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc,\r\n            'photo', p.photo\r\n          ) ORDER BY pm.created_at DESC\r\n        ), '[]'::json)\r\n        FROM missions.profile_missions pm\r\n        LEFT JOIN public.profiles p ON p.id = pm.profile\r\n        WHERE pm.mission = m.id\r\n      ) as providers,\r\n      (\r\n        SELECT json_build_object(\r\n          'id', r.id,\r\n          'rate', r.rate,\r\n          'description', r.description,\r\n          'created_at', r.created_at\r\n        )\r\n        FROM providers.ratings r\r\n        WHERE r.mission = m.id AND r.company = p_company_id\r\n        LIMIT 1\r\n      ) as company_rating\r\n    FROM missions.missions m\r\n    WHERE m.company_id = p_company_id\r\n  ) as mission_data;\r\n\r\n  RETURN COALESCE(result, '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_next_invoice_number",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_next_invoice_number()\n RETURNS text\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_year_month_day TEXT;\r\n  v_short_date TEXT;\r\n  v_next_number INTEGER;\r\nBEGIN\r\n  -- Obtenir l'année-mois-jour courant (pour la séquence interne)\r\n  v_year_month_day := TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD');\r\n  -- Format court pour le numéro visible (YY-MM-DD)\r\n  v_short_date := TO_CHAR(CURRENT_DATE, 'YY-MM-DD');\r\n\r\n  -- Insérer ou mettre à jour la séquence (atomic via UPSERT)\r\n  INSERT INTO missions.invoice_sequences (year_month_day, last_number, updated_at)\r\n  VALUES (v_year_month_day, 1, NOW())\r\n  ON CONFLICT (year_month_day) DO UPDATE\r\n  SET\r\n    last_number = missions.invoice_sequences.last_number + 1,\r\n    updated_at = NOW()\r\n  RETURNING last_number INTO v_next_number;\r\n\r\n  -- Retourner le numéro formaté: GTCH-YY-MM-DD-0000\r\n  RETURN 'GTCH-' || v_short_date || '-' || LPAD(v_next_number::TEXT, 4, '0');\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_pending_contract_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_pending_contract_missions(p_company_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_date,\r\n        pm.provider as provider_id,\r\n        pm.profile as provider_profile_id,\r\n        p.first_name as provider_first_name,\r\n        p.photo as provider_photo,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as provider_job_name\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN public.profiles p ON p.id = pm.profile\r\n      WHERE m.company_id = p_company_id\r\n        AND pm.state = 'confirmed'  -- NEW FLOW: Provider confirmed availability, waiting for company signature\r\n        AND m.start_time > NOW()    -- Only future missions\r\n        AND (pm.popup_mission_saved = false OR pm.popup_mission_saved IS NULL)\r\n        -- No need to check contrats table - contract is created when company signs\r\n      ORDER BY m.start_time ASC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_pending_contract_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_pending_contract_provider(p_profile_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_date,\r\n        pm.price_hour,\r\n        pm.price_hour_supp,\r\n        c.id as company_id,\r\n        c.profile as company_profile_id,  -- User ID for notifications\r\n        c.nom_commercial as company_name,\r\n        cp.photo as company_photo,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as job_name\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN companies.companies c ON c.id = m.company_id\r\n      JOIN public.profiles cp ON cp.id = c.profile\r\n      WHERE pm.profile = p_profile_id\r\n        AND pm.state = 'assigned'  -- State when company accepts a candidate\r\n        AND m.start_time > NOW()\r\n        AND (pm.popup_contract_pending_seen = false OR pm.popup_contract_pending_seen IS NULL)  -- Filter out seen popups\r\n        AND NOT EXISTS (\r\n          SELECT 1 FROM missions.contrats ct\r\n          WHERE ct.profile_mission = pm.id\r\n          AND ct.provider_signed_at IS NOT NULL\r\n        )\r\n      ORDER BY m.start_time ASC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_pending_reports_for_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_pending_reports_for_provider(p_profile_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'missions', 'companies', 'providers', 'public', 'jobs'\nAS $function$\r\nDECLARE\r\n    v_caller_id UUID;\r\nBEGIN\r\n    -- Utiliser auth.uid() au lieu du parametre pour empecher l'IDOR\r\n    v_caller_id := auth.uid();\r\n\r\n    IF v_caller_id IS NULL THEN\r\n        RETURN '[]'::json;\r\n    END IF;\r\n\r\n    RETURN COALESCE((\r\n        SELECT json_agg(row_to_json(t))\r\n        FROM (\r\n            SELECT\r\n                pm.id as profile_mission_id,\r\n                pm.report_submitted_at,\r\n                pm.report_hours_worked,\r\n                pm.report_hours_supp,\r\n                pm.report_comment,\r\n                pm.price_hour,\r\n                pm.price_hour_supp,\r\n                m.id as mission_id,\r\n                m.title as mission_title,\r\n                m.location as mission_address,\r\n                m.city as mission_city,\r\n                m.postal_code as mission_postal_code,\r\n                m.start_time as mission_start_time,\r\n                m.end_time as mission_end_time,\r\n                m.benevole as mission_benevole,\r\n                c.id as company_id,\r\n                c.nom_commercial as company_name,\r\n                (SELECT p.photo FROM public.profiles p WHERE p.id = c.profile) as company_logo,\r\n                (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as job_name,\r\n                COALESCE(prov.regime_tva, false) as provider_regime_tva\r\n            FROM missions.profile_missions pm\r\n            JOIN missions.missions m ON m.id = pm.mission\r\n            JOIN companies.companies c ON c.id = m.company_id\r\n            JOIN providers.providers prov ON prov.id = pm.provider\r\n            WHERE pm.profile = v_caller_id\r\n                AND pm.report_submitted_at IS NOT NULL\r\n                AND pm.provider_validation_status = 'pending'\r\n            ORDER BY pm.report_submitted_at ASC\r\n        ) t\r\n    ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_pending_sign_contract_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_pending_sign_contract_provider(p_profile_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN COALESCE((\r\n    SELECT json_agg(row_to_json(t))\r\n    FROM (\r\n      SELECT\r\n        pm.id as profile_mission_id,\r\n        m.id as mission_id,\r\n        m.title as mission_title,\r\n        m.location as mission_address,\r\n        m.city as mission_city,\r\n        m.postal_code as mission_postal_code,\r\n        m.start_time as mission_date,\r\n        pm.price_hour,\r\n        pm.price_hour_supp,\r\n        c.id as company_id,\r\n        c.profile as company_profile_id,  -- User ID for notifications\r\n        c.nom_commercial as company_name,\r\n        cp.photo as company_photo,\r\n        (SELECT j.name FROM jobs.jobs j WHERE j.id = m.job) as job_name,\r\n        -- Contract info\r\n        ct.id as contract_id,\r\n        ct.company_signed_at as contract_company_signed_at\r\n      FROM missions.profile_missions pm\r\n      JOIN missions.missions m ON m.id = pm.mission\r\n      JOIN companies.companies c ON c.id = m.company_id\r\n      JOIN public.profiles cp ON cp.id = c.profile\r\n      JOIN missions.contrats ct ON ct.profile_mission = pm.id\r\n      WHERE pm.profile = p_profile_id\r\n        -- State is 'employer_signed' when company has signed and waiting for provider\r\n        AND pm.state = 'employer_signed'\r\n        AND m.start_time > NOW()    -- Only future missions\r\n        -- Contract exists and company has signed, but provider hasn't\r\n        AND ct.company_signed_at IS NOT NULL\r\n        AND ct.provider_signed_at IS NULL\r\n      ORDER BY m.start_time ASC\r\n    ) t\r\n  ), '[]'::json);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_profile_mission_for_payment",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_profile_mission_for_payment(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result JSON;\r\nBEGIN\r\n  SELECT json_build_object(\r\n    'id', pm.id,\r\n    'mission_id', pm.mission,\r\n    'profile_id', pm.profile,\r\n    'provider_id', pm.provider,\r\n    'state', pm.state,\r\n    'price_hour', pm.price_hour,\r\n    'price_hour_supp', pm.price_hour_supp,\r\n    'payment_intent_id', pm.payment_intent_id,\r\n    'payment_status', pm.payment_status,\r\n    'mission', json_build_object(\r\n      'id', m.id,\r\n      'company_id', m.company_id,\r\n      'title', m.title,\r\n      'benevole', m.benevole,\r\n      'salary', m.salary,\r\n      'start_time', m.start_time,\r\n      'end_time', m.end_time\r\n    ),\r\n    'provider', json_build_object(\r\n      'id', prov.id,\r\n      'stripe_id', prov.stripe_id,\r\n      'profile_id', prov.profile,\r\n      'regime_tva', prov.regime_tva\r\n    ),\r\n    'profile', json_build_object(\r\n      'id', p.id,\r\n      'first_name', p.first_name,\r\n      'last_name', p.last_name\r\n    ),\r\n    'company', json_build_object(\r\n      'id', c.id,\r\n      'stripe_customer_id', NULL\r\n    )\r\n  ) INTO result\r\n  FROM missions.profile_missions pm\r\n  JOIN missions.missions m ON m.id = pm.mission\r\n  LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n  LEFT JOIN public.profiles p ON p.id = pm.profile\r\n  LEFT JOIN companies.companies c ON c.id = m.company_id\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  IF result IS NULL THEN\r\n    RETURN json_build_object('error', 'Profile mission not found');\r\n  END IF;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_profile_mission_for_payment_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_profile_mission_for_payment_v3(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    result JSON;\r\nBEGIN\r\n    SELECT json_build_object(\r\n        'id', pm.id,\r\n        'mission_id', pm.mission,\r\n        'profile_id', pm.profile,\r\n        'provider_id', pm.provider,\r\n        'state', pm.state,\r\n        'price_hour', pm.price_hour,\r\n        'price_hour_supp', pm.price_hour_supp,\r\n        'payment_intent_id', pm.payment_intent_id,\r\n        'payment_status', pm.payment_status,\r\n        'mission', json_build_object(\r\n            'id', m.id,\r\n            'company_id', m.company_id,\r\n            'title', m.title,\r\n            'benevole', m.benevole,\r\n            'salary', m.salary,\r\n            'start_time', m.start_time,\r\n            'end_time', m.end_time\r\n        ),\r\n        'provider', json_build_object(\r\n            'id', prov.id,\r\n            'stripe_id', prov.stripe_id_enc,\r\n            'profile_id', prov.profile,\r\n            'regime_tva', prov.regime_tva\r\n        ),\r\n        'profile', json_build_object(\r\n            'id', p.id,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc\r\n        ),\r\n        'company', json_build_object(\r\n            'id', c.id,\r\n            'stripe_customer_id', c.stripe_customer_id_enc\r\n        )\r\n    ) INTO result\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n    LEFT JOIN public.profiles p ON p.id = pm.profile\r\n    LEFT JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF result IS NULL THEN\r\n        RETURN json_build_object('error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "get_provider_contracts_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.get_provider_contracts_v2(p_profile_id uuid)\n RETURNS TABLE(contract_id uuid, contract_status text, contract_created_at timestamp with time zone, contract_provider_signed_at timestamp with time zone, contract_company_signed_at timestamp with time zone, profile_mission_id uuid, mission_id uuid, mission_title text, mission_job character varying, mission_start_time timestamp without time zone, mission_end_time timestamp without time zone, company_id uuid, company_name text, company_rep_first_name_enc text, company_rep_last_name_enc text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  IF p_profile_id != auth.uid() THEN\r\n    RAISE EXCEPTION 'Not authorized';\r\n  END IF;\r\n\r\n  RETURN QUERY\r\n  SELECT\r\n    c.id AS contract_id,\r\n    c.status AS contract_status,\r\n    c.created_at AS contract_created_at,\r\n    c.provider_signed_at AS contract_provider_signed_at,\r\n    c.company_signed_at AS contract_company_signed_at,\r\n    pm.id AS profile_mission_id,\r\n    m.id AS mission_id,\r\n    m.title AS mission_title,\r\n    j.name AS mission_job,\r\n    m.start_time AS mission_start_time,\r\n    m.end_time AS mission_end_time,\r\n    co.id AS company_id,\r\n    co.nom_commercial AS company_name,\r\n    cp.first_name_enc AS company_rep_first_name_enc,\r\n    cp.last_name_enc AS company_rep_last_name_enc\r\n  FROM missions.contrats c\r\n    INNER JOIN missions.profile_missions pm ON pm.id = c.profile_mission\r\n    INNER JOIN missions.missions m ON m.id = pm.mission\r\n    INNER JOIN companies.companies co ON co.id = m.company_id\r\n    INNER JOIN public.profiles cp ON cp.id = co.profile\r\n    LEFT JOIN jobs.jobs j ON j.id = m.job\r\n  WHERE pm.profile = p_profile_id\r\n    AND c.provider_signed_at IS NOT NULL\r\n  ORDER BY c.created_at DESC;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "insert_system_message_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.insert_system_message_v3(p_profile_mission_id uuid, p_event text, p_content_enc text)\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_message_id UUID;\r\nBEGIN\r\n  IF p_content_enc IS NULL OR btrim(p_content_enc) = '' THEN\r\n    RAISE EXCEPTION 'Encrypted message content is required';\r\n  END IF;\r\n\r\n  IF p_content_enc NOT LIKE 'v1:%' THEN\r\n    RAISE EXCEPTION 'Invalid encrypted message format';\r\n  END IF;\r\n\r\n  INSERT INTO missions.messages (profile_mission_id, content_enc, message_type, system_event, is_read)\r\n  VALUES (p_profile_mission_id, p_content_enc, 'system', p_event, FALSE)\r\n  RETURNING id INTO v_message_id;\r\n\r\n  RETURN v_message_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_download_check_access_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_download_check_access_v2(p_invoice_id uuid, p_user_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_invoice RECORD;\r\n    v_has_access BOOLEAN := FALSE;\r\n    v_provider_id UUID;\r\n    v_company_id UUID;\r\nBEGIN\r\n    -- Get invoice\r\n    SELECT * INTO v_invoice\r\n    FROM missions.invoices\r\n    WHERE id = p_invoice_id;\r\n\r\n    IF v_invoice IS NULL THEN\r\n        RETURN jsonb_build_object('error', 'Invoice not found', 'status', 404);\r\n    END IF;\r\n\r\n    -- Check provider access\r\n    IF v_invoice.issuer_type = 'provider' AND v_invoice.issuer_id IS NOT NULL THEN\r\n        SELECT id INTO v_provider_id\r\n        FROM providers.providers\r\n        WHERE id = v_invoice.issuer_id AND profile = p_user_id;\r\n\r\n        IF v_provider_id IS NOT NULL THEN\r\n            v_has_access := TRUE;\r\n        END IF;\r\n    END IF;\r\n\r\n    -- Check company access\r\n    IF NOT v_has_access AND v_invoice.recipient_company_id IS NOT NULL THEN\r\n        SELECT id INTO v_company_id\r\n        FROM companies.companies\r\n        WHERE id = v_invoice.recipient_company_id AND profile = p_user_id;\r\n\r\n        IF v_company_id IS NOT NULL THEN\r\n            v_has_access := TRUE;\r\n        END IF;\r\n    END IF;\r\n\r\n    IF NOT v_has_access THEN\r\n        RETURN jsonb_build_object('error', 'Access denied', 'status', 403);\r\n    END IF;\r\n\r\n    RETURN jsonb_build_object(\r\n        'invoice', jsonb_build_object(\r\n            'id', v_invoice.id,\r\n            'invoice_number', v_invoice.invoice_number,\r\n            'invoice_type', v_invoice.invoice_type,\r\n            'invoice_date', v_invoice.invoice_date,\r\n            'amount_ttc', v_invoice.amount_ttc,\r\n            'pdf_storage_path', v_invoice.pdf_storage_path,\r\n            'issuer_name_enc', v_invoice.issuer_name_enc,\r\n            'recipient_name_enc', v_invoice.recipient_name_enc\r\n        ),\r\n        'has_access', TRUE\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_get_email_data_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_get_email_data_v3(p_profile_mission_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_invoices JSONB;\r\n    v_pm RECORD;\r\n    v_mission RECORD;\r\n    v_provider RECORD;\r\n    v_provider_profile RECORD;\r\n    v_company RECORD;\r\n    v_company_profile RECORD;\r\nBEGIN\r\n    SELECT COALESCE(jsonb_agg(\r\n        jsonb_build_object(\r\n            'id', i.id,\r\n            'invoice_type', i.invoice_type,\r\n            'invoice_number', i.invoice_number,\r\n            'amount_ttc', i.amount_ttc,\r\n            'pdf_storage_path', i.pdf_storage_path,\r\n            'issuer_name_enc', i.issuer_name_enc\r\n        )\r\n    ), '[]'::jsonb)\r\n    INTO v_invoices\r\n    FROM missions.invoices i\r\n    WHERE i.profile_mission_id = p_profile_mission_id;\r\n\r\n    SELECT * INTO v_pm\r\n    FROM missions.profile_missions\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    IF v_pm IS NULL THEN\r\n        RAISE EXCEPTION 'Profile mission not found';\r\n    END IF;\r\n\r\n    SELECT id, company_id, title, start_time INTO v_mission\r\n    FROM missions.missions\r\n    WHERE id = v_pm.mission;\r\n\r\n    SELECT profile INTO v_provider\r\n    FROM providers.providers\r\n    WHERE id = v_pm.provider;\r\n\r\n    SELECT email_enc, first_name_enc, last_name_enc INTO v_provider_profile\r\n    FROM public.profiles\r\n    WHERE id = v_provider.profile;\r\n\r\n    SELECT profile, nom_commercial INTO v_company\r\n    FROM companies.companies\r\n    WHERE id = v_mission.company_id;\r\n\r\n    SELECT email_enc INTO v_company_profile\r\n    FROM public.profiles\r\n    WHERE id = v_company.profile;\r\n\r\n    RETURN jsonb_build_object(\r\n        'invoices', v_invoices,\r\n        'mission', to_jsonb(v_mission),\r\n        'provider_email_enc', v_provider_profile.email_enc,\r\n        'provider_first_name_enc', v_provider_profile.first_name_enc,\r\n        'provider_last_name_enc', v_provider_profile.last_name_enc,\r\n        'company_email_enc', v_company_profile.email_enc,\r\n        'company_name', v_company.nom_commercial\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_get_generation_data_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_get_generation_data_v2(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  result JSON;\r\nBEGIN\r\n  SELECT json_build_object(\r\n    'profile_mission', json_build_object(\r\n      'id', pm.id,\r\n      'payment_status', pm.payment_status,\r\n      'payment_amount', pm.payment_amount,\r\n      'hours_worked', pm.hours_worked,\r\n      'hours_supp_worked', pm.hours_supp_worked,\r\n      'price_hour', pm.price_hour,\r\n      'price_hour_supp', pm.price_hour_supp,\r\n      'provider_validation_status', pm.provider_validation_status\r\n    ),\r\n    'mission', json_build_object(\r\n      'id', m.id,\r\n      'title', m.title,\r\n      'start_time', m.start_time,\r\n      'end_time', m.end_time,\r\n      'salary', m.salary,\r\n      -- missions.missions has no address column (legacy compatibility key kept as null)\r\n      'address', NULL,\r\n      'location', m.location\r\n    ),\r\n    'provider', json_build_object(\r\n      'id', prov.id,\r\n      'siret', prov.siret,  -- TODO Lot 4 providers: sera prov.siret_enc\r\n      'adresse_facturation', prov.adresse_facturation,\r\n      'regime_tva', prov.regime_tva,\r\n      'tva_number', prov.tva_number  -- TODO Lot 4 providers: sera prov.tva_number_enc\r\n    ),\r\n    'provider_profile', json_build_object(\r\n      'id', pp.id,\r\n      'first_name', pp.first_name,\r\n      'last_name', pp.last_name,\r\n      'email', pp.email\r\n    ),\r\n    'company', json_build_object(\r\n      'id', comp.id,\r\n      'nom_commercial', comp.nom_commercial,\r\n      'siret', comp.siret_enc,  -- V2: retourne _enc, Node déchiffre\r\n      'siret_gouv_infos', comp.siret_gouv_infos_enc  -- V2: retourne _enc, Node déchiffre (full JSON)\r\n    ),\r\n    'company_profile', json_build_object(\r\n      'id', cp.id,\r\n      'first_name', cp.first_name,\r\n      'last_name', cp.last_name,\r\n      'email', cp.email\r\n    ),\r\n    'existing_invoices', COALESCE(\r\n      (SELECT json_agg(json_build_object('id', inv.id, 'invoice_type', inv.invoice_type))\r\n       FROM missions.invoices inv\r\n       WHERE inv.profile_mission_id = pm.id),\r\n      '[]'::json\r\n    )\r\n  ) INTO result\r\n  FROM missions.profile_missions pm\r\n  INNER JOIN missions.missions m ON pm.mission = m.id\r\n  INNER JOIN providers.providers prov ON pm.provider = prov.id\r\n  INNER JOIN public.profiles pp ON prov.profile = pp.id\r\n  INNER JOIN companies.companies comp ON m.company_id = comp.id\r\n  INNER JOIN public.profiles cp ON comp.profile = cp.id\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  IF result IS NULL THEN\r\n    RAISE EXCEPTION 'Profile mission not found: %', p_profile_mission_id;\r\n  END IF;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_get_generation_data_v4",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_get_generation_data_v4(p_profile_mission_id uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    result JSON;\r\nBEGIN\r\n    SELECT json_build_object(\r\n        'profile_mission', json_build_object(\r\n            'id', pm.id,\r\n            'payment_status', pm.payment_status,\r\n            'payment_amount', pm.payment_amount,\r\n            'hours_worked', pm.hours_worked,\r\n            'hours_supp_worked', pm.hours_supp_worked,\r\n            'price_hour', pm.price_hour,\r\n            'price_hour_supp', pm.price_hour_supp,\r\n            'provider_validation_status', pm.provider_validation_status\r\n        ),\r\n        'mission', json_build_object(\r\n            'id', m.id,\r\n            'title', m.title,\r\n            'start_time', m.start_time,\r\n            'end_time', m.end_time,\r\n            'salary', m.salary,\r\n            'address', NULL,\r\n            'location', m.location\r\n        ),\r\n        'provider', json_build_object(\r\n            'id', prov.id,\r\n            'siret', prov.siret_enc,\r\n            'adresse_facturation', prov.adresse_facturation_enc,\r\n            'regime_tva', prov.regime_tva,\r\n            'tva_number', prov.tva_number_enc\r\n        ),\r\n        'provider_profile', json_build_object(\r\n            'id', pp.id,\r\n            'first_name_enc', pp.first_name_enc,\r\n            'last_name_enc', pp.last_name_enc,\r\n            'email_enc', pp.email_enc\r\n        ),\r\n        'company', json_build_object(\r\n            'id', comp.id,\r\n            'nom_commercial', comp.nom_commercial,\r\n            'siret', comp.siret_enc,\r\n            'siret_gouv_infos', comp.siret_gouv_infos_enc\r\n        ),\r\n        'company_profile', json_build_object(\r\n            'id', cp.id,\r\n            'first_name_enc', cp.first_name_enc,\r\n            'last_name_enc', cp.last_name_enc,\r\n            'email_enc', cp.email_enc\r\n        ),\r\n        'existing_invoices', COALESCE(\r\n            (SELECT json_agg(json_build_object('id', inv.id, 'invoice_type', inv.invoice_type))\r\n             FROM missions.invoices inv\r\n             WHERE inv.profile_mission_id = pm.id),\r\n            '[]'::json\r\n        )\r\n    ) INTO result\r\n    FROM missions.profile_missions pm\r\n    INNER JOIN missions.missions m ON pm.mission = m.id\r\n    INNER JOIN providers.providers prov ON pm.provider = prov.id\r\n    INNER JOIN public.profiles pp ON prov.profile = pp.id\r\n    INNER JOIN companies.companies comp ON m.company_id = comp.id\r\n    INNER JOIN public.profiles cp ON comp.profile = cp.id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF result IS NULL THEN\r\n        RAISE EXCEPTION 'Profile mission not found: %', p_profile_mission_id;\r\n    END IF;\r\n\r\n    RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_insert_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_insert_v2(p_invoice_data jsonb)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_result RECORD;\r\nBEGIN\r\n    INSERT INTO missions.invoices (\r\n        profile_mission_id,\r\n        mission_id,\r\n        invoice_type,\r\n        issuer_type,\r\n        issuer_id,\r\n        recipient_company_id,\r\n        invoice_number,\r\n        invoice_date,\r\n        amount_ht,\r\n        tva_rate,\r\n        tva_amount,\r\n        amount_ttc,\r\n        mission_date,\r\n        hours_worked,\r\n        hours_supp,\r\n        hourly_rate,\r\n        hourly_rate_supp,\r\n        description,\r\n        -- Encrypted columns\r\n        issuer_name_enc,\r\n        issuer_address_enc,\r\n        issuer_siret_enc,\r\n        issuer_siret_bidx,\r\n        issuer_tva_number_enc,\r\n        issuer_tva_number_bidx,\r\n        recipient_name_enc,\r\n        recipient_address_enc,\r\n        recipient_siret_enc,\r\n        recipient_siret_bidx,\r\n        -- Other\r\n        pdf_storage_path,\r\n        pdf_generated_at\r\n    )\r\n    VALUES (\r\n        (p_invoice_data->>'profile_mission_id')::UUID,\r\n        (p_invoice_data->>'mission_id')::UUID,\r\n        p_invoice_data->>'invoice_type',\r\n        p_invoice_data->>'issuer_type',\r\n        CASE WHEN p_invoice_data->>'issuer_id' IS NULL OR p_invoice_data->>'issuer_id' = ''\r\n             THEN NULL\r\n             ELSE (p_invoice_data->>'issuer_id')::UUID\r\n        END,\r\n        (p_invoice_data->>'recipient_company_id')::UUID,\r\n        p_invoice_data->>'invoice_number',\r\n        (p_invoice_data->>'invoice_date')::DATE,\r\n        (p_invoice_data->>'amount_ht')::NUMERIC,\r\n        (p_invoice_data->>'tva_rate')::NUMERIC,\r\n        (p_invoice_data->>'tva_amount')::NUMERIC,\r\n        (p_invoice_data->>'amount_ttc')::NUMERIC,\r\n        (p_invoice_data->>'mission_date')::TIMESTAMPTZ,\r\n        (p_invoice_data->>'hours_worked')::NUMERIC,\r\n        (p_invoice_data->>'hours_supp')::NUMERIC,\r\n        (p_invoice_data->>'hourly_rate')::NUMERIC,\r\n        CASE WHEN p_invoice_data->>'hourly_rate_supp' IS NULL OR p_invoice_data->>'hourly_rate_supp' = ''\r\n             THEN NULL\r\n             ELSE (p_invoice_data->>'hourly_rate_supp')::NUMERIC\r\n        END,\r\n        p_invoice_data->>'description',\r\n        -- Encrypted columns (pre-encrypted by Node)\r\n        p_invoice_data->>'issuer_name_enc',\r\n        p_invoice_data->>'issuer_address_enc',\r\n        p_invoice_data->>'issuer_siret_enc',\r\n        p_invoice_data->>'issuer_siret_bidx',\r\n        p_invoice_data->>'issuer_tva_number_enc',\r\n        p_invoice_data->>'issuer_tva_number_bidx',\r\n        p_invoice_data->>'recipient_name_enc',\r\n        p_invoice_data->>'recipient_address_enc',\r\n        p_invoice_data->>'recipient_siret_enc',\r\n        p_invoice_data->>'recipient_siret_bidx',\r\n        -- Other\r\n        p_invoice_data->>'pdf_storage_path',\r\n        CASE WHEN p_invoice_data->>'pdf_generated_at' IS NULL OR p_invoice_data->>'pdf_generated_at' = ''\r\n             THEN NULL\r\n             ELSE (p_invoice_data->>'pdf_generated_at')::TIMESTAMPTZ\r\n        END\r\n    )\r\n    RETURNING * INTO v_result;\r\n\r\n    RETURN to_jsonb(v_result);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_list_for_user_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_list_for_user_v2(p_user_id uuid, p_role text)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_entity_id UUID;\r\n    v_invoices JSONB;\r\nBEGIN\r\n    IF p_role = 'provider' THEN\r\n        -- Get provider ID\r\n        SELECT id INTO v_entity_id\r\n        FROM providers.providers\r\n        WHERE profile = p_user_id;\r\n\r\n        IF v_entity_id IS NULL THEN\r\n            RETURN '[]'::JSONB;\r\n        END IF;\r\n\r\n        -- Get provider invoices (with encrypted recipient_name)\r\n        SELECT COALESCE(jsonb_agg(\r\n            jsonb_build_object(\r\n                'id', id,\r\n                'invoice_number', invoice_number,\r\n                'invoice_type', invoice_type,\r\n                'invoice_date', invoice_date,\r\n                'amount_ht', amount_ht,\r\n                'tva_rate', tva_rate,\r\n                'tva_amount', tva_amount,\r\n                'amount_ttc', amount_ttc,\r\n                'mission_date', mission_date,\r\n                'hours_worked', hours_worked,\r\n                'hours_supp', hours_supp,\r\n                'hourly_rate', hourly_rate,\r\n                'description', description,\r\n                'recipient_name_enc', recipient_name_enc,\r\n                'pdf_storage_path', pdf_storage_path,\r\n                'created_at', created_at\r\n            ) ORDER BY invoice_date DESC\r\n        ), '[]'::jsonb)\r\n        INTO v_invoices\r\n        FROM missions.invoices\r\n        WHERE issuer_id = v_entity_id AND issuer_type = 'provider';\r\n\r\n    ELSIF p_role = 'company' THEN\r\n        -- Get company ID\r\n        SELECT id INTO v_entity_id\r\n        FROM companies.companies\r\n        WHERE profile = p_user_id;\r\n\r\n        IF v_entity_id IS NULL THEN\r\n            RETURN '[]'::JSONB;\r\n        END IF;\r\n\r\n        -- Get company invoices (with encrypted issuer_name)\r\n        SELECT COALESCE(jsonb_agg(\r\n            jsonb_build_object(\r\n                'id', id,\r\n                'invoice_number', invoice_number,\r\n                'invoice_type', invoice_type,\r\n                'invoice_date', invoice_date,\r\n                'amount_ht', amount_ht,\r\n                'tva_rate', tva_rate,\r\n                'tva_amount', tva_amount,\r\n                'amount_ttc', amount_ttc,\r\n                'mission_date', mission_date,\r\n                'hours_worked', hours_worked,\r\n                'hours_supp', hours_supp,\r\n                'hourly_rate', hourly_rate,\r\n                'description', description,\r\n                'issuer_name_enc', issuer_name_enc,\r\n                'issuer_type', issuer_type,\r\n                'pdf_storage_path', pdf_storage_path,\r\n                'created_at', created_at\r\n            ) ORDER BY invoice_date DESC\r\n        ), '[]'::jsonb)\r\n        INTO v_invoices\r\n        FROM missions.invoices\r\n        WHERE recipient_company_id = v_entity_id;\r\n    ELSE\r\n        RETURN '[]'::JSONB;\r\n    END IF;\r\n\r\n    RETURN v_invoices;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "invoice_mark_email_sent_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.invoice_mark_email_sent_v2(p_invoice_id uuid, p_email_recipient_enc text, p_email_recipient_bidx text)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_invoice RECORD;\r\n    v_result RECORD;\r\nBEGIN\r\n    -- Recuperer la facture\r\n    SELECT * INTO v_invoice FROM missions.invoices WHERE id = p_invoice_id;\r\n\r\n    IF v_invoice IS NULL THEN\r\n        RETURN jsonb_build_object('error', 'Invoice not found');\r\n    END IF;\r\n\r\n    -- Verifier que l'email n'a pas deja ete envoye\r\n    IF v_invoice.email_sent_at IS NOT NULL THEN\r\n        RETURN jsonb_build_object('error', 'Invoice email already sent');\r\n    END IF;\r\n\r\n    UPDATE missions.invoices\r\n    SET\r\n        email_sent_at = NOW(),\r\n        email_recipient_enc = p_email_recipient_enc,\r\n        email_recipient_bidx = p_email_recipient_bidx\r\n    WHERE id = p_invoice_id\r\n    RETURNING * INTO v_result;\r\n\r\n    RETURN jsonb_build_object('success', true, 'id', v_result.id);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "is_company_owner_of_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.is_company_owner_of_mission(p_mission_id uuid)\n RETURNS boolean\n LANGUAGE sql\n STABLE SECURITY DEFINER\n SET search_path TO 'missions', 'companies'\nAS $function$\r\n    SELECT EXISTS (\r\n        SELECT 1 FROM missions.missions m\r\n        JOIN companies.companies c ON c.id = m.company_id\r\n        WHERE m.id = p_mission_id\r\n        AND c.profile = auth.uid()\r\n    );\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_deadline_reminder_sent",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_deadline_reminder_sent(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'missions', 'companies'\nAS $function$\r\nDECLARE\r\n    v_pm RECORD;\r\nBEGIN\r\n    -- Recuperer le profile_mission\r\n    SELECT * INTO v_pm FROM missions.profile_missions WHERE id = p_profile_mission_id;\r\n\r\n    IF v_pm IS NULL THEN\r\n        RETURN false;\r\n    END IF;\r\n\r\n    -- Verifier l'autorisation : seule la company de la mission ou service_role\r\n    -- Note: service_role bypass ce check via SECURITY DEFINER\r\n    IF auth.uid() IS NOT NULL THEN\r\n        IF NOT EXISTS (\r\n            SELECT 1 FROM missions.missions m\r\n            JOIN companies.companies c ON c.id = m.company_id\r\n            WHERE m.id = v_pm.mission\r\n            AND c.profile = auth.uid()\r\n        ) THEN\r\n            RETURN false;\r\n        END IF;\r\n    END IF;\r\n\r\n    UPDATE missions.profile_missions\r\n    SET deadline_reminder_sent = TRUE\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_messages_as_read",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_messages_as_read(p_profile_mission_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_count INTEGER;\r\n  v_user_id UUID;\r\nBEGIN\r\n  v_user_id := auth.uid();\r\n\r\n  -- Verify user is participant\r\n  IF NOT EXISTS (\r\n    SELECT 1 FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id\r\n    AND (pm.profile = v_user_id OR c.profile = v_user_id)\r\n  ) THEN\r\n    RETURN 0;\r\n  END IF;\r\n\r\n  UPDATE missions.messages\r\n  SET is_read = TRUE, read_at = NOW()\r\n  WHERE profile_mission_id = p_profile_mission_id\r\n    AND sender_id IS DISTINCT FROM v_user_id\r\n    AND is_read = FALSE;\r\n\r\n  GET DIAGNOSTICS v_count = ROW_COUNT;\r\n  RETURN v_count;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_popup_contract_finalized_seen",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_popup_contract_finalized_seen(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_company_id uuid;\r\n  v_user_company_id uuid;\r\nBEGIN\r\n  -- Get the company_id for this profile_mission via mission\r\n  SELECT m.company_id INTO v_company_id\r\n  FROM missions.profile_missions pm\r\n  JOIN missions.missions m ON m.id = pm.mission\r\n  WHERE pm.id = p_profile_mission_id;\r\n\r\n  IF v_company_id IS NULL THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Get the company_id for the current user\r\n  SELECT c.id INTO v_user_company_id\r\n  FROM companies.companies c\r\n  WHERE c.profile = auth.uid();\r\n\r\n  -- Verify that the current user owns this company\r\n  IF v_user_company_id IS NULL OR v_user_company_id != v_company_id THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Update the flag\r\n  UPDATE missions.profile_missions\r\n  SET popup_contract_finalized_seen = true\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN true;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_popup_contract_pending_seen",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_popup_contract_pending_seen(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_profile_id uuid;\r\nBEGIN\r\n  -- Verify that the current user owns this profile_mission\r\n  SELECT profile INTO v_profile_id\r\n  FROM missions.profile_missions\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  IF v_profile_id IS NULL OR v_profile_id != auth.uid() THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Update the flag\r\n  UPDATE missions.profile_missions\r\n  SET popup_contract_pending_seen = true\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN true;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_popup_mission_finished",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_popup_mission_finished(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_allowed boolean;\r\nBEGIN\r\n  -- Vérifier que l'utilisateur est le propriétaire de la mission\r\n  SELECT EXISTS (\r\n    SELECT 1 FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id\r\n    AND c.profile = auth.uid()\r\n  ) INTO v_allowed;\r\n\r\n  IF NOT v_allowed THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Mettre à jour\r\n  UPDATE missions.profile_missions\r\n  SET popup_mission_finished = true\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN true;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_popup_mission_finished_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_popup_mission_finished_provider(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_profile_id uuid;\r\nBEGIN\r\n  -- Verify that the current user owns this profile_mission\r\n  SELECT profile INTO v_profile_id\r\n  FROM missions.profile_missions\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  IF v_profile_id IS NULL OR v_profile_id != auth.uid() THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Update the flag\r\n  UPDATE missions.profile_missions\r\n  SET popup_mission_finished_provider = true\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN true;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "mark_popup_mission_saved",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.mark_popup_mission_saved(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_allowed boolean;\r\nBEGIN\r\n  -- Vérifier que l'utilisateur est le propriétaire de la mission\r\n  SELECT EXISTS (\r\n    SELECT 1 FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id\r\n    AND c.profile = auth.uid()\r\n  ) INTO v_allowed;\r\n\r\n  IF NOT v_allowed THEN\r\n    RETURN false;\r\n  END IF;\r\n\r\n  -- Mettre à jour\r\n  UPDATE missions.profile_missions\r\n  SET popup_mission_saved = true\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN true;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "open_dispute",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.open_dispute(p_profile_mission_id uuid, p_reason text, p_description text, p_disputed_hours_worked numeric DEFAULT NULL::numeric, p_disputed_hours_supp numeric DEFAULT NULL::numeric)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_profile_mission RECORD;\r\n    v_is_company BOOLEAN := false;\r\n    v_is_provider BOOLEAN := false;\r\n    v_opened_by TEXT;\r\n    v_dispute_id UUID;\r\n    v_existing_dispute RECORD;\r\nBEGIN\r\n    SELECT\r\n        pm.*,\r\n        c.profile as company_profile\r\n    INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    IF v_profile_mission.company_profile = auth.uid() THEN\r\n        v_is_company := true;\r\n        v_opened_by := 'company';\r\n    ELSIF v_profile_mission.profile = auth.uid() THEN\r\n        v_is_provider := true;\r\n        v_opened_by := 'provider';\r\n    ELSE\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized');\r\n    END IF;\r\n\r\n    SELECT * INTO v_existing_dispute\r\n    FROM missions.disputes\r\n    WHERE profile_mission = p_profile_mission_id\r\n    AND status IN ('pending', 'in_review');\r\n\r\n    IF v_existing_dispute IS NOT NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'A dispute is already open for this mission');\r\n    END IF;\r\n\r\n    INSERT INTO missions.disputes (\r\n        profile_mission,\r\n        opened_by,\r\n        opened_by_profile,\r\n        reason,\r\n        description,\r\n        disputed_hours_worked,\r\n        disputed_hours_supp,\r\n        status\r\n    ) VALUES (\r\n        p_profile_mission_id,\r\n        v_opened_by,\r\n        auth.uid(),\r\n        p_reason,\r\n        p_description,\r\n        p_disputed_hours_worked,\r\n        p_disputed_hours_supp,\r\n        'pending'\r\n    )\r\n    RETURNING id INTO v_dispute_id;\r\n\r\n    IF v_profile_mission.provider_validation_status IS NULL THEN\r\n        UPDATE missions.profile_missions\r\n        SET provider_validation_status = 'disputed'\r\n        WHERE id = p_profile_mission_id;\r\n    END IF;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'dispute_id', v_dispute_id,\r\n        'opened_by', v_opened_by\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "prevent_contract_delete_under_retention",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.prevent_contract_delete_under_retention()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  IF OLD.evidence_legal_hold THEN\r\n    RAISE EXCEPTION 'Deletion blocked: contract evidence is under legal hold';\r\n  END IF;\r\n\r\n  IF OLD.evidence_retention_until IS NOT NULL AND NOW() < OLD.evidence_retention_until THEN\r\n    RAISE EXCEPTION 'Deletion blocked: evidence retention period active until %', OLD.evidence_retention_until;\r\n  END IF;\r\n\r\n  RETURN OLD;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "send_message_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.send_message_v3(p_profile_mission_id uuid, p_content_enc text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_user_id UUID;\r\n  v_message_id UUID;\r\n  v_recipient_id UUID;\r\n  v_pm RECORD;\r\nBEGIN\r\n  v_user_id := auth.uid();\r\n\r\n  IF p_content_enc IS NULL OR btrim(p_content_enc) = '' THEN\r\n    RETURN json_build_object('success', false, 'error', 'Encrypted message content is required');\r\n  END IF;\r\n\r\n  IF p_content_enc NOT LIKE 'v1:%' THEN\r\n    RETURN json_build_object('success', false, 'error', 'Invalid encrypted message format');\r\n  END IF;\r\n\r\n  SELECT\r\n    pm.id,\r\n    pm.profile AS provider_profile_id,\r\n    c.profile AS company_profile_id,\r\n    ct.provider_signed_at,\r\n    ct.company_signed_at\r\n  INTO v_pm\r\n  FROM missions.profile_missions pm\r\n  JOIN missions.missions m ON m.id = pm.mission\r\n  JOIN companies.companies c ON c.id = m.company_id\r\n  LEFT JOIN missions.contrats ct ON ct.profile_mission = pm.id\r\n  WHERE pm.id = p_profile_mission_id\r\n    AND (pm.profile = v_user_id OR c.profile = v_user_id);\r\n\r\n  IF v_pm IS NULL THEN\r\n    RETURN json_build_object('success', false, 'error', 'Not authorized or conversation not found');\r\n  END IF;\r\n\r\n  IF v_pm.provider_signed_at IS NULL OR v_pm.company_signed_at IS NULL THEN\r\n    RETURN json_build_object('success', false, 'error', 'Contract must be signed by both parties');\r\n  END IF;\r\n\r\n  IF v_user_id = v_pm.provider_profile_id THEN\r\n    v_recipient_id := v_pm.company_profile_id;\r\n  ELSE\r\n    v_recipient_id := v_pm.provider_profile_id;\r\n  END IF;\r\n\r\n  INSERT INTO missions.messages (profile_mission_id, sender_id, content_enc, message_type)\r\n  VALUES (p_profile_mission_id, v_user_id, p_content_enc, 'user')\r\n  RETURNING id INTO v_message_id;\r\n\r\n  RETURN json_build_object(\r\n    'success', true,\r\n    'message_id', v_message_id,\r\n    'recipient_id', v_recipient_id\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "submit_mission_report",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.submit_mission_report(p_profile_mission_id uuid, p_hours_worked numeric, p_hours_supp numeric DEFAULT 0, p_comment text DEFAULT NULL::text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_profile_mission RECORD;\r\n    v_company_profile_id UUID;\r\n    v_provider_profile_id UUID;\r\nBEGIN\r\n    SELECT\r\n        pm.*,\r\n        m.company_id,\r\n        m.end_time,\r\n        m.benevole,\r\n        c.profile as company_profile\r\n    INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    JOIN companies.companies c ON c.id = m.company_id\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    IF v_profile_mission.company_profile != auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized - must be company owner');\r\n    END IF;\r\n\r\n    IF v_profile_mission.end_time > NOW() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Mission has not ended yet');\r\n    END IF;\r\n\r\n    IF v_profile_mission.state != 'assigned' THEN\r\n        RETURN json_build_object('success', false, 'error', 'Invalid mission state: ' || v_profile_mission.state);\r\n    END IF;\r\n\r\n    IF v_profile_mission.report_submitted_at IS NOT NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Report already submitted');\r\n    END IF;\r\n\r\n    IF p_hours_worked < 0 OR p_hours_supp < 0 THEN\r\n        RETURN json_build_object('success', false, 'error', 'Hours cannot be negative');\r\n    END IF;\r\n\r\n    UPDATE missions.profile_missions\r\n    SET\r\n        report_submitted_at = NOW(),\r\n        report_hours_worked = p_hours_worked,\r\n        report_hours_supp = p_hours_supp,\r\n        report_comment = p_comment,\r\n        provider_validation_status = 'pending'\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    UPDATE missions.profile_missions\r\n    SET popup_mission_finished = true\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'profile_mission_id', p_profile_mission_id,\r\n        'provider_profile_id', v_profile_mission.profile\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "trg_set_dispute_auto_release",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.trg_set_dispute_auto_release()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  IF NEW.auto_release_at IS NULL AND NEW.opened_at IS NOT NULL THEN\r\n    NEW.auto_release_at := NEW.opened_at + INTERVAL '31 days';\r\n  END IF;\r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "trigger_reset_cancellations_on_completion",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.trigger_reset_cancellations_on_completion()\n RETURNS trigger\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    -- When profile_mission state changes to 'completed', reset provider's consecutive cancellations\r\n    IF NEW.state = 'completed' AND (OLD.state IS NULL OR OLD.state != 'completed') THEN\r\n        PERFORM providers.reset_consecutive_on_completion(NEW.profile);\r\n    END IF;\r\n\r\n    RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_candidate_state",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_candidate_state(p_profile_mission_id uuid, p_new_state text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  updated_row missions.profile_missions;\r\nBEGIN\r\n  -- Validate state with new flow states\r\n  IF p_new_state NOT IN ('postule', 'accepted', 'confirmed', 'employer_signed', 'assigned', 'rejected', 'expired', 'completed') THEN\r\n    RETURN json_build_object('success', false, 'error', 'Invalid state');\r\n  END IF;\r\n\r\n  -- Update the state\r\n  UPDATE missions.profile_missions\r\n  SET state = p_new_state\r\n  WHERE id = p_profile_mission_id\r\n  RETURNING * INTO updated_row;\r\n\r\n  IF updated_row IS NULL THEN\r\n    RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n  END IF;\r\n\r\n  RETURN json_build_object(\r\n    'success', true,\r\n    'data', json_build_object(\r\n      'id', updated_row.id,\r\n      'state', updated_row.state\r\n    )\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_candidate_state_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_candidate_state_v2(p_profile_mission_id uuid, p_new_state text)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    updated_row missions.profile_missions;\r\n    v_mission_id UUID;\r\n    v_is_volunteer_multi BOOLEAN := false;\r\n    v_nb_participants INTEGER := 1;\r\n    v_occupied_before INTEGER := 0;\r\n    v_occupied_after INTEGER := 0;\r\n    v_rejected_count INTEGER := 0;\r\nBEGIN\r\n    IF p_new_state NOT IN ('postule', 'pending', 'sourced', 'accepted', 'confirmed', 'employer_signed', 'assigned', 'rejected', 'expired', 'completed') THEN\r\n        RETURN json_build_object('success', false, 'error', 'Invalid state');\r\n    END IF;\r\n\r\n    SELECT pm.mission\r\n    INTO v_mission_id\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_mission_id IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    SELECT\r\n        (m.benevole = true AND COALESCE(m.nb_participants, 1) > 1),\r\n        COALESCE(m.nb_participants, 1)\r\n    INTO v_is_volunteer_multi, v_nb_participants\r\n    FROM missions.missions m\r\n    WHERE m.id = v_mission_id;\r\n\r\n    IF v_is_volunteer_multi AND p_new_state IN ('confirmed', 'employer_signed', 'assigned', 'completed') THEN\r\n        SELECT COUNT(*)\r\n        INTO v_occupied_before\r\n        FROM missions.profile_missions pm\r\n        WHERE pm.mission = v_mission_id\r\n          AND pm.id <> p_profile_mission_id\r\n          AND pm.state IN ('confirmed', 'employer_signed', 'assigned', 'completed');\r\n\r\n        IF v_occupied_before >= v_nb_participants THEN\r\n            RETURN json_build_object('success', false, 'error', 'Tous les slots benevoles sont deja occupes');\r\n        END IF;\r\n    END IF;\r\n\r\n    UPDATE missions.profile_missions\r\n    SET state = p_new_state\r\n    WHERE id = p_profile_mission_id\r\n    RETURNING * INTO updated_row;\r\n\r\n    IF updated_row IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    IF v_is_volunteer_multi THEN\r\n        SELECT COUNT(*)\r\n        INTO v_occupied_after\r\n        FROM missions.profile_missions pm\r\n        WHERE pm.mission = v_mission_id\r\n          AND pm.state IN ('confirmed', 'employer_signed', 'assigned', 'completed');\r\n\r\n        IF v_occupied_after >= v_nb_participants THEN\r\n            WITH rejected AS (\r\n                UPDATE missions.profile_missions pm\r\n                SET state = 'rejected'\r\n                WHERE pm.mission = v_mission_id\r\n                  AND pm.id <> p_profile_mission_id\r\n                  AND pm.state IN ('postule', 'pending', 'sourced', 'accepted')\r\n                RETURNING 1\r\n            )\r\n            SELECT COUNT(*) INTO v_rejected_count FROM rejected;\r\n        END IF;\r\n    END IF;\r\n\r\n    RETURN json_build_object(\r\n        'success', true,\r\n        'data', json_build_object(\r\n            'id', updated_row.id,\r\n            'state', updated_row.state,\r\n            'rejected_count', v_rejected_count\r\n        )\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_contrats_timestamp",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_contrats_timestamp()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  NEW.updated_at = NOW();\r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_expired_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_expired_missions()\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  -- 1. Missions sans provider dont le début est passé -> unassigned\r\n  UPDATE missions.missions m\r\n  SET status = 'unassigned'\r\n  WHERE m.status = 'open'\r\n    AND m.start_time < NOW()\r\n    AND NOT EXISTS (\r\n      SELECT 1 FROM missions.profile_missions pm\r\n      WHERE pm.mission = m.id\r\n      AND pm.state IN ('assigned', 'accepted')\r\n    );\r\n\r\n  -- 2. Missions avec provider dont la fin est passée -> closed\r\n  UPDATE missions.missions m\r\n  SET status = 'closed'\r\n  WHERE m.status IN ('open', 'assigned')\r\n    AND m.end_time < NOW()\r\n    AND EXISTS (\r\n      SELECT 1 FROM missions.profile_missions pm\r\n      WHERE pm.mission = m.id\r\n      AND pm.state IN ('assigned', 'accepted')\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_invoices_updated_at",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_invoices_updated_at()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  NEW.updated_at = NOW();\r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_payment_intent",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_payment_intent(p_profile_mission_id uuid, p_payment_intent_id text, p_payment_status text, p_payment_amount numeric, p_commission_rate numeric, p_price_hour numeric, p_price_hour_supp numeric)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  UPDATE missions.profile_missions\r\n  SET\r\n    payment_intent_id = p_payment_intent_id,\r\n    payment_status = p_payment_status,\r\n    payment_amount = p_payment_amount,\r\n    commission_rate = p_commission_rate,\r\n    price_hour = COALESCE(p_price_hour, price_hour),\r\n    price_hour_supp = COALESCE(p_price_hour_supp, price_hour_supp)\r\n  WHERE id = p_profile_mission_id;\r\n\r\n  RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "update_payment_status_failed",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.update_payment_status_failed(p_profile_mission_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'missions', 'companies'\nAS $function$\r\nDECLARE\r\n    v_pm RECORD;\r\nBEGIN\r\n    -- Recuperer le profile_mission\r\n    SELECT * INTO v_pm FROM missions.profile_missions WHERE id = p_profile_mission_id;\r\n\r\n    IF v_pm IS NULL THEN\r\n        RETURN false;\r\n    END IF;\r\n\r\n    -- Verifier l'autorisation : seule la company owner de la mission peut marquer le paiement comme echoue\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM missions.missions m\r\n        JOIN companies.companies c ON c.id = m.company_id\r\n        WHERE m.id = v_pm.mission\r\n        AND c.profile = auth.uid()\r\n    ) THEN\r\n        RETURN false;\r\n    END IF;\r\n\r\n    -- Limiter aux transitions valides : seul un paiement 'pending' peut devenir 'failed'\r\n    IF v_pm.payment_status IS DISTINCT FROM 'pending' THEN\r\n        RETURN false;\r\n    END IF;\r\n\r\n    UPDATE missions.profile_missions\r\n    SET\r\n        payment_status = 'failed',\r\n        updated_at = NOW()\r\n    WHERE id = p_profile_mission_id;\r\n\r\n    RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "missions",
        "object_name": "validate_mission_report",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION missions.validate_mission_report(p_profile_mission_id uuid, p_approved boolean, p_dispute_reason text DEFAULT NULL::text, p_dispute_description text DEFAULT NULL::text, p_counter_hours_worked numeric DEFAULT NULL::numeric, p_counter_hours_supp numeric DEFAULT NULL::numeric)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_profile_mission RECORD;\r\n    v_dispute_id UUID;\r\nBEGIN\r\n    SELECT pm.*, m.benevole\r\n    INTO v_profile_mission\r\n    FROM missions.profile_missions pm\r\n    JOIN missions.missions m ON m.id = pm.mission\r\n    WHERE pm.id = p_profile_mission_id;\r\n\r\n    IF v_profile_mission IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Profile mission not found');\r\n    END IF;\r\n\r\n    IF v_profile_mission.profile != auth.uid() THEN\r\n        RETURN json_build_object('success', false, 'error', 'Not authorized - must be provider');\r\n    END IF;\r\n\r\n    IF v_profile_mission.report_submitted_at IS NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'No report submitted yet');\r\n    END IF;\r\n\r\n    IF v_profile_mission.provider_validated_at IS NOT NULL THEN\r\n        RETURN json_build_object('success', false, 'error', 'Report already validated');\r\n    END IF;\r\n\r\n    IF p_approved THEN\r\n        UPDATE missions.profile_missions\r\n        SET\r\n            provider_validated_at = NOW(),\r\n            provider_validation_status = 'approved'\r\n        WHERE id = p_profile_mission_id;\r\n\r\n        RETURN json_build_object(\r\n            'success', true,\r\n            'status', 'approved',\r\n            'profile_mission_id', p_profile_mission_id,\r\n            'can_capture_payment', true\r\n        );\r\n    ELSE\r\n        IF p_dispute_reason IS NULL OR p_dispute_description IS NULL THEN\r\n            RETURN json_build_object('success', false, 'error', 'Dispute reason and description required');\r\n        END IF;\r\n\r\n        INSERT INTO missions.disputes (\r\n            profile_mission,\r\n            opened_by,\r\n            opened_by_profile,\r\n            reason,\r\n            description,\r\n            disputed_hours_worked,\r\n            disputed_hours_supp,\r\n            status\r\n        ) VALUES (\r\n            p_profile_mission_id,\r\n            'provider',\r\n            auth.uid(),\r\n            p_dispute_reason,\r\n            p_dispute_description,\r\n            p_counter_hours_worked,\r\n            p_counter_hours_supp,\r\n            'pending'\r\n        )\r\n        RETURNING id INTO v_dispute_id;\r\n\r\n        UPDATE missions.profile_missions\r\n        SET\r\n            provider_validated_at = NOW(),\r\n            provider_validation_status = 'disputed'\r\n        WHERE id = p_profile_mission_id;\r\n\r\n        RETURN json_build_object(\r\n            'success', true,\r\n            'status', 'disputed',\r\n            'dispute_id', v_dispute_id,\r\n            'profile_mission_id', p_profile_mission_id\r\n        );\r\n    END IF;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "apply_cancellation_sanction",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.apply_cancellation_sanction(p_provider_id uuid, p_profile_mission_id uuid, p_mission_id uuid, p_hours_before_start numeric, p_contract_fully_signed boolean, p_reason text)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_provider RECORD;\r\n    v_consecutive INTEGER;\r\n    v_new_status TEXT;\r\n    v_suspension_expires TIMESTAMPTZ;\r\n    v_sanction_applied TEXT;\r\n    v_warning_message TEXT;\r\nBEGIN\r\n    -- Get current provider state\r\n    SELECT * INTO v_provider\r\n    FROM providers.providers\r\n    WHERE id = p_provider_id;\r\n\r\n    -- Calculate consecutive cancellations\r\n    -- Reset if last successful mission was after last cancellation\r\n    IF v_provider.last_successful_mission_at IS NOT NULL\r\n       AND v_provider.last_cancellation_at IS NOT NULL\r\n       AND v_provider.last_successful_mission_at > v_provider.last_cancellation_at THEN\r\n        v_consecutive := 1; -- Reset, this is first cancellation after success\r\n    ELSE\r\n        v_consecutive := COALESCE(v_provider.consecutive_cancellations, 0) + 1;\r\n    END IF;\r\n\r\n    -- Determine sanction based on consecutive count\r\n    CASE v_consecutive\r\n        WHEN 1 THEN\r\n            v_new_status := 'warning_1';\r\n            v_sanction_applied := 'warning_1';\r\n            v_warning_message := 'Attention : annulation enregistrée. Les annulations répétées peuvent entraîner des restrictions sur votre compte.';\r\n        WHEN 2 THEN\r\n            v_new_status := 'warning_2';\r\n            v_sanction_applied := 'warning_2';\r\n            v_warning_message := 'Avertissement : 2ème annulation consécutive. Une prochaine annulation entraînera une suspension temporaire de votre compte.';\r\n        WHEN 3 THEN\r\n            v_new_status := 'suspended_7d';\r\n            v_suspension_expires := NOW() + INTERVAL '7 days';\r\n            v_sanction_applied := 'ban_7d';\r\n            v_warning_message := 'Votre compte est suspendu pour 7 jours suite à des annulations répétées.';\r\n        ELSE -- 4+\r\n            v_new_status := 'suspended_30d';\r\n            v_suspension_expires := NOW() + INTERVAL '30 days';\r\n            v_sanction_applied := 'ban_30d';\r\n            v_warning_message := 'Votre compte est suspendu pour 30 jours suite à des annulations répétées.';\r\n    END CASE;\r\n\r\n    -- Update provider record\r\n    UPDATE providers.providers\r\n    SET\r\n        consecutive_cancellations = v_consecutive,\r\n        total_cancellations = COALESCE(total_cancellations, 0) + 1,\r\n        last_cancellation_at = NOW(),\r\n        suspension_status = v_new_status,\r\n        suspension_expires_at = v_suspension_expires\r\n    WHERE id = p_provider_id;\r\n\r\n    -- Log the cancellation\r\n    INSERT INTO providers.cancellation_logs (\r\n        provider_id,\r\n        profile_mission_id,\r\n        mission_id,\r\n        hours_before_start,\r\n        contract_fully_signed,\r\n        reason,\r\n        sanction_applied,\r\n        sanction_applied_at\r\n    ) VALUES (\r\n        p_provider_id,\r\n        p_profile_mission_id,\r\n        p_mission_id,\r\n        p_hours_before_start,\r\n        p_contract_fully_signed,\r\n        p_reason,\r\n        v_sanction_applied,\r\n        NOW()\r\n    );\r\n\r\n    RETURN jsonb_build_object(\r\n        'consecutive_count', v_consecutive,\r\n        'sanction_applied', v_sanction_applied,\r\n        'suspension_expires', v_suspension_expires,\r\n        'warning_message', v_warning_message\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "can_provider_create_new_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.can_provider_create_new_mission(p_profile_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_status jsonb;\r\nBEGIN\r\n  v_status := providers.get_provider_legal_gate_status(p_profile_id);\r\n  RETURN COALESCE((v_status ->> 'can_create_new_missions')::BOOLEAN, FALSE);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "check_provider_profile_complete",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.check_provider_profile_complete(p_provider_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_provider RECORD;\r\n  v_is_complete BOOLEAN := TRUE;\r\n  v_missing_fields TEXT[] := ARRAY[]::TEXT[];\r\nBEGIN\r\n  SELECT *\r\n  INTO v_provider\r\n  FROM providers.providers\r\n  WHERE id = p_provider_id;\r\n\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'is_complete', false,\r\n      'missing_fields', ARRAY['provider_not_found']::TEXT[]\r\n    );\r\n  END IF;\r\n\r\n  IF v_provider.verified IS NOT TRUE THEN\r\n    v_is_complete := FALSE;\r\n    v_missing_fields := array_append(v_missing_fields, 'verified');\r\n  END IF;\r\n\r\n  IF UPPER(COALESCE(v_provider.situation, '')) = 'INDEPENDANT' THEN\r\n    IF (\r\n      (v_provider.siret IS NULL OR v_provider.siret = '')\r\n      AND v_provider.siret_enc IS NULL\r\n    ) THEN\r\n      v_is_complete := FALSE;\r\n      v_missing_fields := array_append(v_missing_fields, 'siret');\r\n    END IF;\r\n\r\n    IF v_provider.adresse_facturation IS NULL AND v_provider.adresse_facturation_enc IS NULL THEN\r\n      v_is_complete := FALSE;\r\n      v_missing_fields := array_append(v_missing_fields, 'adresse_facturation');\r\n    END IF;\r\n\r\n    IF v_provider.regime_tva IS NULL THEN\r\n      v_is_complete := FALSE;\r\n      v_missing_fields := array_append(v_missing_fields, 'regime_tva');\r\n    END IF;\r\n  END IF;\r\n\r\n  RETURN jsonb_build_object(\r\n    'is_complete', v_is_complete,\r\n    'missing_fields', v_missing_fields\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "create_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.create_availability(p_provider uuid, p_start_time time without time zone, p_end_time time without time zone, p_type text, p_note text, p_is_recurring boolean, p_weekdays integer[], p_start_date date, p_end_date date DEFAULT NULL::date)\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_availability_id UUID;\r\nBEGIN\r\n  INSERT INTO providers.availabilities (\r\n    provider,\r\n    start_time,\r\n    end_time,\r\n    type,\r\n    note,\r\n    is_recurring,\r\n    weekdays,\r\n    start_date,\r\n    end_date\r\n  ) VALUES (\r\n    p_provider,\r\n    p_start_time,\r\n    p_end_time,\r\n    p_type,\r\n    p_note,\r\n    p_is_recurring,\r\n    p_weekdays,\r\n    p_start_date,\r\n    p_end_date\r\n  )\r\n  RETURNING id INTO v_availability_id;\r\n\r\n  RETURN v_availability_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "delete_all_provider_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.delete_all_provider_availabilities(p_provider_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'providers'\nAS $function$\r\nDECLARE\r\n    deleted_count INTEGER;\r\nBEGIN\r\n    -- Verifier que le provider appartient a l'appelant\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM providers.providers\r\n        WHERE id = p_provider_id\r\n        AND profile = auth.uid()\r\n    ) THEN\r\n        RETURN 0;\r\n    END IF;\r\n\r\n    DELETE FROM providers.availabilities\r\n    WHERE provider = p_provider_id;\r\n\r\n    GET DIAGNOSTICS deleted_count = ROW_COUNT;\r\n    RETURN deleted_count;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "delete_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.delete_availability(p_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'providers'\nAS $function$\r\nDECLARE\r\n    v_avail RECORD;\r\nBEGIN\r\n    -- Recuperer l'availability et verifier l'ownership\r\n    SELECT a.* INTO v_avail\r\n    FROM providers.availabilities a\r\n    JOIN providers.providers p ON p.id = a.provider\r\n    WHERE a.id = p_id\r\n    AND p.profile = auth.uid();\r\n\r\n    IF v_avail IS NULL THEN\r\n        RETURN false;\r\n    END IF;\r\n\r\n    DELETE FROM providers.availabilities WHERE id = p_id;\r\n    RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "delete_google_synced_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.delete_google_synced_availabilities(p_provider_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'providers'\nAS $function$\r\nDECLARE\r\n    deleted_count INTEGER;\r\nBEGIN\r\n    -- Verifier que le provider appartient a l'appelant\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM providers.providers\r\n        WHERE id = p_provider_id\r\n        AND profile = auth.uid()\r\n    ) THEN\r\n        RETURN 0;\r\n    END IF;\r\n\r\n    DELETE FROM providers.availabilities\r\n    WHERE provider = p_provider_id\r\n    AND note = 'Synchronisé avec Google Calendar';\r\n\r\n    GET DIAGNOSTICS deleted_count = ROW_COUNT;\r\n    RETURN deleted_count;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "delete_provider_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.delete_provider_availabilities(p_provider_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'providers'\nAS $function$\r\nDECLARE\r\n    deleted_count INTEGER;\r\nBEGIN\r\n    -- Verifier que le provider appartient a l'appelant\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM providers.providers\r\n        WHERE id = p_provider_id\r\n        AND profile = auth.uid()\r\n    ) THEN\r\n        RETURN 0;\r\n    END IF;\r\n\r\n    DELETE FROM providers.availabilities\r\n    WHERE provider = p_provider_id;\r\n\r\n    GET DIAGNOSTICS deleted_count = ROW_COUNT;\r\n    RETURN deleted_count;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_all_independant_legal_statuses",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_all_independant_legal_statuses()\n RETURNS TABLE(profile_id uuid, legal_status jsonb)\n LANGUAGE sql\n SECURITY DEFINER\nAS $function$\r\n  WITH earnings AS (\r\n    SELECT\r\n      pm.profile,\r\n      ROUND(COALESCE(SUM(COALESCE(pm.amount_ht, 0)), 0), 2) AS cumulative_ht\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.payment_status = 'transferred'\r\n      AND COALESCE(pm.amount_ht, 0) > 0\r\n    GROUP BY pm.profile\r\n  ),\r\n  base AS (\r\n    SELECT\r\n      p.profile,\r\n      COALESCE(e.cumulative_ht, 0)                              AS cumulative_ht,\r\n      p.avis_situ_siren IS NOT NULL                             AS has_avis,\r\n      p.attestation_vigilance IS NOT NULL                       AS has_attest,\r\n      d.uploaded_at                                             AS attest_uploaded_at,\r\n      CASE WHEN d.uploaded_at IS NOT NULL\r\n           THEN d.uploaded_at + INTERVAL '6 months'\r\n           ELSE NULL\r\n      END                                                       AS attest_expires_at,\r\n      CASE WHEN d.uploaded_at IS NOT NULL\r\n           THEN (d.uploaded_at + INTERVAL '6 months') > NOW()\r\n           ELSE FALSE\r\n      END                                                       AS attest_valid\r\n    FROM providers.providers p\r\n    LEFT JOIN earnings e         ON e.profile = p.profile\r\n    LEFT JOIN public.documents d ON d.id = p.attestation_vigilance\r\n    WHERE UPPER(COALESCE(p.situation, '')) = 'INDEPENDANT'\r\n  )\r\n  SELECT\r\n    b.profile,\r\n    jsonb_build_object(\r\n      'cumulative_ht',             b.cumulative_ht,\r\n      'warning_threshold_ht',      4500,\r\n      'block_threshold_ht',        5000,\r\n      'is_near_threshold',         b.cumulative_ht >= 4500 AND b.cumulative_ht < 5000,\r\n      'docs_required',             b.cumulative_ht >= 5000,\r\n      'has_avis_situ_siren',       b.has_avis,\r\n      'has_attestation_vigilance', b.has_attest,\r\n      'attestation_uploaded_at',   b.attest_uploaded_at,\r\n      'attestation_expires_at',    b.attest_expires_at,\r\n      'attestation_valid',         b.attest_valid,\r\n      'missing_requirements', TO_JSONB(ARRAY_REMOVE(ARRAY[\r\n        CASE WHEN b.cumulative_ht >= 5000 AND NOT b.has_avis\r\n             THEN 'avis_situ_siren' END,\r\n        CASE WHEN b.cumulative_ht >= 5000 AND NOT b.has_attest\r\n             THEN 'attestation_vigilance' END,\r\n        CASE WHEN b.cumulative_ht >= 5000 AND b.has_attest AND NOT b.attest_valid\r\n             THEN 'attestation_vigilance_expired' END\r\n      ], NULL)),\r\n      'can_create_new_missions',\r\n        b.cumulative_ht < 5000 OR (b.has_avis AND b.has_attest AND b.attest_valid)\r\n    )\r\n  FROM base b;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_candidate_profile",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_candidate_profile(p_profile_id uuid, p_mission_id uuid DEFAULT NULL::uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\n  DECLARE\r\n    v_result json;\r\n    v_company_id uuid;\r\n  BEGIN\r\n    -- Vérifier que l'utilisateur est une company\r\n    SELECT c.id INTO v_company_id\r\n    FROM companies.companies c\r\n    WHERE c.profile = auth.uid();\r\n\r\n    IF v_company_id IS NULL THEN\r\n      RETURN json_build_object('error', 'Not authorized - not a company');\r\n    END IF;\r\n\r\n    -- Si mission_id fourni, vérifier que la company possède cette mission\r\n    IF p_mission_id IS NOT NULL THEN\r\n      IF NOT EXISTS (\r\n        SELECT 1 FROM missions.missions m\r\n        WHERE m.id = p_mission_id AND m.company_id = v_company_id\r\n      ) THEN\r\n        RETURN json_build_object('error', 'Not authorized - not your mission');\r\n      END IF;\r\n    END IF;\r\n\r\n    -- Construire le résultat complet\r\n    SELECT json_build_object(\r\n      'profile', json_build_object(\r\n        'id', p.id,\r\n        'first_name', p.first_name,\r\n        'last_name', p.last_name,\r\n        'photo', p.photo,\r\n        'vehicule', p.vehicule,\r\n        'address', p.address,\r\n        'phone', p.phone,\r\n        'email', p.email\r\n      ),\r\n      'provider_info', (\r\n        SELECT json_build_object(\r\n          'id', prov.id,\r\n          'bio', prov.more,\r\n          'is_verified', prov.verified,\r\n          'zone_intervention_cp', prov.zone_intervention_cp,\r\n          'zone_intervention_rayon', prov.zone_intervention_rayon,\r\n          'regime_tva', prov.regime_tva\r\n        )\r\n        FROM providers.providers prov\r\n        WHERE prov.profile = p_profile_id\r\n      ),\r\n      'jobs', (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', pj.id,\r\n            'job_id', pj.job,\r\n            'job_name', j.name,\r\n            'hourly_rate', pj.hourly_rate\r\n          )\r\n        ), '[]'::json)\r\n        FROM providers.provider_jobs pj\r\n        JOIN jobs.jobs j ON j.id = pj.job\r\n        JOIN providers.providers prov ON prov.id = pj.provider\r\n        WHERE prov.profile = p_profile_id\r\n      ),\r\n      'experiences', (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', e.id,\r\n            'intitule', e.intitule,\r\n            'description', e.description,\r\n            'company', e.company,\r\n            'start', e.start,\r\n            'end', e.\"end\"\r\n          ) ORDER BY e.start DESC\r\n        ), '[]'::json)\r\n        FROM (\r\n          SELECT * FROM providers.experiences exp\r\n          WHERE exp.profile = p_profile_id\r\n          ORDER BY exp.start DESC\r\n          LIMIT 3\r\n        ) e\r\n      ),\r\n      'diplomes', (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', d.id,\r\n            'intitule', d.intitule\r\n          )\r\n        ), '[]'::json)\r\n        FROM providers.diplomes d\r\n        WHERE d.profile = p_profile_id\r\n      ),\r\n      'recent_ratings', (\r\n        SELECT COALESCE(json_agg(\r\n          json_build_object(\r\n            'id', r.id,\r\n            'rate', r.rate,\r\n            'description', r.description,\r\n            'created_at', r.created_at,\r\n            'company_name', (SELECT c.nom_commercial FROM companies.companies c WHERE c.id = r.company)\r\n          ) ORDER BY r.created_at DESC\r\n        ), '[]'::json)\r\n        FROM (\r\n          SELECT rat.* FROM providers.ratings rat\r\n          JOIN providers.providers prov ON prov.id = rat.provider\r\n          WHERE prov.profile = p_profile_id\r\n          ORDER BY rat.created_at DESC\r\n          LIMIT 3\r\n        ) r\r\n      ),\r\n      'average_rating', (\r\n        SELECT COALESCE(ROUND(AVG(rat.rate)::numeric, 1), 0)\r\n        FROM providers.ratings rat\r\n        JOIN providers.providers prov ON prov.id = rat.provider\r\n        WHERE prov.profile = p_profile_id\r\n      ),\r\n      'ratings_count', (\r\n        SELECT COUNT(*)::int\r\n        FROM providers.ratings rat\r\n        JOIN providers.providers prov ON prov.id = rat.provider\r\n        WHERE prov.profile = p_profile_id\r\n      ),\r\n      'profile_mission', CASE WHEN p_mission_id IS NOT NULL THEN (\r\n        SELECT json_build_object(\r\n          'id', pm.id,\r\n          'mission', pm.mission,\r\n          'state', pm.state,\r\n          'price_hour', pm.price_hour,\r\n          'price_hour_supp', pm.price_hour_supp,\r\n          'created_at', pm.created_at\r\n        )\r\n        FROM missions.profile_missions pm\r\n        WHERE pm.mission = p_mission_id AND pm.profile = p_profile_id\r\n      ) ELSE NULL END,\r\n      'job_name', CASE WHEN p_mission_id IS NOT NULL THEN (\r\n        SELECT j.name\r\n        FROM missions.missions m\r\n        LEFT JOIN jobs.jobs j ON j.id = m.job\r\n        WHERE m.id = p_mission_id\r\n      ) ELSE NULL END\r\n    ) INTO v_result\r\n    FROM public.profiles p\r\n    WHERE p.id = p_profile_id;\r\n\r\n    IF v_result IS NULL THEN\r\n      RETURN json_build_object('error', 'Profile not found');\r\n    END IF;\r\n\r\n    RETURN v_result;\r\n  END;\r\n  $function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_candidate_profile_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_candidate_profile_v3(p_profile_id uuid, p_mission_id uuid DEFAULT NULL::uuid)\n RETURNS json\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_result JSON;\r\n    v_company_id UUID;\r\nBEGIN\r\n    SELECT c.id INTO v_company_id\r\n    FROM companies.companies c\r\n    WHERE c.profile = auth.uid();\r\n\r\n    IF v_company_id IS NULL THEN\r\n        RETURN json_build_object('error', 'Not authorized - not a company');\r\n    END IF;\r\n\r\n    IF p_mission_id IS NOT NULL THEN\r\n        IF NOT EXISTS (\r\n            SELECT 1 FROM missions.missions m\r\n            WHERE m.id = p_mission_id AND m.company_id = v_company_id\r\n        ) THEN\r\n            RETURN json_build_object('error', 'Not authorized - not your mission');\r\n        END IF;\r\n    END IF;\r\n\r\n    SELECT json_build_object(\r\n        'profile', json_build_object(\r\n            'id', p.id,\r\n            'first_name_enc', p.first_name_enc,\r\n            'last_name_enc', p.last_name_enc,\r\n            'photo', p.photo,\r\n            'vehicule', p.vehicule,\r\n            'address_enc', p.address_enc,\r\n            'phone_enc', p.phone_enc,\r\n            'email_enc', p.email_enc\r\n        ),\r\n        'provider_info', (\r\n            SELECT json_build_object(\r\n                'id', prov.id,\r\n                'bio', prov.more,\r\n                'is_verified', prov.verified,\r\n                'zone_intervention_cp', prov.zone_intervention_cp,\r\n                'zone_intervention_rayon', prov.zone_intervention_rayon\r\n            )\r\n            FROM providers.providers prov\r\n            WHERE prov.profile = p_profile_id\r\n        ),\r\n        'jobs', (\r\n            SELECT COALESCE(json_agg(\r\n                json_build_object(\r\n                    'id', pj.id,\r\n                    'job_id', pj.job,\r\n                    'job_name', j.name\r\n                )\r\n            ), '[]'::json)\r\n            FROM providers.provider_jobs pj\r\n            JOIN jobs.jobs j ON j.id = pj.job\r\n            JOIN providers.providers prov ON prov.id = pj.provider\r\n            WHERE prov.profile = p_profile_id\r\n        ),\r\n        'experiences', (\r\n            SELECT COALESCE(json_agg(\r\n                json_build_object(\r\n                    'id', e.id,\r\n                    'intitule', e.intitule,\r\n                    'company', e.company,\r\n                    'description', e.description,\r\n                    'start', e.start,\r\n                    'end', e.\"end\"\r\n                ) ORDER BY e.start DESC\r\n            ), '[]'::json)\r\n            FROM (\r\n                SELECT * FROM providers.experiences exp\r\n                WHERE exp.profile = p_profile_id\r\n                ORDER BY exp.start DESC\r\n                LIMIT 3\r\n            ) e\r\n        ),\r\n        'diplomes', (\r\n            SELECT COALESCE(json_agg(\r\n                json_build_object(\r\n                    'id', d.id,\r\n                    'intitule', d.intitule\r\n                )\r\n            ), '[]'::json)\r\n            FROM providers.diplomes d\r\n            WHERE d.profile = p_profile_id\r\n        ),\r\n        'recent_ratings', (\r\n            SELECT COALESCE(json_agg(\r\n                json_build_object(\r\n                    'id', r.id,\r\n                    'rate', r.rate,\r\n                    'description', r.description,\r\n                    'created_at', r.created_at,\r\n                    'company_name', (SELECT c.nom_commercial FROM companies.companies c WHERE c.id = r.company)\r\n                ) ORDER BY r.created_at DESC\r\n            ), '[]'::json)\r\n            FROM (\r\n                SELECT rat.* FROM providers.ratings rat\r\n                JOIN providers.providers prov ON prov.id = rat.provider\r\n                WHERE prov.profile = p_profile_id\r\n                ORDER BY rat.created_at DESC\r\n                LIMIT 3\r\n            ) r\r\n        ),\r\n        'average_rating', (\r\n            SELECT COALESCE(ROUND(AVG(rat.rate)::numeric, 1), 0)\r\n            FROM providers.ratings rat\r\n            JOIN providers.providers prov ON prov.id = rat.provider\r\n            WHERE prov.profile = p_profile_id\r\n        ),\r\n        'ratings_count', (\r\n            SELECT COUNT(*)::int\r\n            FROM providers.ratings rat\r\n            JOIN providers.providers prov ON prov.id = rat.provider\r\n            WHERE prov.profile = p_profile_id\r\n        ),\r\n        'profile_mission', CASE WHEN p_mission_id IS NOT NULL THEN (\r\n            SELECT json_build_object(\r\n                'id', pm.id,\r\n                'state', pm.state,\r\n                'price_hour', pm.price_hour,\r\n                'price_hour_supp', pm.price_hour_supp,\r\n                'created_at', pm.created_at\r\n            )\r\n            FROM missions.profile_missions pm\r\n            WHERE pm.mission = p_mission_id AND pm.profile = p_profile_id\r\n        ) ELSE NULL END,\r\n        'job_name', CASE WHEN p_mission_id IS NOT NULL THEN (\r\n            SELECT j.name\r\n            FROM missions.missions m\r\n            LEFT JOIN jobs.jobs j ON j.id = m.job\r\n            WHERE m.id = p_mission_id\r\n        ) ELSE NULL END\r\n    ) INTO v_result\r\n    FROM public.profiles p\r\n    WHERE p.id = p_profile_id;\r\n\r\n    IF v_result IS NULL THEN\r\n        RETURN json_build_object('error', 'Profile not found');\r\n    END IF;\r\n\r\n    RETURN v_result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_availabilities(provider_id uuid)\n RETURNS TABLE(id uuid, created_at timestamp with time zone, updated_at timestamp with time zone, provider uuid, start_date date, end_date date, start_time time without time zone, end_time time without time zone, weekdays integer[], type text, is_recurring boolean, note text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    a.id,\r\n    a.created_at,\r\n    a.updated_at,\r\n    a.provider,\r\n    a.start_date,\r\n    a.end_date,\r\n    a.start_time,\r\n    a.end_time,\r\n    a.weekdays,  -- PostgreSQL retournera automatiquement le tableau d'entiers\r\n    a.type,\r\n    a.is_recurring,\r\n    a.note\r\n  FROM providers.availabilities a\r\n  WHERE a.provider = provider_id\r\n  ORDER BY a.start_date ASC, a.start_time ASC;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_current_week_earnings",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_current_week_earnings(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_total_earnings NUMERIC := 0;\r\n  v_mission_count INTEGER := 0;\r\n  v_mission RECORD;\r\n  v_week_start DATE;\r\nBEGIN\r\n  -- Début de la semaine courante (lundi)\r\n  v_week_start := DATE_TRUNC('week', CURRENT_DATE)::DATE;\r\n\r\n  FOR v_mission IN\r\n    SELECT\r\n      pm.amount_ttc_provider,\r\n      pm.payment_amount,\r\n      pm.payment_captured_at,\r\n      pm.provider_paid_on_cancel,\r\n      pm.state as pm_state\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND (\r\n        -- Missions transférées\r\n        (\r\n          pm.payment_status = 'transferred'\r\n          AND pm.amount_ttc_provider > 0\r\n          AND pm.payment_captured_at >= v_week_start\r\n        )\r\n        OR\r\n        -- Missions annulées payées\r\n        (\r\n          pm.state = 'canceled'\r\n          AND pm.provider_paid_on_cancel = TRUE\r\n          AND pm.payment_amount > 0\r\n          AND pm.payment_captured_at >= v_week_start\r\n        )\r\n      )\r\n  LOOP\r\n    IF v_mission.pm_state = 'canceled' AND v_mission.payment_amount > 0 THEN\r\n      v_total_earnings := v_total_earnings + v_mission.payment_amount;\r\n    ELSE\r\n      v_total_earnings := v_total_earnings + COALESCE(v_mission.amount_ttc_provider, 0);\r\n    END IF;\r\n\r\n    v_mission_count := v_mission_count + 1;\r\n  END LOOP;\r\n\r\n  RETURN jsonb_build_object(\r\n    'total_earnings', ROUND(v_total_earnings, 2),\r\n    'mission_count', v_mission_count,\r\n    'period', 'current_week'\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_daily_earnings_last_7days",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_daily_earnings_last_7days(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_daily_earnings JSONB;\r\nBEGIN\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'date', day_date,\r\n      'day_name', TO_CHAR(day_date, 'Day'),\r\n      'earnings', ROUND(COALESCE(day_earnings, 0), 2)\r\n    )\r\n    ORDER BY day_date\r\n  )\r\n  INTO v_daily_earnings\r\n  FROM (\r\n    SELECT\r\n      d.day_date::date as day_date,\r\n      COALESCE(SUM(\r\n        CASE\r\n          WHEN pm.state = 'canceled' AND pm.payment_amount > 0 THEN pm.payment_amount\r\n          ELSE COALESCE(pm.amount_ttc_provider, 0)\r\n        END\r\n      ), 0) as day_earnings\r\n    FROM generate_series(\r\n      CURRENT_DATE - INTERVAL '6 days',\r\n      CURRENT_DATE,\r\n      INTERVAL '1 day'\r\n    ) AS d(day_date)\r\n    LEFT JOIN missions.profile_missions pm\r\n      ON (pm.payment_captured_at AT TIME ZONE 'Europe/Paris')::date = d.day_date::date\r\n      AND pm.profile = p_profile_id\r\n      AND (\r\n        (pm.payment_status = 'transferred' AND pm.amount_ttc_provider > 0)\r\n        OR\r\n        (pm.state = 'canceled' AND pm.provider_paid_on_cancel = TRUE AND pm.payment_amount > 0)\r\n      )\r\n    GROUP BY d.day_date::date\r\n  ) daily_data;\r\n\r\n  RETURN COALESCE(v_daily_earnings, '[]'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_legal_gate_status",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_legal_gate_status(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_provider RECORD;\r\n  v_cumulative_ht NUMERIC := 0;\r\n  v_warning_threshold_ht NUMERIC := 4500;\r\n  v_block_threshold_ht NUMERIC := 5000;\r\n  v_is_independant BOOLEAN := FALSE;\r\n  v_docs_required BOOLEAN := FALSE;\r\n  v_has_avis_situ_siren BOOLEAN := FALSE;\r\n  v_has_attestation_vigilance BOOLEAN := FALSE;\r\n  v_attestation_uploaded_at TIMESTAMP WITHOUT TIME ZONE := NULL;\r\n  v_attestation_expires_at TIMESTAMP WITHOUT TIME ZONE := NULL;\r\n  v_attestation_valid BOOLEAN := FALSE;\r\n  v_missing_requirements TEXT[] := ARRAY[]::TEXT[];\r\n  v_can_create_new_missions BOOLEAN := TRUE;\r\nBEGIN\r\n  SELECT p.*\r\n  INTO v_provider\r\n  FROM providers.providers p\r\n  WHERE p.profile = p_profile_id;\r\n\r\n  IF NOT FOUND THEN\r\n    RETURN jsonb_build_object(\r\n      'cumulative_ht', 0,\r\n      'warning_threshold_ht', v_warning_threshold_ht,\r\n      'block_threshold_ht', v_block_threshold_ht,\r\n      'is_near_threshold', false,\r\n      'docs_required', false,\r\n      'has_avis_situ_siren', false,\r\n      'has_attestation_vigilance', false,\r\n      'attestation_uploaded_at', NULL,\r\n      'attestation_expires_at', NULL,\r\n      'attestation_valid', false,\r\n      'missing_requirements', ARRAY['provider_not_found']::TEXT[],\r\n      'can_create_new_missions', false\r\n    );\r\n  END IF;\r\n\r\n  v_is_independant := UPPER(COALESCE(v_provider.situation, '')) = 'INDEPENDANT';\r\n  v_has_avis_situ_siren := v_provider.avis_situ_siren IS NOT NULL;\r\n  v_has_attestation_vigilance := v_provider.attestation_vigilance IS NOT NULL;\r\n\r\n  SELECT COALESCE(SUM(COALESCE(pm.amount_ht, 0)), 0)\r\n  INTO v_cumulative_ht\r\n  FROM missions.profile_missions pm\r\n  WHERE pm.profile = p_profile_id\r\n    AND pm.payment_status = 'transferred'\r\n    AND COALESCE(pm.amount_ht, 0) > 0;\r\n\r\n  IF v_has_attestation_vigilance THEN\r\n    SELECT d.uploaded_at\r\n    INTO v_attestation_uploaded_at\r\n    FROM public.documents d\r\n    WHERE d.id = v_provider.attestation_vigilance;\r\n\r\n    IF v_attestation_uploaded_at IS NOT NULL THEN\r\n      v_attestation_expires_at := v_attestation_uploaded_at + INTERVAL '6 months';\r\n      v_attestation_valid := v_attestation_expires_at > NOW();\r\n    END IF;\r\n  END IF;\r\n\r\n  v_docs_required := v_is_independant AND v_cumulative_ht >= v_block_threshold_ht;\r\n\r\n  IF v_docs_required THEN\r\n    IF NOT v_has_avis_situ_siren THEN\r\n      v_missing_requirements := array_append(v_missing_requirements, 'avis_situ_siren');\r\n    END IF;\r\n\r\n    IF NOT v_has_attestation_vigilance THEN\r\n      v_missing_requirements := array_append(v_missing_requirements, 'attestation_vigilance');\r\n    ELSIF NOT v_attestation_valid THEN\r\n      v_missing_requirements := array_append(v_missing_requirements, 'attestation_vigilance_expired');\r\n    END IF;\r\n  END IF;\r\n\r\n  v_can_create_new_missions := NOT v_docs_required OR COALESCE(array_length(v_missing_requirements, 1), 0) = 0;\r\n\r\n  RETURN jsonb_build_object(\r\n    'cumulative_ht', ROUND(v_cumulative_ht, 2),\r\n    'warning_threshold_ht', v_warning_threshold_ht,\r\n    'block_threshold_ht', v_block_threshold_ht,\r\n    'is_near_threshold', (v_is_independant AND v_cumulative_ht >= v_warning_threshold_ht AND v_cumulative_ht < v_block_threshold_ht),\r\n    'docs_required', v_docs_required,\r\n    'has_avis_situ_siren', v_has_avis_situ_siren,\r\n    'has_attestation_vigilance', v_has_attestation_vigilance,\r\n    'attestation_uploaded_at', v_attestation_uploaded_at,\r\n    'attestation_expires_at', v_attestation_expires_at,\r\n    'attestation_valid', v_attestation_valid,\r\n    'missing_requirements', v_missing_requirements,\r\n    'can_create_new_missions', v_can_create_new_missions\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_monthly_earnings_6months",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_monthly_earnings_6months(p_profile_id uuid)\n RETURNS TABLE(month_start date, month_number integer, earnings numeric)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  WITH months AS (\r\n    SELECT generate_series(\r\n      DATE_TRUNC('month', CURRENT_DATE - INTERVAL '5 months')::DATE,\r\n      DATE_TRUNC('month', CURRENT_DATE)::DATE,\r\n      INTERVAL '1 month'\r\n    )::DATE AS month_start_date\r\n  ),\r\n  mission_earnings AS (\r\n    -- Missions transférées\r\n    SELECT\r\n      DATE_TRUNC('month', (pm.payment_captured_at AT TIME ZONE 'Europe/Paris'))::DATE as month_date,\r\n      COALESCE(pm.amount_ttc_provider, 0) as amount\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.payment_status = 'transferred'\r\n      AND pm.amount_ttc_provider > 0\r\n      AND pm.payment_captured_at >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '5 months')\r\n\r\n    UNION ALL\r\n\r\n    -- Missions annulées payées\r\n    SELECT\r\n      DATE_TRUNC('month', (pm.payment_captured_at AT TIME ZONE 'Europe/Paris'))::DATE as month_date,\r\n      ROUND(pm.payment_amount, 2) as amount\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.state = 'canceled'\r\n      AND pm.provider_paid_on_cancel = TRUE\r\n      AND pm.payment_amount > 0\r\n      AND pm.payment_captured_at >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '5 months')\r\n  )\r\n  SELECT\r\n    mo.month_start_date as month_start,\r\n    EXTRACT(MONTH FROM mo.month_start_date)::INTEGER as month_number,\r\n    COALESCE(SUM(me.amount), 0) as earnings\r\n  FROM months mo\r\n  LEFT JOIN mission_earnings me ON mo.month_start_date = me.month_date\r\n  GROUP BY mo.month_start_date\r\n  ORDER BY mo.month_start_date;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_paid_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_paid_missions(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_missions JSONB;\r\nBEGIN\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'mission_id', sub.mission_id,\r\n      'date', sub.payment_date,\r\n      'company_name', sub.company_name,\r\n      'amount', sub.amount,\r\n      'month', sub.month,\r\n      'month_number', sub.month_number,\r\n      'year', sub.year,\r\n      'is_canceled_payment', sub.is_canceled_payment\r\n    )\r\n    ORDER BY sub.payment_date DESC\r\n  )\r\n  INTO v_missions\r\n  FROM (\r\n    -- Missions transférées (payées normalement)\r\n    SELECT\r\n      m.id as mission_id,\r\n      pm.payment_captured_at as payment_date,\r\n      c.nom_commercial as company_name,\r\n      ROUND(COALESCE(pm.amount_ttc_provider, 0), 2) as amount,\r\n      TO_CHAR(pm.payment_captured_at AT TIME ZONE 'Europe/Paris', 'YYYY-MM') as month,\r\n      EXTRACT(MONTH FROM pm.payment_captured_at AT TIME ZONE 'Europe/Paris')::INTEGER as month_number,\r\n      EXTRACT(YEAR FROM pm.payment_captured_at AT TIME ZONE 'Europe/Paris')::INTEGER as year,\r\n      FALSE as is_canceled_payment\r\n    FROM missions.profile_missions pm\r\n    INNER JOIN missions.missions m ON pm.mission = m.id\r\n    LEFT JOIN companies.companies c ON m.company_id = c.id\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.payment_status = 'transferred'\r\n      AND pm.amount_ttc_provider > 0\r\n      AND pm.payment_captured_at IS NOT NULL\r\n\r\n    UNION ALL\r\n\r\n    -- Missions annulées où le provider a été payé\r\n    SELECT\r\n      m.id as mission_id,\r\n      pm.payment_captured_at as payment_date,\r\n      c.nom_commercial as company_name,\r\n      ROUND(pm.payment_amount, 2) as amount,\r\n      TO_CHAR(pm.payment_captured_at AT TIME ZONE 'Europe/Paris', 'YYYY-MM') as month,\r\n      EXTRACT(MONTH FROM pm.payment_captured_at AT TIME ZONE 'Europe/Paris')::INTEGER as month_number,\r\n      EXTRACT(YEAR FROM pm.payment_captured_at AT TIME ZONE 'Europe/Paris')::INTEGER as year,\r\n      TRUE as is_canceled_payment\r\n    FROM missions.profile_missions pm\r\n    INNER JOIN missions.missions m ON pm.mission = m.id\r\n    LEFT JOIN companies.companies c ON m.company_id = c.id\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.state = 'canceled'\r\n      AND pm.provider_paid_on_cancel = TRUE\r\n      AND pm.payment_amount > 0\r\n      AND pm.payment_captured_at IS NOT NULL\r\n  ) sub;\r\n\r\n  RETURN COALESCE(v_missions, '[]'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_previous_week_earnings",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_previous_week_earnings(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_total_earnings NUMERIC := 0;\r\n  v_mission_count INTEGER := 0;\r\n  v_mission RECORD;\r\n  v_prev_week_start DATE;\r\n  v_prev_week_end DATE;\r\nBEGIN\r\n  -- Semaine précédente : du lundi au dimanche\r\n  v_prev_week_start := (DATE_TRUNC('week', CURRENT_DATE) - INTERVAL '7 days')::DATE;\r\n  v_prev_week_end := DATE_TRUNC('week', CURRENT_DATE)::DATE;\r\n\r\n  FOR v_mission IN\r\n    SELECT\r\n      pm.amount_ttc_provider,\r\n      pm.payment_amount,\r\n      pm.payment_captured_at,\r\n      pm.provider_paid_on_cancel,\r\n      pm.state as pm_state\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND (\r\n        -- Missions transférées\r\n        (\r\n          pm.payment_status = 'transferred'\r\n          AND pm.amount_ttc_provider > 0\r\n          AND pm.payment_captured_at >= v_prev_week_start\r\n          AND pm.payment_captured_at < v_prev_week_end\r\n        )\r\n        OR\r\n        -- Missions annulées payées\r\n        (\r\n          pm.state = 'canceled'\r\n          AND pm.provider_paid_on_cancel = TRUE\r\n          AND pm.payment_amount > 0\r\n          AND pm.payment_captured_at >= v_prev_week_start\r\n          AND pm.payment_captured_at < v_prev_week_end\r\n        )\r\n      )\r\n  LOOP\r\n    IF v_mission.pm_state = 'canceled' AND v_mission.payment_amount > 0 THEN\r\n      v_total_earnings := v_total_earnings + v_mission.payment_amount;\r\n    ELSE\r\n      v_total_earnings := v_total_earnings + COALESCE(v_mission.amount_ttc_provider, 0);\r\n    END IF;\r\n\r\n    v_mission_count := v_mission_count + 1;\r\n  END LOOP;\r\n\r\n  RETURN jsonb_build_object(\r\n    'total_earnings', ROUND(v_total_earnings, 2),\r\n    'mission_count', v_mission_count\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_rating_summary",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_rating_summary(p_provider_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_avg_rating NUMERIC;\r\n  v_total_reviews INTEGER;\r\nBEGIN\r\n  -- Calculer la moyenne et le nombre total d'avis\r\n  SELECT \r\n    COALESCE(AVG(rate), 0),\r\n    COUNT(*)\r\n  INTO v_avg_rating, v_total_reviews\r\n  FROM providers.ratings\r\n  WHERE provider = p_provider_id;\r\n\r\n  -- Retourner le résultat\r\n  RETURN jsonb_build_object(\r\n    'average_rating', ROUND(v_avg_rating, 1),\r\n    'total_reviews', v_total_reviews\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_ratings",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_ratings(p_profile_id uuid, p_limit integer DEFAULT 10, p_offset integer DEFAULT 0)\n RETURNS json[]\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_provider_id uuid;\r\nBEGIN\r\n  -- Récupérer l'ID du provider\r\n  SELECT id INTO v_provider_id\r\n  FROM providers.providers\r\n  WHERE profile = p_profile_id;\r\n\r\n  IF v_provider_id IS NULL THEN\r\n    RETURN ARRAY[]::json[];\r\n  END IF;\r\n\r\n  -- Retourner les avis avec les noms des entreprises\r\n  RETURN ARRAY(\r\n    SELECT json_build_object(\r\n      'id', r.id,\r\n      'rate', r.rate,\r\n      'description', r.description,\r\n      'created_at', r.created_at,\r\n      'company_name', (SELECT c.nom_commercial FROM companies.companies c WHERE c.id = r.company)\r\n    )\r\n    FROM providers.ratings r\r\n    WHERE r.provider = v_provider_id\r\n    ORDER BY r.created_at DESC\r\n    LIMIT p_limit\r\n    OFFSET p_offset\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_reviews",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_reviews(p_provider_id uuid, p_limit integer DEFAULT 10, p_offset integer DEFAULT 0)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_reviews JSONB;\r\n  v_has_more BOOLEAN;\r\n  v_total_count INTEGER;\r\nBEGIN\r\n  -- Compter le total\r\n  SELECT COUNT(*) INTO v_total_count\r\n  FROM providers.ratings\r\n  WHERE provider = p_provider_id;\r\n\r\n  -- Vérifier s'il y a plus de résultats\r\n  v_has_more := (p_offset + p_limit) < v_total_count;\r\n\r\n  -- Récupérer les avis avec les infos des entreprises\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'id', r.id,\r\n      'rate', r.rate,\r\n      'description', r.description,\r\n      'created_at', r.created_at,\r\n      'company_id', r.company,\r\n      'company_name', c.nom_commercial,\r\n      'company_logo', c.logo\r\n    ) ORDER BY r.created_at DESC\r\n  )\r\n  INTO v_reviews\r\n  FROM providers.ratings r\r\n  LEFT JOIN companies.companies c ON r.company = c.id\r\n  WHERE r.provider = p_provider_id\r\n  ORDER BY r.created_at DESC\r\n  LIMIT p_limit\r\n  OFFSET p_offset;\r\n\r\n  -- Retourner le résultat\r\n  RETURN jsonb_build_object(\r\n    'reviews', COALESCE(v_reviews, '[]'::jsonb),\r\n    'has_more', v_has_more,\r\n    'total_count', v_total_count\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_upcoming_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_upcoming_missions(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_missions JSONB;\r\nBEGIN\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'mission_id', m.id,\r\n      'date', COALESCE(m.end_time, m.start_time),\r\n      'company_name', c.nom_commercial,\r\n      'amount', ROUND(\r\n        (\r\n          COALESCE(pm.price_hour, 0) * (\r\n            -- Use schedules if they exist, otherwise fall back to start/end time delta\r\n            COALESCE(\r\n              (\r\n                SELECT SUM(\r\n                  CASE\r\n                    WHEN ms.end_time > ms.start_time\r\n                      THEN EXTRACT(EPOCH FROM (ms.end_time - ms.start_time)) / 3600\r\n                    ELSE\r\n                      -- Overnight shift: add 24h\r\n                      EXTRACT(EPOCH FROM (ms.end_time - ms.start_time + interval '24 hours')) / 3600\r\n                  END\r\n                )\r\n                FROM missions.mission_schedules ms\r\n                WHERE ms.mission_id = m.id\r\n              ),\r\n              EXTRACT(EPOCH FROM (m.end_time - m.start_time)) / 3600\r\n            )\r\n          ) +\r\n          COALESCE(pm.price_hour_supp, 0) * COALESCE(m.hours_supp, 0)\r\n        ) * CASE WHEN prov.regime_tva = TRUE THEN 1.20 ELSE 1.0 END,\r\n        2\r\n      ),\r\n      'month', TO_CHAR(COALESCE(m.end_time, m.start_time) AT TIME ZONE 'Europe/Paris', 'YYYY-MM'),\r\n      'month_number', EXTRACT(MONTH FROM COALESCE(m.end_time, m.start_time) AT TIME ZONE 'Europe/Paris')::INTEGER,\r\n      'year', EXTRACT(YEAR FROM COALESCE(m.end_time, m.start_time) AT TIME ZONE 'Europe/Paris')::INTEGER,\r\n      'status', m.status\r\n    )\r\n    ORDER BY COALESCE(m.end_time, m.start_time) DESC\r\n  )\r\n  INTO v_missions\r\n  FROM missions.profile_missions pm\r\n  INNER JOIN missions.missions m ON pm.mission = m.id\r\n  LEFT JOIN companies.companies c ON m.company_id = c.id\r\n  LEFT JOIN providers.providers prov ON prov.id = pm.provider\r\n  WHERE pm.profile = p_profile_id\r\n    AND pm.state IN ('assigned', 'completed')\r\n    AND pm.payment_intent_id IS NOT NULL\r\n    AND pm.payment_status != 'transferred'\r\n    AND (m.end_time IS NOT NULL OR m.start_time IS NOT NULL);\r\n\r\n  RETURN COALESCE(v_missions, '[]'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_weekly_earnings",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_weekly_earnings(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_total_earnings NUMERIC := 0;\r\n  v_mission_count INTEGER := 0;\r\n  v_mission RECORD;\r\nBEGIN\r\n  FOR v_mission IN\r\n    SELECT\r\n      pm.amount_ttc_provider,\r\n      pm.payment_amount,\r\n      pm.payment_status,\r\n      pm.payment_captured_at,\r\n      pm.provider_paid_on_cancel,\r\n      pm.state as pm_state\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND (\r\n        -- Missions transférées (payées)\r\n        (\r\n          pm.payment_status = 'transferred'\r\n          AND pm.amount_ttc_provider > 0\r\n          AND pm.payment_captured_at >= (CURRENT_DATE - INTERVAL '7 days')\r\n        )\r\n        OR\r\n        -- Missions annulées où le provider a été payé\r\n        (\r\n          pm.state = 'canceled'\r\n          AND pm.provider_paid_on_cancel = TRUE\r\n          AND pm.payment_amount > 0\r\n          AND pm.payment_captured_at >= (CURRENT_DATE - INTERVAL '7 days')\r\n        )\r\n      )\r\n  LOOP\r\n    IF v_mission.pm_state = 'canceled' AND v_mission.payment_amount > 0 THEN\r\n      v_total_earnings := v_total_earnings + v_mission.payment_amount;\r\n    ELSE\r\n      v_total_earnings := v_total_earnings + COALESCE(v_mission.amount_ttc_provider, 0);\r\n    END IF;\r\n\r\n    v_mission_count := v_mission_count + 1;\r\n  END LOOP;\r\n\r\n  RETURN jsonb_build_object(\r\n    'total_earnings', ROUND(v_total_earnings, 2),\r\n    'mission_count', v_mission_count,\r\n    'period', 'last_7_days'\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_provider_weekly_earnings_last_4weeks",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_provider_weekly_earnings_last_4weeks(p_profile_id uuid)\n RETURNS TABLE(week_start date, earnings numeric)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  WITH weeks AS (\r\n    SELECT generate_series(\r\n      DATE_TRUNC('week', CURRENT_DATE - INTERVAL '3 weeks')::DATE,\r\n      DATE_TRUNC('week', CURRENT_DATE)::DATE,\r\n      INTERVAL '1 week'\r\n    )::DATE AS week_start_date\r\n  ),\r\n  mission_earnings AS (\r\n    -- Missions transférées\r\n    SELECT\r\n      DATE_TRUNC('week', (pm.payment_captured_at AT TIME ZONE 'Europe/Paris'))::DATE as week_date,\r\n      COALESCE(pm.amount_ttc_provider, 0) as amount\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.payment_status = 'transferred'\r\n      AND pm.amount_ttc_provider > 0\r\n      AND pm.payment_captured_at >= DATE_TRUNC('week', CURRENT_DATE - INTERVAL '3 weeks')\r\n\r\n    UNION ALL\r\n\r\n    -- Missions annulées payées\r\n    SELECT\r\n      DATE_TRUNC('week', (pm.payment_captured_at AT TIME ZONE 'Europe/Paris'))::DATE as week_date,\r\n      ROUND(pm.payment_amount, 2) as amount\r\n    FROM missions.profile_missions pm\r\n    WHERE pm.profile = p_profile_id\r\n      AND pm.state = 'canceled'\r\n      AND pm.provider_paid_on_cancel = TRUE\r\n      AND pm.payment_amount > 0\r\n      AND pm.payment_captured_at >= DATE_TRUNC('week', CURRENT_DATE - INTERVAL '3 weeks')\r\n  )\r\n  SELECT\r\n    w.week_start_date as week_start,\r\n    COALESCE(SUM(me.amount), 0) as earnings\r\n  FROM weeks w\r\n  LEFT JOIN mission_earnings me ON w.week_start_date = me.week_date\r\n  GROUP BY w.week_start_date\r\n  ORDER BY w.week_start_date;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "get_sanctions_status",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.get_sanctions_status(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_provider RECORD;\r\n    v_recent_cancellations JSONB;\r\nBEGIN\r\n    -- Get provider data\r\n    SELECT * INTO v_provider\r\n    FROM providers.providers\r\n    WHERE profile = p_profile_id;\r\n\r\n    IF NOT FOUND THEN\r\n        RETURN jsonb_build_object('success', false, 'error', 'Provider not found');\r\n    END IF;\r\n\r\n    -- Get recent cancellation logs (last 3)\r\n    SELECT COALESCE(jsonb_agg(row_to_json(cl) ORDER BY cl.canceled_at DESC), '[]'::jsonb)\r\n    INTO v_recent_cancellations\r\n    FROM (\r\n        SELECT\r\n            cl.canceled_at,\r\n            cl.hours_before_start,\r\n            cl.sanction_applied,\r\n            m.title AS mission_title\r\n        FROM providers.cancellation_logs cl\r\n        JOIN missions.missions m ON m.id = cl.mission_id\r\n        WHERE cl.provider_id = v_provider.id\r\n        ORDER BY cl.canceled_at DESC\r\n        LIMIT 3\r\n    ) cl;\r\n\r\n    RETURN jsonb_build_object(\r\n        'success', true,\r\n        'consecutive_cancellations', COALESCE(v_provider.consecutive_cancellations, 0),\r\n        'total_cancellations', COALESCE(v_provider.total_cancellations, 0),\r\n        'suspension_status', v_provider.suspension_status,\r\n        'suspension_expires_at', v_provider.suspension_expires_at,\r\n        'is_suspended', (\r\n            v_provider.suspension_status IN ('suspended_7d', 'suspended_30d', 'banned')\r\n            AND (v_provider.suspension_expires_at IS NULL OR v_provider.suspension_expires_at > NOW())\r\n        ),\r\n        'recent_cancellations', v_recent_cancellations\r\n    );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "reorder_portfolio",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.reorder_portfolio(p_provider_id uuid, p_ordered_ids uuid[])\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    i INTEGER;\r\n    photo_id UUID;\r\nBEGIN\r\n    -- Vérifier que l'utilisateur est bien le propriétaire du provider\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM providers.providers p\r\n        WHERE p.id = p_provider_id\r\n        AND p.profile = auth.uid()\r\n    ) THEN\r\n        RAISE EXCEPTION 'Non autorisé';\r\n    END IF;\r\n\r\n    -- Mettre à jour la position de chaque photo\r\n    FOR i IN 1..array_length(p_ordered_ids, 1)\r\n    LOOP\r\n        photo_id := p_ordered_ids[i];\r\n        UPDATE providers.provider_portfolio\r\n        SET position = i - 1\r\n        WHERE id = photo_id\r\n        AND provider_id = p_provider_id;\r\n    END LOOP;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "reset_consecutive_on_completion",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.reset_consecutive_on_completion(p_profile_id uuid)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    UPDATE providers.providers\r\n    SET\r\n        consecutive_cancellations = 0,\r\n        last_successful_mission_at = NOW(),\r\n        -- Clear warning status after successful mission\r\n        suspension_status = CASE\r\n            WHEN suspension_status IN ('warning_1', 'warning_2') THEN NULL\r\n            ELSE suspension_status\r\n        END\r\n    WHERE profile = p_profile_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "set_email_alert_preferences",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.set_email_alert_preferences(p_accept_all boolean DEFAULT NULL::boolean, p_alerts jsonb DEFAULT NULL::jsonb)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'providers', 'public'\nAS $function$\r\nDECLARE\r\n  v_profile_id UUID := auth.uid();\r\n  v_current JSONB;\r\n  v_result JSONB;\r\nBEGIN\r\n  IF v_profile_id IS NULL THEN\r\n    RAISE EXCEPTION 'Utilisateur non authentifie';\r\n  END IF;\r\n\r\n  IF p_accept_all IS NULL AND p_alerts IS NULL THEN\r\n    RAISE EXCEPTION 'Parametres invalides';\r\n  END IF;\r\n\r\n  SELECT accept_emails_alert\r\n  INTO v_current\r\n  FROM providers.providers\r\n  WHERE profile = v_profile_id\r\n  FOR UPDATE;\r\n\r\n  IF NOT FOUND THEN\r\n    RAISE EXCEPTION 'Prestataire introuvable';\r\n  END IF;\r\n\r\n  IF p_accept_all IS NOT NULL THEN\r\n    v_result := jsonb_build_object(\r\n      'mission_posted', p_accept_all,\r\n      'application_accepted', p_accept_all,\r\n      'contract_company_signed', p_accept_all,\r\n      'mission_report_submitted', p_accept_all,\r\n      'legal_docs_threshold_warning', p_accept_all,\r\n      'legal_docs_attestation_expiring', p_accept_all,\r\n      'legal_docs_blocking_required', p_accept_all\r\n    );\r\n  ELSE\r\n    v_result := COALESCE(v_current, jsonb_build_object(\r\n      'mission_posted', false,\r\n      'application_accepted', false,\r\n      'contract_company_signed', false,\r\n      'mission_report_submitted', false,\r\n      'legal_docs_threshold_warning', false,\r\n      'legal_docs_attestation_expiring', false,\r\n      'legal_docs_blocking_required', false\r\n    ));\r\n  END IF;\r\n\r\n  IF p_alerts IS NOT NULL THEN\r\n    v_result := jsonb_build_object(\r\n      'mission_posted', CASE\r\n        WHEN jsonb_typeof(p_alerts->'mission_posted') = 'boolean'\r\n          THEN (p_alerts->>'mission_posted')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'mission_posted')::BOOLEAN, false)\r\n      END,\r\n      'application_accepted', CASE\r\n        WHEN jsonb_typeof(p_alerts->'application_accepted') = 'boolean'\r\n          THEN (p_alerts->>'application_accepted')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'application_accepted')::BOOLEAN, false)\r\n      END,\r\n      'contract_company_signed', CASE\r\n        WHEN jsonb_typeof(p_alerts->'contract_company_signed') = 'boolean'\r\n          THEN (p_alerts->>'contract_company_signed')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'contract_company_signed')::BOOLEAN, false)\r\n      END,\r\n      'mission_report_submitted', CASE\r\n        WHEN jsonb_typeof(p_alerts->'mission_report_submitted') = 'boolean'\r\n          THEN (p_alerts->>'mission_report_submitted')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'mission_report_submitted')::BOOLEAN, false)\r\n      END,\r\n      'legal_docs_threshold_warning', CASE\r\n        WHEN jsonb_typeof(p_alerts->'legal_docs_threshold_warning') = 'boolean'\r\n          THEN (p_alerts->>'legal_docs_threshold_warning')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'legal_docs_threshold_warning')::BOOLEAN, false)\r\n      END,\r\n      'legal_docs_attestation_expiring', CASE\r\n        WHEN jsonb_typeof(p_alerts->'legal_docs_attestation_expiring') = 'boolean'\r\n          THEN (p_alerts->>'legal_docs_attestation_expiring')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'legal_docs_attestation_expiring')::BOOLEAN, false)\r\n      END,\r\n      'legal_docs_blocking_required', CASE\r\n        WHEN jsonb_typeof(p_alerts->'legal_docs_blocking_required') = 'boolean'\r\n          THEN (p_alerts->>'legal_docs_blocking_required')::BOOLEAN\r\n        ELSE COALESCE((v_result->>'legal_docs_blocking_required')::BOOLEAN, false)\r\n      END\r\n    );\r\n  END IF;\r\n\r\n  UPDATE providers.providers\r\n  SET accept_emails_alert = v_result\r\n  WHERE profile = v_profile_id;\r\n\r\n  RETURN jsonb_build_object(\r\n    'success', true,\r\n    'accept_emails_alert', v_result\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "update_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.update_availability(p_id uuid, p_start_time time without time zone, p_end_time time without time zone, p_type text, p_note text, p_is_recurring boolean, p_weekdays integer[], p_start_date date, p_end_date date DEFAULT NULL::date)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  UPDATE providers.availabilities\r\n  SET\r\n    start_time = p_start_time,\r\n    end_time = p_end_time,\r\n    type = p_type,\r\n    note = p_note,\r\n    is_recurring = p_is_recurring,\r\n    weekdays = p_weekdays,\r\n    start_date = p_start_date,\r\n    end_date = p_end_date,\r\n    updated_at = NOW()\r\n  WHERE id = p_id;\r\n\r\n  RETURN FOUND;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "update_availability_timestamp",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.update_availability_timestamp()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nbegin\r\n  new.updated_at = now();\r\n  return new;\r\nend;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "update_google_tokens_updated_at",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.update_google_tokens_updated_at()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  NEW.updated_at = now();\r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "providers",
        "object_name": "update_user_experiences",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION providers.update_user_experiences(p_profile_id uuid, p_experiences jsonb)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  exp JSONB;\r\nBEGIN\r\n  -- Verify that the user is updating their own experiences\r\n  IF auth.uid() != p_profile_id THEN\r\n    RAISE EXCEPTION 'Unauthorized: You can only update your own experiences';\r\n  END IF;\r\n\r\n  -- Delete all existing experiences for this profile\r\n  DELETE FROM providers.experiences\r\n  WHERE profile = p_profile_id;\r\n\r\n  -- Insert new experiences\r\n  FOR exp IN SELECT * FROM jsonb_array_elements(p_experiences)\r\n  LOOP\r\n    INSERT INTO providers.experiences (\r\n      profile,\r\n      intitule,\r\n      start,\r\n      \"end\",\r\n      description,\r\n      provider_job\r\n    ) VALUES (\r\n      p_profile_id,\r\n      exp->>'intitule',\r\n      (exp->>'start')::date,\r\n      (exp->>'end')::date,\r\n      exp->>'description',\r\n      (exp->>'provider_job')::uuid\r\n    );\r\n  END LOOP;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "addauth",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.addauth(text)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n\tlockid alias for $1;\n\tokay boolean;\n\tmyrec record;\nBEGIN\n\t-- check to see if table exists\n\t--  if not, CREATE TEMP TABLE mylock (transid xid, lockcode text)\n\tokay := 'f';\n\tFOR myrec IN SELECT * FROM pg_class WHERE relname = 'temp_lock_have_table' LOOP\n\t\tokay := 't';\n\tEND LOOP;\n\tIF (okay <> 't') THEN\n\t\tCREATE TEMP TABLE temp_lock_have_table (transid xid, lockcode text);\n\t\t\t-- this will only work from pgsql7.4 up\n\t\t\t-- ON COMMIT DELETE ROWS;\n\tEND IF;\n\n\t--  INSERT INTO mylock VALUES ( $1)\n--\tEXECUTE 'INSERT INTO temp_lock_have_table VALUES ( '||\n--\t\tquote_literal(getTransactionID()) || ',' ||\n--\t\tquote_literal(lockid) ||')';\n\n\tINSERT INTO temp_lock_have_table VALUES (getTransactionID(), lockid);\n\n\tRETURN true::boolean;\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box(box3d)\n RETURNS box\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$BOX3D_to_BOX$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box(geometry)\n RETURNS box\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$LWGEOM_to_BOX$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2d(geometry)\n RETURNS box2d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$LWGEOM_to_BOX2D$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2d(box3d)\n RETURNS box2d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$BOX3D_to_BOX2D$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2d_in",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2d_in(cstring)\n RETURNS box2d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$BOX2D_in$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2d_out",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2d_out(box2d)\n RETURNS cstring\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$BOX2D_out$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2df_in",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2df_in(cstring)\n RETURNS box2df\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$box2df_in$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box2df_out",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box2df_out(box2df)\n RETURNS cstring\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$box2df_out$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box3d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box3d(geometry)\n RETURNS box3d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$LWGEOM_to_BOX3D$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box3d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box3d(box2d)\n RETURNS box3d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$BOX2D_to_BOX3D$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box3d_in",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box3d_in(cstring)\n RETURNS box3d\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$BOX3D_in$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box3d_out",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box3d_out(box3d)\n RETURNS cstring\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$BOX3D_out$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "box3dtobox",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.box3dtobox(box3d)\n RETURNS box\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$BOX3D_to_BOX$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "bytea",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.bytea(geography)\n RETURNS bytea\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$LWGEOM_to_bytea$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "bytea",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.bytea(geometry)\n RETURNS bytea\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$LWGEOM_to_bytea$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "check_and_increment_rate_limit",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.check_and_increment_rate_limit(p_namespace text, p_rate_key_hash text, p_max_requests integer, p_window_seconds integer)\n RETURNS TABLE(out_request_count integer, out_reset_at timestamp with time zone, out_allowed boolean)\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'public'\nAS $function$\r\nDECLARE\r\n  v_now TIMESTAMPTZ := NOW();\r\n  v_new_reset TIMESTAMPTZ := v_now + (p_window_seconds * INTERVAL '1 second');\r\n  v_count INTEGER;\r\n  v_reset_at TIMESTAMPTZ;\r\nBEGIN\r\n  INSERT INTO public.api_rate_limits (namespace, rate_key_hash, request_count, reset_at, updated_at)\r\n  VALUES (p_namespace, p_rate_key_hash, 1, v_new_reset, v_now)\r\n  ON CONFLICT (namespace, rate_key_hash)\r\n  DO UPDATE SET\r\n    request_count = CASE\r\n      WHEN api_rate_limits.reset_at <= v_now THEN 1\r\n      ELSE api_rate_limits.request_count + 1\r\n    END,\r\n    reset_at = CASE\r\n      WHEN api_rate_limits.reset_at <= v_now THEN v_new_reset\r\n      ELSE api_rate_limits.reset_at\r\n    END,\r\n    updated_at = v_now\r\n  RETURNING api_rate_limits.request_count, api_rate_limits.reset_at\r\n  INTO v_count, v_reset_at;\r\n\r\n  RETURN QUERY\r\n  SELECT v_count, v_reset_at, (v_count <= p_max_requests);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "check_siret_exist",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.check_siret_exist(e text)\n RETURNS boolean\n LANGUAGE sql\n SECURITY DEFINER\n SET search_path TO 'public', 'providers'\nAS $function$\r\n  SELECT EXISTS (SELECT 1 FROM providers.providers WHERE siret = $1);\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "checkauth",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.checkauth(text, text)\n RETURNS integer\n LANGUAGE sql\nAS $function$ SELECT CheckAuth('', $1, $2) $function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "checkauth",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.checkauth(text, text, text)\n RETURNS integer\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n\tschema text;\nBEGIN\n\tIF NOT LongTransactionsEnabled() THEN\n\t\tRAISE EXCEPTION 'Long transaction support disabled, use EnableLongTransaction() to enable.';\n\tEND IF;\n\n\tif ( $1 != '' ) THEN\n\t\tschema = $1;\n\tELSE\n\t\tSELECT current_schema() into schema;\n\tEND IF;\n\n\t-- TODO: check for an already existing trigger ?\n\n\tEXECUTE 'CREATE TRIGGER check_auth BEFORE UPDATE OR DELETE ON '\n\t\t|| quote_ident(schema) || '.' || quote_ident($2)\n\t\t||' FOR EACH ROW EXECUTE PROCEDURE CheckAuthTrigger('\n\t\t|| quote_literal($3) || ')';\n\n\tRETURN 0;\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "checkauthtrigger",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.checkauthtrigger()\n RETURNS trigger\n LANGUAGE c\nAS '$libdir/postgis-3', $function$check_authorization$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "cleanup_expired_api_rate_limits",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.cleanup_expired_api_rate_limits()\n RETURNS integer\n LANGUAGE plpgsql\n SET search_path TO 'public'\nAS $function$\r\nDECLARE\r\n  v_deleted INTEGER := 0;\r\nBEGIN\r\n  DELETE FROM public.api_rate_limits\r\n  WHERE reset_at < NOW() - INTERVAL '1 day';\r\n\r\n  GET DIAGNOSTICS v_deleted = ROW_COUNT;\r\n  RETURN v_deleted;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "contains_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.contains_2d(box2df, box2df)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_contains_box2df_box2df_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "contains_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.contains_2d(box2df, geometry)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_contains_box2df_geom_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "contains_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.contains_2d(geometry, box2df)\n RETURNS boolean\n LANGUAGE sql\n IMMUTABLE PARALLEL SAFE STRICT COST 1\nAS $function$SELECT $2 OPERATOR(public.@) $1;$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "create_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.create_availability(p_provider uuid, p_start_time text, p_end_time text, p_type text DEFAULT 'available'::text, p_note text DEFAULT NULL::text, p_is_recurring boolean DEFAULT false, p_weekdays integer[] DEFAULT ARRAY[]::integer[], p_start_date date DEFAULT CURRENT_DATE, p_end_date date DEFAULT NULL::date)\n RETURNS providers.availabilities\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  new_availability providers.availabilities;\r\nBEGIN\r\n  -- Insert the new availability\r\n  INSERT INTO providers.availabilities (\r\n    provider,\r\n    start_time,\r\n    end_time,\r\n    type,\r\n    note,\r\n    is_recurring,\r\n    weekdays,\r\n    start_date,\r\n    end_date\r\n  ) VALUES (\r\n    p_provider,\r\n    p_start_time::time,\r\n    p_end_time::time,\r\n    p_type,\r\n    p_note,\r\n    p_is_recurring,\r\n    p_weekdays,\r\n    p_start_date,\r\n    p_end_date\r\n  )\r\n  RETURNING * INTO new_availability;\r\n\r\n  RETURN new_availability;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_all_provider_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_all_provider_availabilities(p_provider_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    RETURN providers.delete_all_provider_availabilities(p_provider_id);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_availability(p_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    RETURN providers.delete_availability(p_id);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_document",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_document(p_document_id uuid)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_file_path TEXT;\r\n  v_storage_result JSONB;\r\nBEGIN\r\n  -- Get the file_path from the document\r\n  SELECT file_path INTO v_file_path\r\n  FROM public.documents\r\n  WHERE id = p_document_id;\r\n\r\n  -- If document doesn't exist, just return without error\r\n  IF v_file_path IS NULL THEN\r\n    RAISE WARNING 'Document % not found in table, skipping deletion', p_document_id;\r\n    RETURN;\r\n  END IF;\r\n\r\n  -- Delete the file from storage bucket 'documents'\r\n  -- The file_path should be like 'uploads/filename.ext' or just the filename\r\n  -- Ensure the path includes 'uploads/' prefix if not already present\r\n  BEGIN\r\n    -- If the file_path doesn't start with 'uploads/', add it\r\n    IF v_file_path NOT LIKE 'uploads/%' THEN\r\n      v_file_path := 'uploads/' || v_file_path;\r\n    END IF;\r\n\r\n    -- Delete from storage using the storage extension\r\n    SELECT storage.delete(\r\n      'documents'::text,\r\n      ARRAY[v_file_path]::text[]\r\n    ) INTO v_storage_result;\r\n\r\n    RAISE NOTICE 'Deleted file % from storage bucket documents', v_file_path;\r\n  EXCEPTION WHEN OTHERS THEN\r\n    -- Log warning but don't fail if storage deletion fails\r\n    RAISE WARNING 'Could not delete file % from storage: %', v_file_path, SQLERRM;\r\n  END;\r\n\r\n  -- Delete the document record from the table\r\n  DELETE FROM public.documents\r\n  WHERE id = p_document_id;\r\n\r\n  RAISE NOTICE 'Deleted document % from public.documents table', p_document_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_user_doc",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_user_doc(p_document_id text DEFAULT NULL::text)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_file_path TEXT;\r\n  v_storage_result JSONB;\r\n  v_document_uuid UUID;\r\nBEGIN\r\n  -- 1. Handle NULL or invalid input early\r\n  IF p_document_id IS NULL OR p_document_id = '' THEN\r\n    RAISE NOTICE 'No document ID provided.';\r\n    RETURN;\r\n  END IF;\r\n\r\n  -- 2. Attempt to cast the text to UUID. This will raise an exception on invalid format.\r\n  BEGIN\r\n    v_document_uuid := p_document_id::uuid;\r\n  EXCEPTION WHEN OTHERS THEN\r\n    RAISE WARNING 'Provided ID \"%\" is not a valid UUID.', p_document_id;\r\n    RETURN;\r\n  END;\r\n\r\n  -- 3. Get the file_path from the document using the casted UUID\r\n  SELECT file_path INTO v_file_path\r\n  FROM public.documents\r\n  WHERE id = v_document_uuid;\r\n\r\n  IF NOT FOUND THEN\r\n    RAISE NOTICE 'Document record with ID % not found in table.', v_document_uuid;\r\n    RETURN;\r\n  END IF;\r\n\r\n  -- 5. Delete the document record from the table\r\n  DELETE FROM public.documents\r\n  WHERE id = v_document_uuid;\r\n\r\n  RAISE NOTICE 'Deleted document % from public.documents table.', v_document_uuid;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_user_document",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_user_document(p_document_id text DEFAULT NULL::text)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_file_path TEXT;\r\n  v_storage_result JSONB;\r\n  v_document_uuid UUID;\r\nBEGIN\r\n  -- 1. Handle NULL or invalid input early\r\n  IF p_document_id IS NULL OR p_document_id = '' THEN\r\n    RAISE NOTICE 'No document ID provided.';\r\n    RETURN;\r\n  END IF;\r\n\r\n  -- 2. Attempt to cast the text to UUID. This will raise an exception on invalid format.\r\n  BEGIN\r\n    v_document_uuid := p_document_id::uuid;\r\n  EXCEPTION WHEN OTHERS THEN\r\n    RAISE WARNING 'Provided ID \"%\" is not a valid UUID.', p_document_id;\r\n    RETURN;\r\n  END;\r\n\r\n  -- 3. Get the file_path from the document using the casted UUID\r\n  SELECT file_path INTO v_file_path\r\n  FROM public.documents\r\n  WHERE id = v_document_uuid;\r\n\r\n  IF NOT FOUND THEN\r\n    RAISE NOTICE 'Document record with ID % not found in table.', v_document_uuid;\r\n    RETURN;\r\n  END IF;\r\n\r\n  -- 4. Delete the file from storage bucket 'documents'\r\n  IF v_file_path IS NOT NULL THEN\r\n    BEGIN\r\n      -- Ensure the storage.delete function is called correctly.\r\n      -- The path should be relative to the bucket, e.g., 'folder/file.jpg'\r\n      SELECT storage.delete(\r\n        'documents'::text,\r\n        ARRAY[v_file_path]::text[]\r\n      ) INTO v_storage_result;\r\n\r\n      RAISE NOTICE 'Successfully deleted file % from storage.', v_file_path;\r\n    EXCEPTION WHEN OTHERS THEN\r\n      RAISE WARNING 'Storage deletion failed for %: %', v_file_path, SQLERRM;\r\n      -- Decide if you want to stop here or continue to delete the DB record.\r\n    END;\r\n  END IF;\r\n\r\n  -- 5. Delete the document record from the table\r\n  DELETE FROM public.documents\r\n  WHERE id = v_document_uuid;\r\n\r\n  RAISE NOTICE 'Deleted document % from public.documents table.', v_document_uuid;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "delete_user_document",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.delete_user_document(p_document_id uuid)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_profile_id UUID;\r\nBEGIN\r\n  -- Get the profile_id from the document to verify ownership\r\n  SELECT profile INTO v_profile_id\r\n  FROM public.documents\r\n  WHERE id = p_document_id;\r\n\r\n  -- Verify that the document exists and belongs to the current user\r\n  IF v_profile_id IS NULL THEN\r\n    RAISE EXCEPTION 'Document not found';\r\n  END IF;\r\n\r\n  IF auth.uid() != v_profile_id THEN\r\n    RAISE EXCEPTION 'Unauthorized: You can only delete your own documents';\r\n  END IF;\r\n\r\n  -- Delete the document\r\n  DELETE FROM public.documents\r\n  WHERE id = p_document_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "disablelongtransactions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.disablelongtransactions()\n RETURNS text\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n\trec RECORD;\n\nBEGIN\n\n\t--\n\t-- Drop all triggers applied by CheckAuth()\n\t--\n\tFOR rec IN\n\t\tSELECT c.relname, t.tgname, t.tgargs FROM pg_trigger t, pg_class c, pg_proc p\n\t\tWHERE p.proname = 'checkauthtrigger' and t.tgfoid = p.oid and t.tgrelid = c.oid\n\tLOOP\n\t\tEXECUTE 'DROP TRIGGER ' || quote_ident(rec.tgname) ||\n\t\t\t' ON ' || quote_ident(rec.relname);\n\tEND LOOP;\n\n\t--\n\t-- Drop the authorization_table table\n\t--\n\tFOR rec IN SELECT * FROM pg_class WHERE relname = 'authorization_table' LOOP\n\t\tDROP TABLE authorization_table;\n\tEND LOOP;\n\n\t--\n\t-- Drop the authorized_tables view\n\t--\n\tFOR rec IN SELECT * FROM pg_class WHERE relname = 'authorized_tables' LOOP\n\t\tDROP VIEW authorized_tables;\n\tEND LOOP;\n\n\tRETURN 'Long transactions support disabled';\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "email_exists",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.email_exists(e text)\n RETURNS boolean\n LANGUAGE sql\n STABLE SECURITY DEFINER\n SET search_path TO 'public'\nAS $function$select exists(\r\n        select 1 from auth.users\r\n        where lower(email) = lower(e)\r\n    );$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "enablelongtransactions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.enablelongtransactions()\n RETURNS text\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n\t\"query\" text;\n\texists bool;\n\trec RECORD;\n\nBEGIN\n\n\texists = 'f';\n\tFOR rec IN SELECT * FROM pg_class WHERE relname = 'authorization_table'\n\tLOOP\n\t\texists = 't';\n\tEND LOOP;\n\n\tIF NOT exists\n\tTHEN\n\t\t\"query\" = 'CREATE TABLE authorization_table (\n\t\t\ttoid oid, -- table oid\n\t\t\trid text, -- row id\n\t\t\texpires timestamp,\n\t\t\tauthid text\n\t\t)';\n\t\tEXECUTE \"query\";\n\tEND IF;\n\n\texists = 'f';\n\tFOR rec IN SELECT * FROM pg_class WHERE relname = 'authorized_tables'\n\tLOOP\n\t\texists = 't';\n\tEND LOOP;\n\n\tIF NOT exists THEN\n\t\t\"query\" = 'CREATE VIEW authorized_tables AS ' ||\n\t\t\t'SELECT ' ||\n\t\t\t'n.nspname as schema, ' ||\n\t\t\t'c.relname as table, trim(' ||\n\t\t\tquote_literal(chr(92) || '000') ||\n\t\t\t' from t.tgargs) as id_column ' ||\n\t\t\t'FROM pg_trigger t, pg_class c, pg_proc p ' ||\n\t\t\t', pg_namespace n ' ||\n\t\t\t'WHERE p.proname = ' || quote_literal('checkauthtrigger') ||\n\t\t\t' AND c.relnamespace = n.oid' ||\n\t\t\t' AND t.tgfoid = p.oid and t.tgrelid = c.oid';\n\t\tEXECUTE \"query\";\n\tEND IF;\n\n\tRETURN 'Long transactions support enabled';\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "equals",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.equals(geom1 geometry, geom2 geometry)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 500\nAS '$libdir/postgis-3', $function$ST_Equals$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "export_all_tables",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.export_all_tables()\n RETURNS jsonb\n LANGUAGE plpgsql\nAS $function$\r\nDECLARE\r\n  result jsonb := '{}';\r\n  tbl RECORD;\r\n  data jsonb;\r\nBEGIN\r\n  FOR tbl IN \r\n    SELECT table_name\r\n    FROM information_schema.tables\r\n    WHERE table_schema = 'public'\r\n  LOOP\r\n    EXECUTE format('SELECT jsonb_agg(to_jsonb(t)) FROM %I t', tbl.table_name)\r\n    INTO data;\r\n\r\n    result := jsonb_set(\r\n      result,\r\n      ARRAY[tbl.table_name],\r\n      COALESCE(data, '[]'::jsonb)\r\n    );\r\n  END LOOP;\r\n\r\n  RETURN result;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_open_missions_for_provider",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_open_missions_for_provider(p_provider_profile_id uuid)\n RETURNS TABLE(mission_id uuid, company_profile_id uuid, mission_title text, job_name text, distance_km numeric)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_provider_lat DOUBLE PRECISION;\r\n    v_provider_lng DOUBLE PRECISION;\r\n    v_provider_rayon BIGINT;\r\n    v_provider_id UUID;\r\nBEGIN\r\n    -- Get provider details\r\n    SELECT p.id, p.zone_intervention_lat, p.zone_intervention_lng, p.zone_intervention_rayon\r\n    INTO v_provider_id, v_provider_lat, v_provider_lng, v_provider_rayon\r\n    FROM providers.providers p\r\n    WHERE p.profile = p_provider_profile_id;\r\n\r\n    -- Exit if provider not found or missing zone data\r\n    IF v_provider_id IS NULL OR v_provider_lat IS NULL OR v_provider_lng IS NULL OR v_provider_rayon IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    -- Find matching open missions\r\n    RETURN QUERY\r\n    SELECT DISTINCT\r\n        m.id AS mission_id,\r\n        c.profile AS company_profile_id,\r\n        m.title AS mission_title,\r\n        j.name AS job_name,\r\n        ROUND((\r\n            6371 * ACOS(\r\n                LEAST(1.0, GREATEST(-1.0,\r\n                    COS(RADIANS(v_provider_lat)) *\r\n                    COS(RADIANS(m.latitude)) *\r\n                    COS(RADIANS(m.longitude) - RADIANS(v_provider_lng)) +\r\n                    SIN(RADIANS(v_provider_lat)) *\r\n                    SIN(RADIANS(m.latitude))\r\n                ))\r\n            )\r\n        )::NUMERIC, 2) AS distance_km\r\n    FROM missions.missions m\r\n    INNER JOIN companies.companies c ON c.id = m.company_id\r\n    INNER JOIN jobs.jobs j ON j.id = m.job\r\n    INNER JOIN providers.provider_jobs pj ON pj.job = m.job AND pj.provider = v_provider_id\r\n    WHERE m.status = 'open'\r\n      AND m.latitude IS NOT NULL\r\n      AND m.longitude IS NOT NULL\r\n      AND m.start_time > NOW() -- Only future missions\r\n      AND c.accept_notifications = TRUE\r\n      -- Haversine distance check\r\n      AND (\r\n          6371 * ACOS(\r\n              LEAST(1.0, GREATEST(-1.0,\r\n                  COS(RADIANS(v_provider_lat)) *\r\n                  COS(RADIANS(m.latitude)) *\r\n                  COS(RADIANS(m.longitude) - RADIANS(v_provider_lng)) +\r\n                  SIN(RADIANS(v_provider_lat)) *\r\n                  SIN(RADIANS(m.latitude))\r\n              ))\r\n          )\r\n      ) <= v_provider_rayon\r\n    ORDER BY distance_km ASC\r\n    LIMIT 5; -- Limit to avoid overwhelming notifications\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_open_missions_for_provider_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_open_missions_for_provider_v2(p_provider_profile_id uuid)\n RETURNS TABLE(mission_id uuid, company_profile_id uuid, mission_title text, job_name text, mission_lat double precision, mission_lng double precision)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_provider_geohash TEXT;\r\n    v_provider_id UUID;\r\nBEGIN\r\n    -- Get provider geohash\r\n    SELECT p.id, p.zone_intervention_geohash\r\n    INTO v_provider_id, v_provider_geohash\r\n    FROM providers.providers p\r\n    WHERE p.profile = p_provider_profile_id;\r\n\r\n    -- Exit if provider not found or missing geohash\r\n    IF v_provider_id IS NULL OR v_provider_geohash IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    -- Find matching open missions (coarse geohash filter)\r\n    -- Node server will calculate precise distance with provider's decrypted lat/lng\r\n    RETURN QUERY\r\n    SELECT DISTINCT\r\n        m.id AS mission_id,\r\n        c.profile AS company_profile_id,\r\n        m.title AS mission_title,\r\n        j.name AS job_name,\r\n        m.latitude AS mission_lat,\r\n        m.longitude AS mission_lng\r\n    FROM missions.missions m\r\n    INNER JOIN companies.companies c ON c.id = m.company_id\r\n    INNER JOIN jobs.jobs j ON j.id = m.job\r\n    INNER JOIN providers.provider_jobs pj ON pj.job = m.job AND pj.provider = v_provider_id\r\n    WHERE m.status = 'open'\r\n      AND m.latitude IS NOT NULL\r\n      AND m.longitude IS NOT NULL\r\n      AND m.start_time > NOW()\r\n      AND c.accept_notifications = TRUE\r\n    ORDER BY m.start_time ASC\r\n    LIMIT 5;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_providers_for_new_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_providers_for_new_mission(p_mission_id uuid)\n RETURNS TABLE(provider_id uuid, profile_id uuid, distance_km numeric)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_job_id INTEGER;\r\n    v_mission_lat DOUBLE PRECISION;\r\n    v_mission_lng DOUBLE PRECISION;\r\nBEGIN\r\n    -- Get mission details\r\n    SELECT job, latitude, longitude\r\n    INTO v_job_id, v_mission_lat, v_mission_lng\r\n    FROM missions.missions\r\n    WHERE id = p_mission_id;\r\n\r\n    -- Exit if mission not found or missing coordinates\r\n    IF v_job_id IS NULL OR v_mission_lat IS NULL OR v_mission_lng IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    -- Find matching providers using Haversine formula\r\n    RETURN QUERY\r\n    SELECT\r\n        p.id AS provider_id,\r\n        p.profile AS profile_id,\r\n        ROUND((\r\n            6371 * ACOS(\r\n                LEAST(1.0, GREATEST(-1.0,\r\n                    COS(RADIANS(p.zone_intervention_lat)) *\r\n                    COS(RADIANS(v_mission_lat)) *\r\n                    COS(RADIANS(v_mission_lng) - RADIANS(p.zone_intervention_lng)) +\r\n                    SIN(RADIANS(p.zone_intervention_lat)) *\r\n                    SIN(RADIANS(v_mission_lat))\r\n                ))\r\n            )\r\n        )::NUMERIC, 2) AS distance_km\r\n    FROM providers.providers p\r\n    INNER JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n    WHERE pj.job = v_job_id\r\n      AND p.accept_notifications = TRUE\r\n      AND p.done_onboarding = TRUE\r\n      AND p.zone_intervention_lat IS NOT NULL\r\n      AND p.zone_intervention_lng IS NOT NULL\r\n      AND p.zone_intervention_rayon IS NOT NULL\r\n      -- Haversine distance check\r\n      AND (\r\n          6371 * ACOS(\r\n              LEAST(1.0, GREATEST(-1.0,\r\n                  COS(RADIANS(p.zone_intervention_lat)) *\r\n                  COS(RADIANS(v_mission_lat)) *\r\n                  COS(RADIANS(v_mission_lng) - RADIANS(p.zone_intervention_lng)) +\r\n                  SIN(RADIANS(p.zone_intervention_lat)) *\r\n                  SIN(RADIANS(v_mission_lat))\r\n              ))\r\n          )\r\n      ) <= p.zone_intervention_rayon;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_providers_for_new_mission_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_providers_for_new_mission_v2(p_mission_id uuid, p_mission_geohash text DEFAULT NULL::text)\n RETURNS TABLE(provider_id uuid, profile_id uuid, siret_enc text, zone_intervention_lat_enc text, zone_intervention_lng_enc text, zone_intervention_rayon bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_job_id INTEGER;\r\nBEGIN\r\n    -- Get mission job\r\n    SELECT job INTO v_job_id\r\n    FROM missions.missions\r\n    WHERE id = p_mission_id;\r\n\r\n    -- Exit if mission not found\r\n    IF v_job_id IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    -- Return providers matching job + geohash (coarse filter)\r\n    -- Node server will decrypt lat/lng and calculate precise Haversine distance\r\n    RETURN QUERY\r\n    SELECT\r\n        p.id AS provider_id,\r\n        p.profile AS profile_id,\r\n        p.siret_enc,\r\n        p.zone_intervention_lat_enc,\r\n        p.zone_intervention_lng_enc,\r\n        p.zone_intervention_rayon\r\n    FROM providers.providers p\r\n    INNER JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n    WHERE pj.job = v_job_id\r\n      AND p.accept_notifications = TRUE\r\n      AND p.done_onboarding = TRUE\r\n      AND p.zone_intervention_geohash IS NOT NULL\r\n      AND p.zone_intervention_rayon IS NOT NULL\r\n      -- Coarse geohash filter (if provided)\r\n      AND (p_mission_geohash IS NULL OR p.zone_intervention_geohash = p_mission_geohash);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_replacement_providers_for_mission",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_replacement_providers_for_mission(p_mission_id uuid, p_excluded_provider_profile_id uuid DEFAULT NULL::uuid, p_limit integer DEFAULT 5)\n RETURNS TABLE(provider_id uuid, profile_id uuid, first_name text, last_name text, photo uuid, hourly_rate numeric, distance_km numeric, verified boolean, rating_avg numeric, rating_count bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_job_id INTEGER;\r\n    v_mission_lat DOUBLE PRECISION;\r\n    v_mission_lng DOUBLE PRECISION;\r\n    v_mission_start TIMESTAMPTZ;\r\nBEGIN\r\n    -- Get mission details\r\n    SELECT job, latitude, longitude, start_time\r\n    INTO v_job_id, v_mission_lat, v_mission_lng, v_mission_start\r\n    FROM missions.missions\r\n    WHERE id = p_mission_id;\r\n\r\n    -- Exit if mission not found or missing coordinates\r\n    IF v_job_id IS NULL OR v_mission_lat IS NULL OR v_mission_lng IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    RETURN QUERY\r\n    SELECT\r\n        p.id AS provider_id,\r\n        p.profile AS profile_id,\r\n        prof.first_name::TEXT,\r\n        prof.last_name::TEXT,\r\n        prof.photo,\r\n        COALESCE(pj.hourly_rate, p.taux_horaire) AS hourly_rate,\r\n        ROUND((\r\n            6371 * ACOS(\r\n                LEAST(1.0, GREATEST(-1.0,\r\n                    COS(RADIANS(p.zone_intervention_lat)) *\r\n                    COS(RADIANS(v_mission_lat)) *\r\n                    COS(RADIANS(v_mission_lng) - RADIANS(p.zone_intervention_lng)) +\r\n                    SIN(RADIANS(p.zone_intervention_lat)) *\r\n                    SIN(RADIANS(v_mission_lat))\r\n                ))\r\n            )\r\n        )::NUMERIC, 2) AS distance_km,\r\n        COALESCE(p.verified, false) AS verified,\r\n        COALESCE(AVG(r.rate), 0)::NUMERIC AS rating_avg,\r\n        COUNT(r.id) AS rating_count\r\n    FROM providers.providers p\r\n    INNER JOIN public.profiles prof ON prof.id = p.profile\r\n    INNER JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n    LEFT JOIN providers.ratings r ON r.provider = p.id\r\n    WHERE pj.job = v_job_id\r\n      AND p.done_onboarding = TRUE\r\n      AND (p.suspension_status IS NULL OR p.suspension_status IN ('warning_1', 'warning_2'))\r\n      AND (p.suspension_expires_at IS NULL OR p.suspension_expires_at < NOW())\r\n      AND p.zone_intervention_lat IS NOT NULL\r\n      AND p.zone_intervention_lng IS NOT NULL\r\n      AND p.zone_intervention_rayon IS NOT NULL\r\n      -- Exclude the provider who just canceled\r\n      AND (p_excluded_provider_profile_id IS NULL OR p.profile != p_excluded_provider_profile_id)\r\n      -- Exclude providers who have already applied/been assigned to this mission\r\n      AND NOT EXISTS (\r\n          SELECT 1 FROM missions.profile_missions pm\r\n          WHERE pm.mission = p_mission_id\r\n            AND pm.profile = p.profile\r\n            AND pm.state NOT IN ('canceled', 'rejected', 'expired')\r\n      )\r\n      -- Within intervention zone\r\n      AND (\r\n          6371 * ACOS(\r\n              LEAST(1.0, GREATEST(-1.0,\r\n                  COS(RADIANS(p.zone_intervention_lat)) *\r\n                  COS(RADIANS(v_mission_lat)) *\r\n                  COS(RADIANS(v_mission_lng) - RADIANS(p.zone_intervention_lng)) +\r\n                  SIN(RADIANS(p.zone_intervention_lat)) *\r\n                  SIN(RADIANS(v_mission_lat))\r\n              ))\r\n          )\r\n      ) <= p.zone_intervention_rayon\r\n    GROUP BY p.id, p.profile, prof.first_name, prof.last_name, prof.photo, pj.hourly_rate, p.taux_horaire, p.zone_intervention_lat, p.zone_intervention_lng, p.verified\r\n    ORDER BY\r\n        COALESCE(p.verified, false) DESC,\r\n        AVG(r.rate) DESC NULLS LAST,\r\n        distance_km ASC\r\n    LIMIT p_limit;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_replacement_providers_for_mission_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_replacement_providers_for_mission_v3(p_mission_id uuid, p_excluded_provider_profile_id uuid DEFAULT NULL::uuid, p_limit integer DEFAULT 5)\n RETURNS TABLE(provider_id uuid, profile_id uuid, first_name_enc text, last_name_enc text, photo uuid, hourly_rate numeric, verified boolean, rating_avg numeric, rating_count bigint, siret_enc text, zone_intervention_lat_enc text, zone_intervention_lng_enc text, zone_intervention_rayon bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n    v_job_id INTEGER;\r\nBEGIN\r\n    SELECT job INTO v_job_id\r\n    FROM missions.missions\r\n    WHERE id = p_mission_id;\r\n\r\n    IF v_job_id IS NULL THEN\r\n        RETURN;\r\n    END IF;\r\n\r\n    RETURN QUERY\r\n    SELECT\r\n        p.id AS provider_id,\r\n        p.profile AS profile_id,\r\n        prof.first_name_enc,\r\n        prof.last_name_enc,\r\n        prof.photo,\r\n        COALESCE(pj.hourly_rate, p.taux_horaire) AS hourly_rate,\r\n        COALESCE(p.verified, false) AS verified,\r\n        COALESCE(AVG(r.rate), 0)::NUMERIC AS rating_avg,\r\n        COUNT(r.id) AS rating_count,\r\n        p.siret_enc,\r\n        p.zone_intervention_lat_enc,\r\n        p.zone_intervention_lng_enc,\r\n        p.zone_intervention_rayon\r\n    FROM providers.providers p\r\n    INNER JOIN public.profiles prof ON prof.id = p.profile\r\n    INNER JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n    LEFT JOIN providers.ratings r ON r.provider = p.id\r\n    WHERE pj.job = v_job_id\r\n      AND p.done_onboarding = TRUE\r\n      AND (p.suspension_status IS NULL OR p.suspension_status IN ('warning_1', 'warning_2'))\r\n      AND (p.suspension_expires_at IS NULL OR p.suspension_expires_at < NOW())\r\n      AND p.zone_intervention_geohash IS NOT NULL\r\n      AND p.zone_intervention_rayon IS NOT NULL\r\n      AND (p_excluded_provider_profile_id IS NULL OR p.profile != p_excluded_provider_profile_id)\r\n      AND NOT EXISTS (\r\n          SELECT 1 FROM missions.profile_missions pm\r\n          WHERE pm.mission = p_mission_id\r\n            AND pm.profile = p.profile\r\n            AND pm.state NOT IN ('canceled', 'rejected', 'expired')\r\n      )\r\n    GROUP BY p.id, prof.id, pj.hourly_rate\r\n    ORDER BY rating_avg DESC, rating_count DESC\r\n    LIMIT p_limit;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "find_srid",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.find_srid(character varying, character varying, character varying)\n RETURNS integer\n LANGUAGE plpgsql\n STABLE PARALLEL SAFE STRICT\nAS $function$\nDECLARE\n\tschem varchar =  $1;\n\ttabl varchar = $2;\n\tsr int4;\nBEGIN\n-- if the table contains a . and the schema is empty\n-- split the table into a schema and a table\n-- otherwise drop through to default behavior\n\tIF ( schem = '' and strpos(tabl,'.') > 0 ) THEN\n\t schem = substr(tabl,1,strpos(tabl,'.')-1);\n\t tabl = substr(tabl,length(schem)+2);\n\tEND IF;\n\n\tselect SRID into sr from public.geometry_columns where (f_table_schema = schem or schem = '') and f_table_name = tabl and f_geometry_column = $3;\n\tIF NOT FOUND THEN\n\t   RAISE EXCEPTION 'find_srid() - could not find the corresponding SRID - is the geometry registered in the GEOMETRY_COLUMNS table?  Is there an uppercase/lowercase mismatch?';\n\tEND IF;\n\treturn sr;\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_document_filepath",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_document_filepath(p_document_id uuid)\n RETURNS text\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_file_path TEXT;\r\nBEGIN\r\n  -- Get the file_path from the document\r\n  SELECT file_path INTO v_file_path\r\n  FROM public.documents\r\n  WHERE id = p_document_id;\r\n\r\n  -- Return the file_path (can be NULL if document doesn't exist)\r\n  RETURN v_file_path;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_jobs",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_jobs()\n RETURNS TABLE(job_id integer, job_name character varying, job_description text, average_hourly_rate numeric, skills_required text, job_created_at timestamp without time zone, job_updated_at timestamp without time zone, category_id integer, category_name character varying, category_description text, domain_id integer, domain_name character varying, domain_description text)\n LANGUAGE plpgsql\n STABLE\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n      j.id AS job_id,\r\n      j.name AS job_name,\r\n      j.description AS job_description,\r\n      j.average_hourly_rate,\r\n      j.skills_required,\r\n      j.created_at AS job_created_at,\r\n      j.updated_at AS job_updated_at,\r\n\r\n      c.id AS category_id,\r\n      c.name AS category_name,\r\n      c.description AS category_description,\r\n\r\n      d.id AS domain_id,\r\n      d.name AS domain_name,\r\n      d.description AS domain_description\r\n\r\n  FROM jobs.jobs AS j\r\n  JOIN jobs.categories AS c\r\n      ON j.category_id = c.id\r\n  JOIN jobs.domains AS d\r\n      ON c.domain_id = d.id\r\n  ORDER BY d.name, c.name, j.name;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_missions_filtered",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_missions_filtered(p_mission_id uuid DEFAULT NULL::uuid, p_provider_id uuid DEFAULT NULL::uuid, p_status text DEFAULT NULL::text, p_company_id uuid DEFAULT NULL::uuid, p_date_debut timestamp without time zone DEFAULT NULL::timestamp without time zone, p_date_fin timestamp without time zone DEFAULT NULL::timestamp without time zone, p_lat_min double precision DEFAULT NULL::double precision, p_lat_max double precision DEFAULT NULL::double precision, p_lng_min double precision DEFAULT NULL::double precision, p_lng_max double precision DEFAULT NULL::double precision)\n RETURNS TABLE(id uuid, company_id uuid, title text, description text, location text, postal_code character varying, city character varying, latitude double precision, longitude double precision, start_time timestamp without time zone, end_time timestamp without time zone, salary numeric, status text, is_paid boolean, created_at timestamp without time zone, benevole boolean, requires_mobility boolean, items_to_bring text[], company_name text, company_siret text, company_description text, profile_photo uuid, job_name character varying, average_hourly_rate numeric)\n LANGUAGE sql\n SECURITY DEFINER\nAS $function$\r\n  SELECT\r\n    m.id, m.company_id, m.title, m.description, m.location, m.postal_code, m.city,\r\n    m.latitude, m.longitude, m.start_time, m.end_time, m.salary, m.status, m.is_paid,\r\n    m.created_at, m.benevole, m.requires_mobility, m.items_to_bring,\r\n    c.nom_commercial AS company_name,\r\n    NULL::text AS company_siret,\r\n    c.description AS company_description,\r\n    p.photo AS profile_photo, j.name AS job_name, j.average_hourly_rate\r\n  FROM missions.missions m\r\n  LEFT JOIN companies.companies c ON m.company_id = c.id\r\n  LEFT JOIN public.profiles p ON c.profile = p.id\r\n  LEFT JOIN jobs.jobs j ON m.job = j.id\r\n  WHERE\r\n    (p_mission_id IS NULL OR m.id = p_mission_id)\r\n    AND (p_status IS NOT NULL OR p_company_id IS NOT NULL OR (m.status = 'open' AND m.end_time > NOW()))\r\n    AND (p_status IS NULL OR m.status = p_status)\r\n    AND (p_company_id IS NULL OR m.company_id = p_company_id)\r\n    AND (p_date_debut IS NULL OR m.start_time >= p_date_debut)\r\n    AND (p_date_fin IS NULL OR m.start_time <= p_date_fin)\r\n    AND (p_provider_id IS NULL OR (\r\n      (NOT EXISTS (SELECT 1 FROM providers.provider_jobs pj WHERE pj.provider = p_provider_id)\r\n       OR m.job IN (SELECT pj.job FROM providers.provider_jobs pj WHERE pj.provider = p_provider_id))\r\n      AND EXISTS (\r\n        SELECT 1 FROM providers.providers prov\r\n        WHERE prov.id = p_provider_id\r\n        AND (prov.zone_intervention_lat IS NULL OR prov.zone_intervention_lng IS NULL OR prov.zone_intervention_rayon IS NULL\r\n          OR (6371 * acos(cos(radians(prov.zone_intervention_lat)) * cos(radians(m.latitude)) *\r\n              cos(radians(m.longitude) - radians(prov.zone_intervention_lng)) +\r\n              sin(radians(prov.zone_intervention_lat)) * sin(radians(m.latitude))) <= prov.zone_intervention_rayon))\r\n      )\r\n    ))\r\n    AND (p_lat_min IS NULL OR m.latitude >= p_lat_min)\r\n    AND (p_lat_max IS NULL OR m.latitude <= p_lat_max)\r\n    AND (p_lng_min IS NULL OR m.longitude >= p_lng_min)\r\n    AND (p_lng_max IS NULL OR m.longitude <= p_lng_max)\r\n  ORDER BY m.start_time ASC;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_missions_filtered_older",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_missions_filtered_older(p_mission_id uuid DEFAULT NULL::uuid, p_provider_id uuid DEFAULT NULL::uuid, p_status text DEFAULT NULL::text, p_company_id uuid DEFAULT NULL::uuid, p_date_debut timestamp without time zone DEFAULT NULL::timestamp without time zone, p_date_fin timestamp without time zone DEFAULT NULL::timestamp without time zone)\n RETURNS TABLE(id uuid, company_id uuid, title text, description text, location text, postal_code character varying, city character varying, latitude double precision, longitude double precision, start_time timestamp without time zone, end_time timestamp without time zone, salary numeric, status text, is_paid boolean, created_at timestamp without time zone, benevole boolean, requires_mobility boolean, items_to_bring text[], company_name text, company_siret text, company_description text, profile_photo uuid, job_name character varying, average_hourly_rate numeric)\n LANGUAGE sql\n SECURITY DEFINER\nAS $function$\r\n  SELECT\r\n    m.id, m.company_id, m.title, m.description, m.location,\r\n    m.postal_code, m.city, m.latitude, m.longitude,\r\n    m.start_time, m.end_time, m.salary, m.status, m.is_paid,\r\n    m.created_at, m.benevole, m.requires_mobility, m.items_to_bring,\r\n    c.nom_commercial AS company_name,\r\n    NULL::text AS company_siret,\r\n    c.description AS company_description,\r\n    p.photo AS profile_photo, j.name AS job_name, j.average_hourly_rate\r\n  FROM missions.missions m\r\n  LEFT JOIN companies.companies c ON m.company_id = c.id\r\n  LEFT JOIN public.profiles p ON c.profile = p.id\r\n  LEFT JOIN jobs.jobs j ON m.job = j.id\r\n  WHERE\r\n    (p_mission_id IS NULL OR m.id = p_mission_id)\r\n    AND (p_status IS NOT NULL OR p_company_id IS NOT NULL OR (m.status = 'open' AND m.end_time > NOW()))\r\n    AND (p_status IS NULL OR m.status = p_status)\r\n    AND (p_company_id IS NULL OR m.company_id = p_company_id)\r\n    AND (p_date_debut IS NULL OR m.start_time >= p_date_debut)\r\n    AND (p_date_fin IS NULL OR m.start_time <= p_date_fin)\r\n    AND (p_provider_id IS NULL OR (\r\n      m.job IN (SELECT pj.job FROM providers.provider_jobs pj WHERE pj.provider = p_provider_id)\r\n      AND EXISTS (\r\n        SELECT 1 FROM providers.providers prov\r\n        WHERE prov.id = p_provider_id\r\n        AND (\r\n          prov.zone_intervention_lat IS NULL\r\n          OR prov.zone_intervention_lng IS NULL\r\n          OR prov.zone_intervention_rayon IS NULL\r\n          OR (\r\n            6371 * acos(\r\n              cos(radians(prov.zone_intervention_lat)) * cos(radians(m.latitude)) *\r\n              cos(radians(m.longitude) - radians(prov.zone_intervention_lng)) +\r\n              sin(radians(prov.zone_intervention_lat)) * sin(radians(m.latitude))\r\n            ) <= prov.zone_intervention_rayon\r\n          )\r\n        )\r\n      )\r\n    ))\r\n  ORDER BY m.start_time ASC;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_proj4_from_srid",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_proj4_from_srid(integer)\n RETURNS text\n LANGUAGE plpgsql\n IMMUTABLE PARALLEL SAFE STRICT\nAS $function$\n\tBEGIN\n\tRETURN proj4text::text FROM public.spatial_ref_sys WHERE srid= $1;\n\tEND;\n\t$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_availabilities",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_availabilities(provider_id uuid)\n RETURNS SETOF providers.availabilities\n LANGUAGE sql\n SECURITY DEFINER\nAS $function$\r\n  SELECT *\r\n  FROM providers.availabilities\r\n  WHERE provider = provider_id\r\n  ORDER BY start_date ASC;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_daily_earnings_this_month",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_daily_earnings_this_month(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_daily_earnings JSONB;\r\nBEGIN\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'day', EXTRACT(DAY FROM day_date)::INTEGER,\r\n      'earnings', ROUND(COALESCE(day_earnings, 0), 2)\r\n    )\r\n    ORDER BY day_date\r\n  )\r\n  INTO v_daily_earnings\r\n  FROM (\r\n    SELECT\r\n      DATE_TRUNC('day', d.day_date) as day_date,\r\n      COALESCE(SUM(\r\n        (COALESCE(pm.price_hour, 0) * EXTRACT(EPOCH FROM (m.end_time - m.start_time)) / 3600) +\r\n        (COALESCE(pm.price_hour_supp, 0) * COALESCE(m.hours_supp, 0))\r\n      ), 0) as day_earnings\r\n    FROM generate_series(\r\n      DATE_TRUNC('month', NOW()),\r\n      DATE_TRUNC('month', NOW()) + INTERVAL '1 month' - INTERVAL '1 day',\r\n      INTERVAL '1 day'\r\n    ) AS d(day_date)\r\n    LEFT JOIN missions.missions m ON DATE_TRUNC('day', m.end_time) = DATE_TRUNC('day', d.day_date)\r\n      AND m.status = 'closed'\r\n      AND m.is_paid IS TRUE\r\n    LEFT JOIN missions.profile_missions pm ON pm.mission = m.id\r\n      AND pm.profile = p_profile_id\r\n      AND pm.state = 'assigned'\r\n    GROUP BY DATE_TRUNC('day', d.day_date)\r\n  ) daily_data;\r\n\r\n  RETURN COALESCE(v_daily_earnings, '[]'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_daily_earnings_this_week",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_daily_earnings_this_week(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_daily_earnings JSONB;\r\nBEGIN\r\n  SELECT jsonb_object_agg(\r\n    TO_CHAR(day_date, 'Day'),\r\n    COALESCE(day_earnings, 0)\r\n  )\r\n  INTO v_daily_earnings\r\n  FROM (\r\n    SELECT\r\n      DATE_TRUNC('day', d.day_date) as day_date,\r\n      COALESCE(SUM(\r\n        (COALESCE(pm.price_hour, 0) * EXTRACT(EPOCH FROM (m.end_time - m.start_time)) / 3600) +\r\n        (COALESCE(pm.price_hour_supp, 0) * COALESCE(m.hours_supp, 0))\r\n      ), 0) as day_earnings\r\n    FROM generate_series(\r\n      DATE_TRUNC('week', NOW()),\r\n      DATE_TRUNC('week', NOW()) + INTERVAL '6 days',\r\n      INTERVAL '1 day'\r\n    ) AS d(day_date)\r\n    LEFT JOIN missions.missions m ON DATE_TRUNC('day', m.end_time) = DATE_TRUNC('day', d.day_date)\r\n      AND m.status = 'closed'\r\n      AND m.is_paid IS TRUE\r\n    LEFT JOIN missions.profile_missions pm ON pm.mission = m.id\r\n      AND pm.profile = p_profile_id\r\n      AND pm.state = 'assigned'\r\n    GROUP BY DATE_TRUNC('day', d.day_date)\r\n    ORDER BY day_date\r\n  ) daily_data;\r\n\r\n  RETURN COALESCE(v_daily_earnings, '{}'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_dashboard_missions",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_dashboard_missions(p_profile_id uuid)\n RETURNS TABLE(id uuid, state text, origin text, price_hour numeric, price_hour_supp numeric, created_at timestamp with time zone, mission_id uuid, mission_title text, mission_description text, mission_location text, mission_city character varying, mission_postal_code character varying, mission_latitude double precision, mission_longitude double precision, mission_start_time timestamp without time zone, mission_end_time timestamp without time zone, mission_benevole boolean, mission_requires_mobility boolean, mission_status text, company_id uuid, company_name text, company_logo uuid, company_rating double precision, job_id integer, job_name character varying, provider_rating double precision, provider_rating_description text, provider_validation_status text, report_submitted_at timestamp with time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    pm.id,\r\n    pm.state,\r\n    pm.origin,\r\n    pm.price_hour,\r\n    pm.price_hour_supp,\r\n    pm.created_at,\r\n    m.id as mission_id,\r\n    m.title as mission_title,\r\n    m.description as mission_description,\r\n    m.location as mission_location,\r\n    m.city as mission_city,\r\n    m.postal_code as mission_postal_code,\r\n    m.latitude as mission_latitude,\r\n    m.longitude as mission_longitude,\r\n    m.start_time as mission_start_time,\r\n    m.end_time as mission_end_time,\r\n    m.benevole as mission_benevole,\r\n    m.requires_mobility as mission_requires_mobility,\r\n    m.status as mission_status,\r\n    c.id as company_id,\r\n    c.nom_commercial as company_name,\r\n    -- Get company logo from associated profile\r\n    (SELECT p.photo FROM public.profiles p WHERE p.id = c.profile) as company_logo,\r\n    -- Calculate average company rating\r\n    (\r\n      SELECT AVG(r.rate)::DOUBLE PRECISION\r\n      FROM companies.ratings r\r\n      WHERE r.company_id = c.id\r\n    ) as company_rating,\r\n    j.id as job_id,\r\n    j.name as job_name,\r\n    -- Get provider's rating for this specific mission\r\n    pr.rate::DOUBLE PRECISION as provider_rating,\r\n    pr.description as provider_rating_description,\r\n    pm.provider_validation_status,\r\n    pm.report_submitted_at\r\n  FROM missions.profile_missions pm\r\n  INNER JOIN missions.missions m ON pm.mission = m.id\r\n  LEFT JOIN companies.companies c ON m.company_id = c.id\r\n  LEFT JOIN jobs.jobs j ON m.job = j.id\r\n  LEFT JOIN companies.ratings pr ON (\r\n    pr.profile = p_profile_id\r\n    AND pr.mission_id = m.id\r\n    AND pr.company_id = c.id\r\n  )\r\n  WHERE pm.profile = p_profile_id\r\n    AND pm.state != 'rejected'\r\n  ORDER BY pm.created_at DESC;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_rating_summary",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_rating_summary(p_provider_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_avg_rating NUMERIC;\r\n  v_total_reviews INTEGER;\r\nBEGIN\r\n  -- Calculer la moyenne et le nombre total d'avis\r\n  SELECT \r\n    COALESCE(AVG(rate), 0),\r\n    COUNT(*)\r\n  INTO v_avg_rating, v_total_reviews\r\n  FROM providers.ratings\r\n  WHERE provider = p_provider_id;\r\n\r\n  -- Retourner le résultat\r\n  RETURN jsonb_build_object(\r\n    'average_rating', ROUND(v_avg_rating, 1),\r\n    'total_reviews', v_total_reviews\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_reviews",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_reviews(p_provider_id uuid, p_limit integer DEFAULT 10, p_offset integer DEFAULT 0)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_reviews JSONB;\r\n  v_total_count INTEGER;\r\n  v_has_more BOOLEAN;\r\nBEGIN\r\n  -- Get total count\r\n  SELECT COUNT(*)::integer\r\n  INTO v_total_count\r\n  FROM providers.ratings\r\n  WHERE provider = p_provider_id;\r\n\r\n  -- Calculate if there are more reviews\r\n  v_has_more := (p_offset + p_limit) < v_total_count;\r\n\r\n  -- Get paginated reviews with company information\r\n  -- Note: companies.companies table doesn't have a 'logo' column\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'id', r.id,\r\n      'rate', r.rate,\r\n      'description', r.description,\r\n      'created_at', r.created_at,\r\n      'company_name', COALESCE(c.nom_commercial, 'Entreprise'),\r\n      'company_logo', NULL\r\n    )\r\n    ORDER BY r.created_at DESC\r\n  )\r\n  INTO v_reviews\r\n  FROM (\r\n    SELECT *\r\n    FROM providers.ratings\r\n    WHERE provider = p_provider_id\r\n    ORDER BY created_at DESC\r\n    LIMIT p_limit\r\n    OFFSET p_offset\r\n  ) r\r\n  LEFT JOIN companies.companies c ON c.id = r.company;\r\n\r\n  -- Return as JSONB with metadata\r\n  RETURN jsonb_build_object(\r\n    'reviews', COALESCE(v_reviews, '[]'::jsonb),\r\n    'total_count', v_total_count,\r\n    'has_more', v_has_more\r\n  );\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_provider_weekly_earnings_6months",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_provider_weekly_earnings_6months(p_profile_id uuid)\n RETURNS jsonb\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_weekly_earnings JSONB;\r\nBEGIN\r\n  SELECT jsonb_agg(\r\n    jsonb_build_object(\r\n      'week', TO_CHAR(week_start, 'W'),\r\n      'month', TO_CHAR(week_start, 'Mon'),\r\n      'earnings', ROUND(COALESCE(week_earnings, 0), 2)\r\n    )\r\n    ORDER BY week_start\r\n  )\r\n  INTO v_weekly_earnings\r\n  FROM (\r\n    SELECT\r\n      DATE_TRUNC('week', d.week_start) as week_start,\r\n      COALESCE(SUM(\r\n        (COALESCE(pm.price_hour, 0) * EXTRACT(EPOCH FROM (m.end_time - m.start_time)) / 3600) +\r\n        (COALESCE(pm.price_hour_supp, 0) * COALESCE(m.hours_supp, 0))\r\n      ), 0) as week_earnings\r\n    FROM generate_series(\r\n      DATE_TRUNC('week', NOW() - INTERVAL '6 months'),\r\n      DATE_TRUNC('week', NOW()),\r\n      INTERVAL '1 week'\r\n    ) AS d(week_start)\r\n    LEFT JOIN missions.missions m ON DATE_TRUNC('week', m.end_time) = DATE_TRUNC('week', d.week_start)\r\n      AND m.status = 'closed'\r\n      AND m.is_paid IS TRUE\r\n    LEFT JOIN missions.profile_missions pm ON pm.mission = m.id\r\n      AND pm.profile = p_profile_id\r\n      AND pm.state = 'assigned'\r\n    GROUP BY DATE_TRUNC('week', d.week_start)\r\n  ) weekly_data;\r\n\r\n  RETURN COALESCE(v_weekly_earnings, '[]'::jsonb);\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_providers_for_map",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_providers_for_map(p_job_id integer DEFAULT NULL::integer, p_lat double precision DEFAULT NULL::double precision, p_lng double precision DEFAULT NULL::double precision, p_radius_km integer DEFAULT NULL::integer, p_benevole_only boolean DEFAULT false)\n RETURNS TABLE(id uuid, profile_id uuid, first_name text, last_name text, photo uuid, latitude double precision, longitude double precision, hourly_rate double precision, description text, average_rating numeric, rating_count bigint, jobs jsonb, verified boolean, vehicule boolean, distance_km double precision, benevolat boolean)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    p.id, p.profile AS profile_id, pr.first_name, pr.last_name, pr.photo,\r\n    p.zone_intervention_lat AS latitude, p.zone_intervention_lng AS longitude,\r\n    COALESCE(p.taux_horaire::double precision, (\r\n      SELECT MIN(pj_rate.hourly_rate) FROM providers.provider_jobs pj_rate\r\n      WHERE pj_rate.provider = p.id AND pj_rate.hourly_rate IS NOT NULL\r\n    )) AS hourly_rate,\r\n    p.more AS description,\r\n    COALESCE(ROUND(AVG(r.rate)::numeric, 1), NULL) AS average_rating,\r\n    COUNT(DISTINCT r.id) AS rating_count,\r\n    COALESCE(\r\n      JSONB_AGG(DISTINCT JSONB_BUILD_OBJECT(\r\n        'job_id', j.id, 'job_name', j.name, 'domain_name', d.name, 'hourly_rate', pj.hourly_rate\r\n      )) FILTER (WHERE j.id IS NOT NULL), '[]'::jsonb\r\n    ) AS jobs,\r\n    COALESCE(p.verified, false) AS verified,\r\n    COALESCE(p.vehicule, false) AS vehicule,\r\n    CASE WHEN p_lat IS NOT NULL AND p_lng IS NOT NULL THEN\r\n      ROUND((6371 * ACOS(\r\n        COS(RADIANS(p_lat)) * COS(RADIANS(p.zone_intervention_lat)) *\r\n        COS(RADIANS(p.zone_intervention_lng) - RADIANS(p_lng)) +\r\n        SIN(RADIANS(p_lat)) * SIN(RADIANS(p.zone_intervention_lat))\r\n      ))::numeric, 2)::double precision\r\n    ELSE NULL END AS distance_km,\r\n    COALESCE(p.benevolat, false) AS benevolat\r\n  FROM providers.providers p\r\n  INNER JOIN public.profiles pr ON pr.id = p.profile\r\n  LEFT JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n  LEFT JOIN jobs.jobs j ON j.id = pj.job\r\n  LEFT JOIN jobs.categories c ON c.id = j.category_id\r\n  LEFT JOIN jobs.domains d ON d.id = c.domain_id\r\n  LEFT JOIN providers.ratings r ON r.provider = p.id\r\n  WHERE\r\n    p.available = true\r\n    AND p.zone_intervention_lat IS NOT NULL\r\n    AND p.zone_intervention_lng IS NOT NULL\r\n    AND (p_benevole_only = false OR p.benevolat = true)\r\n    AND (p_job_id IS NULL OR EXISTS (\r\n      SELECT 1 FROM providers.provider_jobs pj2\r\n      WHERE pj2.provider = p.id AND pj2.job = p_job_id\r\n    ))\r\n    AND (\r\n      p_lat IS NULL OR p_lng IS NULL OR p_radius_km IS NULL\r\n      OR (6371 * ACOS(\r\n        COS(RADIANS(p_lat)) * COS(RADIANS(p.zone_intervention_lat)) *\r\n        COS(RADIANS(p.zone_intervention_lng) - RADIANS(p_lng)) +\r\n        SIN(RADIANS(p_lat)) * SIN(RADIANS(p.zone_intervention_lat))\r\n      )) <= p_radius_km\r\n    )\r\n    AND (\r\n      UPPER(COALESCE(p.situation, '')) <> 'INDEPENDANT'\r\n      OR (\r\n        (p.siret IS NOT NULL OR p.siret_enc IS NOT NULL)\r\n        AND (p.adresse_facturation IS NOT NULL OR p.adresse_facturation_enc IS NOT NULL)\r\n        AND p.regime_tva IS NOT NULL\r\n        AND providers.can_provider_create_new_mission(p.profile)\r\n      )\r\n    )\r\n  GROUP BY p.id, p.profile, pr.first_name, pr.last_name, pr.photo,\r\n           p.zone_intervention_lat, p.zone_intervention_lng, p.taux_horaire, p.more,\r\n           p.verified, p.vehicule, p.benevolat\r\n  ORDER BY\r\n    CASE WHEN p_lat IS NOT NULL AND p_lng IS NOT NULL THEN\r\n      (6371 * ACOS(\r\n        COS(RADIANS(p_lat)) * COS(RADIANS(p.zone_intervention_lat)) *\r\n        COS(RADIANS(p.zone_intervention_lng) - RADIANS(p_lng)) +\r\n        SIN(RADIANS(p_lat)) * SIN(RADIANS(p.zone_intervention_lat))\r\n      ))\r\n    ELSE 0 END ASC,\r\n    average_rating DESC NULLS LAST;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_providers_for_map_outdated",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_providers_for_map_outdated(p_job_id integer DEFAULT NULL::integer, p_lat double precision DEFAULT NULL::double precision, p_lng double precision DEFAULT NULL::double precision, p_radius_km integer DEFAULT NULL::integer)\n RETURNS TABLE(id uuid, profile_id uuid, first_name text, last_name text, photo uuid, latitude double precision, longitude double precision, hourly_rate double precision, description text, average_rating numeric, rating_count bigint, jobs jsonb, verified boolean, vehicule boolean, distance_km double precision)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$begin\r\n  return query\r\n  select\r\n    p.id,\r\n    p.profile as profile_id,\r\n    pr.first_name,\r\n    pr.last_name,\r\n    pr.photo,\r\n    p.zone_intervention_lat as latitude,\r\n    p.zone_intervention_lng as longitude,\r\n    coalesce(p.taux_horaire::double precision, (\r\n      select min(pj_rate.hourly_rate)\r\n      from providers.provider_jobs pj_rate\r\n      where pj_rate.provider = p.id and pj_rate.hourly_rate is not null\r\n    )) as hourly_rate,\r\n    p.more as description,\r\n    coalesce(round(avg(r.rate)::numeric, 1), null) as average_rating,\r\n    count(distinct r.id) as rating_count,\r\n    coalesce(\r\n      jsonb_agg(\r\n        distinct jsonb_build_object(\r\n          'job_id', j.id,\r\n          'job_name', j.name,\r\n          'domain_name', d.name,\r\n          'hourly_rate', pj.hourly_rate\r\n        )\r\n      ) filter (where j.id is not null),\r\n      '[]'::jsonb\r\n    ) as jobs,\r\n    coalesce(p.verified, false) as verified,\r\n    coalesce(p.vehicule, false) as vehicule,\r\n    case\r\n      when p_lat is not null and p_lng is not null then\r\n        round(\r\n          (6371 * acos(\r\n            cos(radians(p_lat)) * cos(radians(p.zone_intervention_lat)) *\r\n            cos(radians(p.zone_intervention_lng) - radians(p_lng)) +\r\n            sin(radians(p_lat)) * sin(radians(p.zone_intervention_lat))\r\n          ))::numeric, 2\r\n        )::double precision\r\n      else null\r\n    end as distance_km\r\n  from providers.providers p\r\n  inner join public.profiles pr on pr.id = p.profile\r\n  left join providers.provider_jobs pj on pj.provider = p.id\r\n  left join jobs.jobs j on j.id = pj.job\r\n  left join jobs.categories c on c.id = j.category_id\r\n  left join jobs.domains d on d.id = c.domain_id\r\n  left join providers.ratings r on r.provider = p.id\r\n  where\r\n    p.available = true\r\n    and p.zone_intervention_lat is not null\r\n    and p.zone_intervention_lng is not null\r\n    and (p_job_id is null or exists (\r\n      select 1 from providers.provider_jobs pj2\r\n      where pj2.provider = p.id and pj2.job = p_job_id\r\n    ))\r\n    and (\r\n      p_lat is null or p_lng is null or p_radius_km is null\r\n      or (6371 * acos(\r\n        cos(radians(p_lat)) * cos(radians(p.zone_intervention_lat)) *\r\n        cos(radians(p.zone_intervention_lng) - radians(p_lng)) +\r\n        sin(radians(p_lat)) * sin(radians(p.zone_intervention_lat))\r\n      )) <= p_radius_km\r\n    )\r\n  group by p.id, p.profile, pr.first_name, pr.last_name, pr.photo,\r\n           p.zone_intervention_lat, p.zone_intervention_lng, p.taux_horaire, p.more,\r\n           p.verified, p.vehicule\r\n  order by\r\n    case when p_lat is not null and p_lng is not null then\r\n      (6371 * acos(\r\n        cos(radians(p_lat)) * cos(radians(p.zone_intervention_lat)) *\r\n        cos(radians(p.zone_intervention_lng) - radians(p_lng)) +\r\n        sin(radians(p_lat)) * sin(radians(p.zone_intervention_lat))\r\n      ))\r\n    else 0 end asc,\r\n    average_rating desc nulls last;\r\nend;$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "get_providers_for_map_v3",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.get_providers_for_map_v3(p_job_id integer DEFAULT NULL::integer, p_geohash_candidates text[] DEFAULT NULL::text[], p_benevole_only boolean DEFAULT false)\n RETURNS TABLE(id uuid, profile_id uuid, first_name_enc text, last_name_enc text, photo uuid, hourly_rate double precision, description text, average_rating numeric, rating_count bigint, jobs jsonb, verified boolean, vehicule boolean, benevolat boolean, zone_intervention_lat_enc text, zone_intervention_lng_enc text)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT\r\n    p.id,\r\n    p.profile AS profile_id,\r\n    pr.first_name_enc,\r\n    pr.last_name_enc,\r\n    pr.photo,\r\n    COALESCE(p.taux_horaire::double precision, (\r\n      SELECT MIN(pj_rate.hourly_rate) FROM providers.provider_jobs pj_rate\r\n      WHERE pj_rate.provider = p.id AND pj_rate.hourly_rate IS NOT NULL\r\n    )) AS hourly_rate,\r\n    p.more AS description,\r\n    COALESCE(ROUND(AVG(r.rate)::numeric, 1), NULL) AS average_rating,\r\n    COUNT(DISTINCT r.id) AS rating_count,\r\n    COALESCE(\r\n      JSONB_AGG(DISTINCT JSONB_BUILD_OBJECT(\r\n        'job_id', j.id, 'job_name', j.name, 'domain_name', d.name, 'hourly_rate', pj.hourly_rate\r\n      )) FILTER (WHERE j.id IS NOT NULL), '[]'::jsonb\r\n    ) AS jobs,\r\n    COALESCE(p.verified, false) AS verified,\r\n    COALESCE(p.vehicule, false) AS vehicule,\r\n    COALESCE(p.benevolat, false) AS benevolat,\r\n    p.zone_intervention_lat_enc,\r\n    p.zone_intervention_lng_enc\r\n  FROM providers.providers p\r\n  INNER JOIN public.profiles pr ON pr.id = p.profile\r\n  LEFT JOIN providers.provider_jobs pj ON pj.provider = p.id\r\n  LEFT JOIN jobs.jobs j ON j.id = pj.job\r\n  LEFT JOIN jobs.categories c ON c.id = j.category_id\r\n  LEFT JOIN jobs.domains d ON d.id = c.domain_id\r\n  LEFT JOIN providers.ratings r ON r.provider = p.id\r\n  WHERE\r\n    p.available = true\r\n    AND p.zone_intervention_lat_enc IS NOT NULL\r\n    AND p.zone_intervention_lng_enc IS NOT NULL\r\n    AND (p_benevole_only = false OR p.benevolat = true)\r\n    AND (p_job_id IS NULL OR EXISTS (\r\n      SELECT 1 FROM providers.provider_jobs pj2\r\n      WHERE pj2.provider = p.id AND pj2.job = p_job_id\r\n    ))\r\n    AND (\r\n      p_geohash_candidates IS NULL\r\n      OR p.zone_intervention_geohash = ANY(p_geohash_candidates)\r\n    )\r\n    AND (\r\n      UPPER(COALESCE(p.situation, '')) <> 'INDEPENDANT'\r\n      OR (\r\n        p.siret_enc IS NOT NULL\r\n        AND p.adresse_facturation_enc IS NOT NULL\r\n        AND p.regime_tva IS NOT NULL\r\n        AND providers.can_provider_create_new_mission(p.profile)\r\n      )\r\n    )\r\n  GROUP BY p.id, p.profile, pr.first_name_enc, pr.last_name_enc, pr.photo,\r\n           p.taux_horaire, p.more, p.verified, p.vehicule, p.benevolat,\r\n           p.zone_intervention_lat_enc, p.zone_intervention_lng_enc;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gettransactionid",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gettransactionid()\n RETURNS xid\n LANGUAGE c\nAS '$libdir/postgis-3', $function$getTransactionID$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gidx_in",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gidx_in(cstring)\n RETURNS gidx\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gidx_in$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gidx_out",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gidx_out(gidx)\n RETURNS cstring\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gidx_out$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gserialized_gist_joinsel_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gserialized_gist_joinsel_2d(internal, oid, internal, smallint)\n RETURNS double precision\n LANGUAGE c\n PARALLEL SAFE\nAS '$libdir/postgis-3', $function$gserialized_gist_joinsel_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gserialized_gist_joinsel_nd",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gserialized_gist_joinsel_nd(internal, oid, internal, smallint)\n RETURNS double precision\n LANGUAGE c\n PARALLEL SAFE\nAS '$libdir/postgis-3', $function$gserialized_gist_joinsel_nd$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gserialized_gist_sel_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gserialized_gist_sel_2d(internal, oid, internal, integer)\n RETURNS double precision\n LANGUAGE c\n PARALLEL SAFE\nAS '$libdir/postgis-3', $function$gserialized_gist_sel_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "gserialized_gist_sel_nd",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.gserialized_gist_sel_nd(internal, oid, internal, integer)\n RETURNS double precision\n LANGUAGE c\n PARALLEL SAFE\nAS '$libdir/postgis-3', $function$gserialized_gist_sel_nd$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "is_contained_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.is_contained_2d(box2df, geometry)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_within_box2df_geom_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "is_contained_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.is_contained_2d(geometry, box2df)\n RETURNS boolean\n LANGUAGE sql\n IMMUTABLE PARALLEL SAFE STRICT COST 1\nAS $function$SELECT $2 OPERATOR(public.~) $1;$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "is_contained_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.is_contained_2d(box2df, box2df)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_contains_box2df_box2df_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "lockrow",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.lockrow(text, text, text)\n RETURNS integer\n LANGUAGE sql\n STRICT\nAS $function$ SELECT LockRow(current_schema(), $1, $2, $3, now()::timestamp+'1:00'); $function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "lockrow",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.lockrow(text, text, text, text)\n RETURNS integer\n LANGUAGE sql\n STRICT\nAS $function$ SELECT LockRow($1, $2, $3, $4, now()::timestamp+'1:00'); $function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "lockrow",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.lockrow(text, text, text, timestamp without time zone)\n RETURNS integer\n LANGUAGE sql\n STRICT\nAS $function$ SELECT LockRow(current_schema(), $1, $2, $3, $4); $function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "lockrow",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.lockrow(text, text, text, text, timestamp without time zone)\n RETURNS integer\n LANGUAGE plpgsql\n STRICT\nAS $function$\nDECLARE\n\tmyschema alias for $1;\n\tmytable alias for $2;\n\tmyrid   alias for $3;\n\tauthid alias for $4;\n\texpires alias for $5;\n\tret int;\n\tmytoid oid;\n\tmyrec RECORD;\n\nBEGIN\n\n\tIF NOT LongTransactionsEnabled() THEN\n\t\tRAISE EXCEPTION 'Long transaction support disabled, use EnableLongTransaction() to enable.';\n\tEND IF;\n\n\tEXECUTE 'DELETE FROM authorization_table WHERE expires < now()';\n\n\tSELECT c.oid INTO mytoid FROM pg_class c, pg_namespace n\n\t\tWHERE c.relname = mytable\n\t\tAND c.relnamespace = n.oid\n\t\tAND n.nspname = myschema;\n\n\t-- RAISE NOTICE 'toid: %', mytoid;\n\n\tFOR myrec IN SELECT * FROM authorization_table WHERE\n\t\ttoid = mytoid AND rid = myrid\n\tLOOP\n\t\tIF myrec.authid != authid THEN\n\t\t\tRETURN 0;\n\t\tELSE\n\t\t\tRETURN 1;\n\t\tEND IF;\n\tEND LOOP;\n\n\tEXECUTE 'INSERT INTO authorization_table VALUES ('||\n\t\tquote_literal(mytoid::text)||','||quote_literal(myrid)||\n\t\t','||quote_literal(expires::text)||\n\t\t','||quote_literal(authid) ||')';\n\n\tGET DIAGNOSTICS ret = ROW_COUNT;\n\n\tRETURN ret;\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "longtransactionsenabled",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.longtransactionsenabled()\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n\trec RECORD;\nBEGIN\n\tFOR rec IN SELECT oid FROM pg_class WHERE relname = 'authorized_tables'\n\tLOOP\n\t\treturn 't';\n\tEND LOOP;\n\treturn 'f';\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_2d(geometry, box2df)\n RETURNS boolean\n LANGUAGE sql\n IMMUTABLE PARALLEL SAFE STRICT COST 1\nAS $function$SELECT $2 OPERATOR(public.&&) $1;$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_2d(box2df, geometry)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_overlaps_box2df_geom_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_2d",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_2d(box2df, box2df)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_contains_box2df_box2df_2d$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_nd",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_nd(geometry, gidx)\n RETURNS boolean\n LANGUAGE sql\n IMMUTABLE PARALLEL SAFE STRICT COST 1\nAS $function$SELECT $2 OPERATOR(public.&&&) $1;$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_nd",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_nd(gidx, geometry)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_gidx_geom_overlaps$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "overlaps_nd",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.overlaps_nd(gidx, gidx)\n RETURNS boolean\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$gserialized_gidx_gidx_overlaps$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "path",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.path(geometry)\n RETURNS path\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$geometry_to_path$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "point",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.point(geometry)\n RETURNS point\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$geometry_to_point$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "polygon",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.polygon(geometry)\n RETURNS polygon\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$geometry_to_polygon$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "set_updated_at",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.set_updated_at()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\r\nBEGIN\r\n  NEW.updated_at := NOW();\r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "spheroid_in",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.spheroid_in(cstring)\n RETURNS spheroid\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$ellipsoid_in$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "spheroid_out",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.spheroid_out(spheroid)\n RETURNS cstring\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT\nAS '$libdir/postgis-3', $function$ellipsoid_out$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "submit_company_rating",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.submit_company_rating(p_company_id uuid, p_mission_id uuid, p_rate real, p_description text DEFAULT NULL::text)\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'public', 'companies', 'missions'\nAS $function$\r\nDECLARE\r\n    v_profile_id UUID;\r\n    v_rating_id UUID;\r\n    v_mission_exists BOOLEAN;\r\n    v_already_rated BOOLEAN;\r\nBEGIN\r\n    -- Recuperer le profile_id de l'utilisateur\r\n    v_profile_id := auth.uid();\r\n\r\n    IF v_profile_id IS NULL THEN\r\n        RAISE EXCEPTION 'Utilisateur non authentifie';\r\n    END IF;\r\n\r\n    -- Verifier que l'utilisateur a bien une mission terminee avec cette entreprise\r\n    -- 'assigned' = mission confirmée par le prestataire\r\n    -- 'completed' = mission marquée comme terminée\r\n    -- Also check that end_time has passed (mission actually finished)\r\n    SELECT EXISTS (\r\n        SELECT 1\r\n        FROM missions.profile_missions pm\r\n        JOIN missions.missions m ON m.id = pm.mission\r\n        WHERE pm.profile = v_profile_id\r\n          AND pm.mission = p_mission_id\r\n          AND m.company_id = p_company_id\r\n          AND pm.state IN ('assigned', 'completed', 'finished', 'termine')\r\n          AND m.end_time < NOW()\r\n    ) INTO v_mission_exists;\r\n\r\n    IF NOT v_mission_exists THEN\r\n        RAISE EXCEPTION 'Vous n''avez pas de mission terminee avec cette entreprise';\r\n    END IF;\r\n\r\n    -- Verifier que l'utilisateur n'a pas deja note cette mission\r\n    SELECT EXISTS (\r\n        SELECT 1\r\n        FROM companies.ratings\r\n        WHERE profile = v_profile_id\r\n          AND mission_id = p_mission_id\r\n    ) INTO v_already_rated;\r\n\r\n    IF v_already_rated THEN\r\n        RAISE EXCEPTION 'Vous avez deja note cette mission';\r\n    END IF;\r\n\r\n    -- Validation du rate\r\n    IF p_rate < 1 OR p_rate > 5 THEN\r\n        RAISE EXCEPTION 'La note doit etre entre 1 et 5';\r\n    END IF;\r\n\r\n    -- Inserer la notation\r\n    INSERT INTO companies.ratings (\r\n        profile,\r\n        company_id,\r\n        mission_id,\r\n        rate,\r\n        description\r\n    ) VALUES (\r\n        v_profile_id,\r\n        p_company_id,\r\n        p_mission_id,\r\n        p_rate,\r\n        p_description\r\n    )\r\n    RETURNING id INTO v_rating_id;\r\n\r\n    RETURN v_rating_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "submit_provider_rating",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.submit_provider_rating(p_provider_id uuid, p_mission_id uuid, p_rate numeric, p_description text DEFAULT NULL::text)\n RETURNS uuid\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'public', 'providers', 'missions', 'companies'\nAS $function$\r\nDECLARE\r\n    v_profile_id UUID;\r\n    v_company_id UUID;\r\n    v_rating_id UUID;\r\n    v_valid_assignment BOOLEAN;\r\n    v_already_rated BOOLEAN;\r\nBEGIN\r\n    -- Recuperer le profile_id de l'utilisateur\r\n    v_profile_id := auth.uid();\r\n\r\n    IF v_profile_id IS NULL THEN\r\n        RAISE EXCEPTION 'Utilisateur non authentifie';\r\n    END IF;\r\n\r\n    -- Recuperer l'entreprise de l'utilisateur\r\n    SELECT id INTO v_company_id\r\n    FROM companies.companies\r\n    WHERE profile = v_profile_id;\r\n\r\n    IF v_company_id IS NULL THEN\r\n        RAISE EXCEPTION 'Vous n''etes pas une entreprise';\r\n    END IF;\r\n\r\n    -- Verifier que le prestataire etait bien assigne a cette mission de l'entreprise\r\n    SELECT EXISTS (\r\n        SELECT 1\r\n        FROM missions.profile_missions pm\r\n        JOIN missions.missions m ON m.id = pm.mission\r\n        WHERE pm.provider = p_provider_id\r\n          AND pm.mission = p_mission_id\r\n          AND m.company_id = v_company_id\r\n          AND pm.state IN ('assigned', 'completed', 'finished', 'termine', 'contract_signed')\r\n    ) INTO v_valid_assignment;\r\n\r\n    IF NOT v_valid_assignment THEN\r\n        RAISE EXCEPTION 'Ce prestataire n''etait pas assigne a cette mission';\r\n    END IF;\r\n\r\n    -- Verifier que l'entreprise n'a pas deja note ce prestataire pour cette mission\r\n    SELECT EXISTS (\r\n        SELECT 1\r\n        FROM providers.ratings\r\n        WHERE company = v_company_id\r\n          AND provider = p_provider_id\r\n          AND mission = p_mission_id\r\n    ) INTO v_already_rated;\r\n\r\n    IF v_already_rated THEN\r\n        RAISE EXCEPTION 'Vous avez deja note ce prestataire pour cette mission';\r\n    END IF;\r\n\r\n    -- Validation du rate\r\n    IF p_rate < 1 OR p_rate > 5 THEN\r\n        RAISE EXCEPTION 'La note doit etre entre 1 et 5';\r\n    END IF;\r\n\r\n    -- Inserer la notation\r\n    INSERT INTO providers.ratings (\r\n        provider,\r\n        company,\r\n        mission,\r\n        rate,\r\n        description\r\n    ) VALUES (\r\n        p_provider_id,\r\n        v_company_id,\r\n        p_mission_id,\r\n        p_rate,\r\n        p_description\r\n    )\r\n    RETURNING id INTO v_rating_id;\r\n\r\n    RETURN v_rating_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "text",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.text(geometry)\n RETURNS text\n LANGUAGE c\n IMMUTABLE PARALLEL SAFE STRICT COST 50\nAS '$libdir/postgis-3', $function$LWGEOM_to_text$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "unlockrows",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.unlockrows(text)\n RETURNS integer\n LANGUAGE plpgsql\n STRICT\nAS $function$\nDECLARE\n\tret int;\nBEGIN\n\n\tIF NOT LongTransactionsEnabled() THEN\n\t\tRAISE EXCEPTION 'Long transaction support disabled, use EnableLongTransaction() to enable.';\n\tEND IF;\n\n\tEXECUTE 'DELETE FROM authorization_table where authid = ' ||\n\t\tquote_literal($1);\n\n\tGET DIAGNOSTICS ret = ROW_COUNT;\n\n\tRETURN ret;\nEND;\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "update_availability",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.update_availability(p_id uuid, p_start_time text, p_end_time text, p_type text, p_note text, p_is_recurring boolean, p_weekdays integer[], p_start_date date, p_end_date date)\n RETURNS providers.availabilities\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  updated_availability providers.availabilities;\r\nBEGIN\r\n  -- Update the availability\r\n  UPDATE providers.availabilities\r\n  SET\r\n    start_time = p_start_time::time,\r\n    end_time = p_end_time::time,\r\n    type = p_type,\r\n    note = p_note,\r\n    is_recurring = p_is_recurring,\r\n    weekdays = p_weekdays,\r\n    start_date = p_start_date,\r\n    end_date = p_end_date,\r\n    updated_at = NOW()\r\n  WHERE id = p_id\r\n  RETURNING * INTO updated_availability;\r\n\r\n  RETURN updated_availability;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "update_profile_info",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.update_profile_info(p_profile_id uuid, p_first_name text DEFAULT NULL::text, p_last_name text DEFAULT NULL::text, p_phone text DEFAULT NULL::text, p_photo uuid DEFAULT NULL::uuid, p_vehicule boolean DEFAULT NULL::boolean)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  UPDATE public.profiles\r\n  SET\r\n    first_name = COALESCE(p_first_name, first_name),\r\n    last_name = COALESCE(p_last_name, last_name),\r\n    phone = COALESCE(p_phone, phone),\r\n    photo = COALESCE(p_photo, photo),\r\n    vehicule = COALESCE(p_vehicule, vehicule)\r\n  WHERE id = p_profile_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "update_profile_info_v2",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.update_profile_info_v2(p_profile_id uuid, p_first_name_enc text DEFAULT NULL::text, p_last_name_enc text DEFAULT NULL::text, p_phone_enc text DEFAULT NULL::text, p_phone_bidx text DEFAULT NULL::text, p_photo uuid DEFAULT NULL::uuid, p_vehicule boolean DEFAULT NULL::boolean)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n    UPDATE public.profiles\r\n    SET\r\n        first_name_enc = COALESCE(p_first_name_enc, first_name_enc),\r\n        last_name_enc = COALESCE(p_last_name_enc, last_name_enc),\r\n        phone_enc = COALESCE(p_phone_enc, phone_enc),\r\n        phone_bidx = COALESCE(p_phone_bidx, phone_bidx),\r\n        photo = COALESCE(p_photo, photo),\r\n        vehicule = COALESCE(p_vehicule, vehicule)\r\n    WHERE id = p_profile_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "FUNCTION",
        "table_schema": "public",
        "object_name": "update_provider_info",
        "column_name": null,
        "data_type": null,
        "is_nullable": null,
        "column_default": null,
        "full_definition": "CREATE OR REPLACE FUNCTION public.update_provider_info(p_profile_id uuid, p_vehicule boolean DEFAULT NULL::boolean, p_more text DEFAULT NULL::text, p_diplomes text DEFAULT NULL::text, p_adresse_facturation json DEFAULT NULL::json, p_regime_tva boolean DEFAULT NULL::boolean)\n RETURNS void\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  UPDATE providers.providers\r\n  SET\r\n    vehicule = COALESCE(p_vehicule, vehicule),\r\n    more = COALESCE(p_more, more),\r\n    diplomes = COALESCE(p_diplomes, diplomes),\r\n    adresse_facturation = COALESCE(p_adresse_facturation, adresse_facturation),\r\n    regime_tva = COALESCE(p_regime_tva, regime_tva)\r\n  WHERE profile = p_profile_id;\r\nEND;\r\n$function$\n"
    },
    {
        "object_type": "POLICY",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "Enable users to view their own data only",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Enable users to view their own data only\" ON companies.companies AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "Enable users to update their own data only",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable users to update their own data only\" ON companies.companies AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((( SELECT auth.uid() AS uid) = profile)) WITH CHECK ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "Enable insert for authenticated users only",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable insert for authenticated users only\" ON companies.companies AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "Enable read access for all users",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Enable read access for all users\" ON companies.ratings AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "allow select all",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{anon,authenticated}",
        "full_definition": "CREATE POLICY \"allow select all\" ON jobs.categories AS PERMISSIVE FOR SELECT TO {anon,authenticated} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "allow select all",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{anon,authenticated}",
        "full_definition": "CREATE POLICY \"allow select all\" ON jobs.domains AS PERMISSIVE FOR SELECT TO {anon,authenticated} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "allow select all",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{anon,authenticated}",
        "full_definition": "CREATE POLICY \"allow select all\" ON jobs.jobs AS PERMISSIVE FOR SELECT TO {anon,authenticated} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Company can read own contracts",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company can read own contracts\" ON missions.contrats AS PERMISSIVE FOR SELECT TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = contrats.profile_mission) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Company peut voir son contrat",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Company peut voir son contrat\" ON missions.contrats AS PERMISSIVE FOR SELECT TO {public} USING ((EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((pm.mission = m.id)))\n     JOIN companies.companies c ON ((m.company_id = c.id)))\n  WHERE ((pm.id = contrats.profile_mission) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Provider peut voir son contrat",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Provider peut voir son contrat\" ON missions.contrats AS PERMISSIVE FOR SELECT TO {public} USING ((EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.id = contrats.profile_mission) AND (pm.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Provider can create contracts",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Provider can create contracts\" ON missions.contrats AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.id = contrats.profile_mission) AND (pm.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Provider can update own contracts",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Provider can update own contracts\" ON missions.contrats AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.id = contrats.profile_mission) AND (pm.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Provider can read own contracts",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Provider can read own contracts\" ON missions.contrats AS PERMISSIVE FOR SELECT TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.id = contrats.profile_mission) AND (pm.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "Company can update own contracts",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company can update own contracts\" ON missions.contrats AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = contrats.profile_mission) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "Users can view their disputes",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Users can view their disputes\" ON missions.disputes AS PERMISSIVE FOR SELECT TO {public} USING (((opened_by_profile = auth.uid()) OR (EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = disputes.profile_mission) AND ((pm.profile = auth.uid()) OR (c.profile = auth.uid())))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "Users can create disputes for their missions",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Users can create disputes for their missions\" ON missions.disputes AS PERMISSIVE FOR INSERT TO {public} WITH CHECK ((EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = disputes.profile_mission) AND ((pm.profile = auth.uid()) OR (c.profile = auth.uid()))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "invoice_sequences",
        "column_name": "Only service can manage sequences",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Only service can manage sequences\" ON missions.invoice_sequences AS PERMISSIVE FOR ALL TO {public} USING (false) WITH CHECK (false);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "Allow insert for service role",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Allow insert for service role\" ON missions.invoices AS PERMISSIVE FOR INSERT TO {service_role} WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "Companies can view their received invoices",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Companies can view their received invoices\" ON missions.invoices AS PERMISSIVE FOR SELECT TO {public} USING ((recipient_company_id IN ( SELECT companies.id\n   FROM companies.companies\n  WHERE (companies.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "Providers can view their issued invoices",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Providers can view their issued invoices\" ON missions.invoices AS PERMISSIVE FOR SELECT TO {public} USING ((issuer_id IN ( SELECT providers.id\n   FROM providers.providers\n  WHERE (providers.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "Participants can view messages",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Participants can view messages\" ON missions.messages AS PERMISSIVE FOR SELECT TO {public} USING ((EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = messages.profile_mission_id) AND ((pm.profile = auth.uid()) OR (c.profile = auth.uid()))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "Recipient can update read status",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Recipient can update read status\" ON missions.messages AS PERMISSIVE FOR UPDATE TO {public} USING (((sender_id IS DISTINCT FROM auth.uid()) AND (EXISTS ( SELECT 1\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((pm.id = messages.profile_mission_id) AND ((pm.profile = auth.uid()) OR (c.profile = auth.uid()))))))) WITH CHECK ((is_read = true));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "Participants can insert messages",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Participants can insert messages\" ON missions.messages AS PERMISSIVE FOR INSERT TO {public} WITH CHECK (((sender_id = auth.uid()) AND (message_type = 'user'::text) AND (content_enc IS NOT NULL) AND (content_enc ~~ 'v1:%'::text) AND (EXISTS ( SELECT 1\n   FROM (((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n     JOIN missions.contrats ct ON ((ct.profile_mission = pm.id)))\n  WHERE ((pm.id = messages.profile_mission_id) AND ((pm.profile = auth.uid()) OR (c.profile = auth.uid())) AND (ct.provider_signed_at IS NOT NULL) AND (ct.company_signed_at IS NOT NULL))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "mission_schedules_delete_policy",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"mission_schedules_delete_policy\" ON missions.mission_schedules AS PERMISSIVE FOR DELETE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM (missions.missions m\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((m.id = mission_schedules.mission_id) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "mission_schedules_select_policy",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"mission_schedules_select_policy\" ON missions.mission_schedules AS PERMISSIVE FOR SELECT TO {authenticated} USING ((missions.is_company_owner_of_mission(mission_id) OR (EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.mission = mission_schedules.mission_id) AND (pm.profile = auth.uid()) AND (pm.state = ANY (ARRAY['confirmed'::text, 'employer_signed'::text, 'assigned'::text, 'completed'::text])))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "mission_schedules_insert_policy",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"mission_schedules_insert_policy\" ON missions.mission_schedules AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((EXISTS ( SELECT 1\n   FROM (missions.missions m\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((m.id = mission_schedules.mission_id) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "Company update mission",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company update mission\" ON missions.missions AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM companies.companies c\n  WHERE ((c.id = missions.company_id) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "Candidat view open missions",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Candidat view open missions\" ON missions.missions AS PERMISSIVE FOR SELECT TO {public} USING (((status = 'open'::text) OR ((status = 'closed'::text) AND (auth.role() = 'authenticated'::text) AND (EXISTS ( SELECT 1\n   FROM missions.profile_missions pm\n  WHERE ((pm.mission = missions.id) AND (pm.profile = auth.uid())))))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "Company insert mission",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company insert mission\" ON missions.missions AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((EXISTS ( SELECT 1\n   FROM companies.companies c\n  WHERE ((c.id = missions.company_id) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "Company read own missions",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company read own missions\" ON missions.missions AS PERMISSIVE FOR SELECT TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM companies.companies c\n  WHERE ((c.id = missions.company_id) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "company_read_own_payment_events",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"company_read_own_payment_events\" ON missions.payment_events AS PERMISSIVE FOR SELECT TO {authenticated} USING ((payment_flow_id IN ( SELECT pf.id\n   FROM (((missions.payment_flows pf\n     JOIN missions.profile_missions pm ON ((pm.id = pf.profile_mission_id)))\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE (c.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "provider_read_own_payment_events",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"provider_read_own_payment_events\" ON missions.payment_events AS PERMISSIVE FOR SELECT TO {authenticated} USING ((payment_flow_id IN ( SELECT pf.id\n   FROM (missions.payment_flows pf\n     JOIN missions.profile_missions pm ON ((pm.id = pf.profile_mission_id)))\n  WHERE (pm.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "company_read_own_payment_flows",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"company_read_own_payment_flows\" ON missions.payment_flows AS PERMISSIVE FOR SELECT TO {authenticated} USING ((profile_mission_id IN ( SELECT pm.id\n   FROM ((missions.profile_missions pm\n     JOIN missions.missions m ON ((m.id = pm.mission)))\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE (c.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "provider_read_own_payment_flows",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"provider_read_own_payment_flows\" ON missions.payment_flows AS PERMISSIVE FOR SELECT TO {authenticated} USING ((profile_mission_id IN ( SELECT profile_missions.id\n   FROM missions.profile_missions\n  WHERE (profile_missions.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Users can insert their own applications",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can insert their own applications\" ON missions.profile_missions AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK (((profile = auth.uid()) AND providers.can_provider_create_new_mission(auth.uid())));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Company can update popup_mission_saved",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company can update popup_mission_saved\" ON missions.profile_missions AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM (missions.missions m\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((m.id = profile_missions.mission) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Provider can update popup_contract_pending_seen",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Provider can update popup_contract_pending_seen\" ON missions.profile_missions AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Users can view their own applications or applications to their ",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can view their own applications or applications to their \" ON missions.profile_missions AS PERMISSIVE FOR SELECT TO {authenticated} USING (((profile = auth.uid()) OR missions.is_company_owner_of_mission(mission)));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Provider can update popup_mission_finished_provider",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Provider can update popup_mission_finished_provider\" ON missions.profile_missions AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "Company can update popup_mission_finished",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Company can update popup_mission_finished\" ON missions.profile_missions AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((EXISTS ( SELECT 1\n   FROM (missions.missions m\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((m.id = profile_missions.mission) AND (c.profile = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1\n   FROM (missions.missions m\n     JOIN companies.companies c ON ((c.id = m.company_id)))\n  WHERE ((m.id = profile_missions.mission) AND (c.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "Users can delete their own availabilities",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can delete their own availabilities\" ON providers.availabilities AS PERMISSIVE FOR DELETE TO {authenticated} USING ((provider = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "Users can insert their own availabilities",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can insert their own availabilities\" ON providers.availabilities AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((provider = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "Authenticated users can view availabilities",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Authenticated users can view availabilities\" ON providers.availabilities AS PERMISSIVE FOR SELECT TO {authenticated} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "Users can update their own availabilities",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can update their own availabilities\" ON providers.availabilities AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((provider = auth.uid())) WITH CHECK ((provider = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "Providers can view their own cancellation logs",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Providers can view their own cancellation logs\" ON providers.cancellation_logs AS PERMISSIVE FOR SELECT TO {authenticated} USING ((provider_id IN ( SELECT providers.id\n   FROM providers.providers\n  WHERE (providers.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "Users can update their own diplomes",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can update their own diplomes\" ON providers.diplomes AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((profile = auth.uid())) WITH CHECK ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "Users can delete their own diplomes",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can delete their own diplomes\" ON providers.diplomes AS PERMISSIVE FOR DELETE TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "Users can view their own diplomes",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can view their own diplomes\" ON providers.diplomes AS PERMISSIVE FOR SELECT TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "Enable insert for users based on profile id",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable insert for users based on profile id\" ON providers.diplomes AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((auth.uid() = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "Enable insert for users based on profile",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Enable insert for users based on profile\" ON providers.experiences AS PERMISSIVE FOR INSERT TO {public} WITH CHECK ((auth.uid() = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "Users can delete their own experiences",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can delete their own experiences\" ON providers.experiences AS PERMISSIVE FOR DELETE TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "Users can view their own experiences",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can view their own experiences\" ON providers.experiences AS PERMISSIVE FOR SELECT TO {authenticated} USING ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "Users can update their own experiences",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can update their own experiences\" ON providers.experiences AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((profile = auth.uid())) WITH CHECK ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "Providers can delete their own tokens",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Providers can delete their own tokens\" ON providers.google_tokens AS PERMISSIVE FOR DELETE TO {public} USING ((provider_id = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "Providers can view their own tokens",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Providers can view their own tokens\" ON providers.google_tokens AS PERMISSIVE FOR SELECT TO {public} USING ((provider_id = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "Delete own jobs",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Delete own jobs\" ON providers.provider_jobs AS PERMISSIVE FOR DELETE TO {public} USING ((provider IN ( SELECT providers.id\n   FROM providers.providers\n  WHERE (providers.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "Public can view provider jobs for map",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Public can view provider jobs for map\" ON providers.provider_jobs AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "allow select own provider_jobs",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"allow select own provider_jobs\" ON providers.provider_jobs AS PERMISSIVE FOR SELECT TO {authenticated} USING ((provider IN ( SELECT providers.id\n   FROM providers.providers\n  WHERE (providers.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "allow insert if provider belongs to user",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"allow insert if provider belongs to user\" ON providers.provider_jobs AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((provider IN ( SELECT providers.id\n   FROM providers.providers\n  WHERE (providers.profile = auth.uid()))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "Provider peut modifier ses photos",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Provider peut modifier ses photos\" ON providers.provider_portfolio AS PERMISSIVE FOR UPDATE TO {public} USING ((EXISTS ( SELECT 1\n   FROM providers.providers p\n  WHERE ((p.id = provider_portfolio.provider_id) AND (p.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "Provider peut supprimer ses photos",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Provider peut supprimer ses photos\" ON providers.provider_portfolio AS PERMISSIVE FOR DELETE TO {public} USING ((EXISTS ( SELECT 1\n   FROM providers.providers p\n  WHERE ((p.id = provider_portfolio.provider_id) AND (p.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "Provider peut ajouter ses photos",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Provider peut ajouter ses photos\" ON providers.provider_portfolio AS PERMISSIVE FOR INSERT TO {public} WITH CHECK ((EXISTS ( SELECT 1\n   FROM providers.providers p\n  WHERE ((p.id = provider_portfolio.provider_id) AND (p.profile = auth.uid())))));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "Portfolio visible publiquement",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Portfolio visible publiquement\" ON providers.provider_portfolio AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "Enable users to update their own data only",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable users to update their own data only\" ON providers.providers AS PERMISSIVE FOR UPDATE TO {authenticated} USING ((( SELECT auth.uid() AS uid) = profile)) WITH CHECK ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "Enable users to view their own data only",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable users to view their own data only\" ON providers.providers AS PERMISSIVE FOR SELECT TO {authenticated} USING ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "Users can insert their own provider profile",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Users can insert their own provider profile\" ON providers.providers AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((profile = auth.uid()));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "Public can read provider ratings",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Public can read provider ratings\" ON providers.ratings AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "providers",
        "object_name": "situations",
        "column_name": "Anyone can read situations",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Anyone can read situations\" ON providers.situations AS PERMISSIVE FOR SELECT TO {public} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.api_rate_limits AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.audit_log AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.contract_evidence_checks AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.contract_evidence_daily_seals AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.contract_evidence_scan_state AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "Enable read access for anon",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{anon}",
        "full_definition": "CREATE POLICY \"Enable read access for anon\" ON public.documents AS PERMISSIVE FOR SELECT TO {anon} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "Enable insert for users based on user_id",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Enable insert for users based on user_id\" ON public.documents AS PERMISSIVE FOR INSERT TO {public} WITH CHECK ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "Enable delete for users based on user_id",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Enable delete for users based on user_id\" ON public.documents AS PERMISSIVE FOR DELETE TO {public} USING ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "Update own",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Update own\" ON public.documents AS PERMISSIVE FOR UPDATE TO {public} USING ((( SELECT auth.uid() AS uid) = profile));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "Enable read access for authenticated users",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Enable read access for authenticated users\" ON public.documents AS PERMISSIVE FOR SELECT TO {authenticated} USING (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.otp_codes AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "Update own profile",
        "data_type": "UPDATE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Update own profile\" ON public.profiles AS PERMISSIVE FOR UPDATE TO {public} USING ((auth.uid() = id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "Profiles: insert own profile",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Profiles: insert own profile\" ON public.profiles AS PERMISSIVE FOR INSERT TO {authenticated} WITH CHECK ((auth.uid() = id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "Read own profile",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Read own profile\" ON public.profiles AS PERMISSIVE FOR SELECT TO {public} USING ((auth.uid() = id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "Users can delete their own push subscriptions",
        "data_type": "DELETE",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Users can delete their own push subscriptions\" ON public.push_subscriptions AS PERMISSIVE FOR DELETE TO {public} USING ((auth.uid() = user_id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "Users can insert their own push subscriptions",
        "data_type": "INSERT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Users can insert their own push subscriptions\" ON public.push_subscriptions AS PERMISSIVE FOR INSERT TO {public} WITH CHECK ((auth.uid() = user_id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "Users can view their own push subscriptions",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{public}",
        "full_definition": "CREATE POLICY \"Users can view their own push subscriptions\" ON public.push_subscriptions AS PERMISSIVE FOR SELECT TO {public} USING ((auth.uid() = user_id));"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "stripe_webhook_events",
        "column_name": "Service role only",
        "data_type": "ALL",
        "is_nullable": "PERMISSIVE",
        "column_default": "{service_role}",
        "full_definition": "CREATE POLICY \"Service role only\" ON public.stripe_webhook_events AS PERMISSIVE FOR ALL TO {service_role} USING (true) WITH CHECK (true);"
    },
    {
        "object_type": "POLICY",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "Authenticated users can read trames",
        "data_type": "SELECT",
        "is_nullable": "PERMISSIVE",
        "column_default": "{authenticated}",
        "full_definition": "CREATE POLICY \"Authenticated users can read trames\" ON public.trames AS PERMISSIVE FOR SELECT TO {authenticated} USING (true);"
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "nom_commercial",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "accept_emails_alert",
        "data_type": "jsonb",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "accept_newsletter",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "company_type",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "verified",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "employee_count",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "code_ape",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "can_post_volunteer_missions",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "done_onboarding",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "accept_notifications",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "accept_cgu",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "siret_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "stripe_customer_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "stripe_customer_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "siret_gouv_infos_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "companies",
        "column_name": "siret_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "mission_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "rate",
        "data_type": "real",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "company_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "companies",
        "object_name": "ratings",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "updated_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "created_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "name",
        "data_type": "character varying",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "domain_id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "categories",
        "column_name": "id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "nextval('jobs.categories_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "name",
        "data_type": "character varying",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "created_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "updated_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "domains",
        "column_name": "id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "nextval('jobs.domains_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "category_id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "nextval('jobs.jobs_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "updated_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "created_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "skills_required",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "average_hourly_rate",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "jobs",
        "object_name": "jobs",
        "column_name": "name",
        "data_type": "character varying",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_payload_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_prev_event_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_prev_event_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_event_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_event_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "evidence_retention_until",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "evidence_legal_hold",
        "data_type": "boolean",
        "is_nullable": "NO",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "evidence_legal_hold_reason",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "evidence_last_integrity_check_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "evidence_last_integrity_status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_text_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_version_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_screen",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_locale",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_text",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_text_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_version_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_user_agent_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_user_agent_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_ip_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_text",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "signature_certificate_json_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "signature_status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "signature_certificate_generated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_certificate_pdf_path",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_certificate_pdf_path",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "pdf_generated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "pdf_file_path",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_consent_checkbox",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_otp_attempts",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_otp_verified_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_otp_expires_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_otp_created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_otp_code_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_checkbox",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_otp_attempts",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_otp_verified_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_otp_expires_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_otp_created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_otp_code_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "trame",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'pending_company'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signed_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signed_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "document_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "profile_mission",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_ip_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_locale",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_consent_screen",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_request_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_request_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_forwarded_chain_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "provider_signature_forwarded_chain_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "contrats",
        "column_name": "company_signature_payload_hash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "status",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "disputed_hours_supp",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "resolution_outcome",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "resolution_notes",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "resolved_by",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "resolved_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "opened_by",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "profile_mission",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "opened_by_profile",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "opened_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "reason",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "disputed_hours_worked",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "auto_release_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "stripe_dispute_pi_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "disputes",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoice_sequences",
        "column_name": "year_month_day",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoice_sequences",
        "column_name": "last_number",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoice_sequences",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoice_sequences",
        "column_name": "id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "nextval('missions.invoice_sequences_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "email_sent_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_name_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_address_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_siret_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_tva_number_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_name_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_address_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_siret_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_siret_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_tva_number_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_siret_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "email_recipient_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "email_recipient_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "profile_mission_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "mission_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "invoice_type",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_type",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "issuer_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "recipient_company_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "invoice_number",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "invoice_date",
        "data_type": "date",
        "is_nullable": "NO",
        "column_default": "CURRENT_DATE",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "amount_ht",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "tva_rate",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "tva_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "amount_ttc",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "mission_date",
        "data_type": "date",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "hours_worked",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "hours_supp",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "hourly_rate",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "hourly_rate_supp",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "pdf_storage_path",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "invoices",
        "column_name": "pdf_generated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "profile_mission_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "sender_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "message_type",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'user'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "system_event",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "is_read",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "read_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "messages",
        "column_name": "content_enc",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "start_time",
        "data_type": "time without time zone",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "schedule_date",
        "data_type": "date",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "mission_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "mission_schedules",
        "column_name": "end_time",
        "data_type": "time without time zone",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "items_to_bring",
        "data_type": "ARRAY",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "job",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "postal_code",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "city",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "requires_mobility",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "nb_participants",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "avantages",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "hours_supp",
        "data_type": "smallint",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "start_date",
        "data_type": "date",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "end_date",
        "data_type": "date",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "is_multi_day",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'open'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "salary",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "end_time",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "start_time",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "longitude",
        "data_type": "double precision",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "latitude",
        "data_type": "double precision",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "title",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "company_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "location",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "is_paid",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "created_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "missions",
        "column_name": "benevole",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "metadata",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'{}'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "error_code",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_transfer_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_transfer_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_charge_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_charge_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_payment_intent_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "stripe_payment_intent_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "amount_platform_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "amount_provider_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "payment_flow_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "phase",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "action",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "status",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "amount_total_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_events",
        "column_name": "error_message",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "deposit_rate",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": "0.30",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "payment_status_summary",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "final_status",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "initial_status",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "last_error_message",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "last_error_code",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "auto_validated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "report_locked_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "next_retry_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "retry_count",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_transfer_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_transfer_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_final_charge_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_final_charge_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "profile_mission_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "commission_base_captured_ttc_cents",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "deposit_captured_ttc_cents",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_initial_charge_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_final_payment_intent_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_final_payment_intent_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_initial_payment_intent_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_initial_payment_intent_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "commission_supp_captured_ttc_cents",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "final_platform_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "final_provider_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "final_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "stripe_initial_charge_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "initial_platform_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "initial_provider_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "initial_amount_cents",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "threshold_ht",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": "800",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "payment_flows",
        "column_name": "commission_rate_ttc",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": "0.125",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "refund_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "refund_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "deadline_reminder_sent",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "transfer_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "escrow_captured_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "escrow_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider_signature_deadline",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "cancellation_hours_before_start",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider_paid_on_cancel",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "cancellation_reason",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "popup_contract_finalized_seen",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "popup_contract_pending_seen",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider_validation_status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider_validated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "report_comment",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "report_hours_supp",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "report_hours_worked",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "report_submitted_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "popup_mission_finished_provider",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "canceled_by",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "canceled_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "commission_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "hours_supp_worked",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "hours_worked",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "payment_captured_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "commission_rate",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "12.5",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "payment_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "payment_status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'pending'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "payment_intent_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "popup_mission_finished",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "popup_mission_saved",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "origin",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'applied'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "price_hour_supp",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "price_hour",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "state",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "provider",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "mission",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "amount_ttc_provider",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "tva_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "amount_ht",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "supp_hours_transfer_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "supp_hours_escrow_captured_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "supp_hours_amount",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "missions",
        "object_name": "profile_missions",
        "column_name": "supp_hours_payment_intent_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "provider",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "end_date",
        "data_type": "date",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "start_time",
        "data_type": "time without time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "end_time",
        "data_type": "time without time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "weekdays",
        "data_type": "ARRAY",
        "is_nullable": "YES",
        "column_default": "'{1,2,3,4,5}'::integer[]",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "type",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'available'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "note",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "is_recurring",
        "data_type": "boolean",
        "is_nullable": "NO",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "availabilities",
        "column_name": "start_date",
        "data_type": "date",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "hours_before_start",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "contract_fully_signed",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "reason",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "sanction_applied",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "sanction_applied_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "canceled_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "mission_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "profile_mission_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "provider_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "cancellation_logs",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "provider_job",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "intitule",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "diplomes",
        "column_name": "id",
        "data_type": "bigint",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "start",
        "data_type": "date",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "provider_job",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "intitule",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "id",
        "data_type": "bigint",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "company",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "experiences",
        "column_name": "end",
        "data_type": "date",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "sync_error",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "provider_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "refresh_token",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "access_token",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "token_expires_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "calendar_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": "'primary'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "sync_enabled",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "true",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "last_sync_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "day_start_hour",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "8",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "day_end_hour",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "18",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "google_tokens",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "provider",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "hourly_rate",
        "data_type": "double precision",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "job",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_jobs",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "caption",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "position",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "document_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "provider_portfolio",
        "column_name": "provider_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "vehicule",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "tva_number_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "tva_number_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "stripe_id_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "stripe_id_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_geohash",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_lng_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_lat_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "adresse_facturation_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "siret_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "siret_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "accept_emails_alert",
        "data_type": "jsonb",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "tva_number",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "last_successful_mission_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "suspension_expires_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "suspension_status",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "last_cancellation_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "total_cancellations",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "consecutive_cancellations",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_last_check_prompted",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "available",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "true",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "verified",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "taux_horaire",
        "data_type": "numeric",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_lng",
        "data_type": "double precision",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_lat",
        "data_type": "double precision",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "stripe_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "done_onboarding",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "accept_newsletter",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "accept_notifications",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "accept_geoloc",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "accept_cgu",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "benevolat",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "situation",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "diplomes",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_rayon",
        "data_type": "bigint",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "zone_intervention_cp",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "titulaire_compte_banc",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "assurance_pro",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "regime_tva",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "adresse_facturation",
        "data_type": "json",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "attestation_vigilance",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "avis_situ_siren",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "siret",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "more",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "providers",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "provider",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "company",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "mission",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "rate",
        "data_type": "numeric",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "ratings",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "situations",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "situations",
        "column_name": "name",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "providers",
        "object_name": "situations",
        "column_name": "id",
        "data_type": "bigint",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "namespace",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "rate_key_hash",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "request_count",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "reset_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "api_rate_limits",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "user_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "user_agent_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "ip_address_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "details",
        "data_type": "jsonb",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "resource_id",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "resource_type",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "audit_log",
        "column_name": "action",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "overall_passed",
        "data_type": "boolean",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "checks",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'{}'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "contract_updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "checked_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "contract_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "id",
        "data_type": "bigint",
        "is_nullable": "NO",
        "column_default": "nextval('contract_evidence_checks_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_checks",
        "column_name": "failure_reasons",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'[]'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "seal_date",
        "data_type": "date",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "contract_ids",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'[]'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "contract_count",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "manifest_hash",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "manifest_hmac",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "algorithm",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'sha256+hmac-sha256'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_daily_seals",
        "column_name": "sealed_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "last_checked_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "cursor_last_id",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "cursor_updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "'1970-01-01 00:00:00+00'::timestamp with time zone",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "id",
        "data_type": "smallint",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "contract_evidence_scan_state",
        "column_name": "last_scan_count",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "bucket",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": "'documents'::text",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "extension",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "cache_control",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "type",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "uploaded_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "profile",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "file_path",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "documents",
        "column_name": "is_public",
        "data_type": "boolean",
        "is_nullable": "NO",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "sent_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "alert_key",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "role",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "profile_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "metadata",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'{}'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "email_alert_logs",
        "column_name": "dedupe_key",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "email_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "ip_address_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "hash",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "type",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "attempts",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "0",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "max_attempts",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": "5",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "expires_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "otp_codes",
        "column_name": "email_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "gender",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "created_at",
        "data_type": "timestamp without time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "done_onboarding",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "vehicule",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "true",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "photo",
        "data_type": "uuid",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "phone_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "nationality_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "address_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "role",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "available",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "first_name_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "email_bidx",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "tutorial_completed",
        "data_type": "boolean",
        "is_nullable": "YES",
        "column_default": "false",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "tutorial_completed_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "email_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "last_name_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "birth_date_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "profiles",
        "column_name": "phone_enc",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "endpoint",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "keys",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "user_id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "push_subscriptions",
        "column_name": "id",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": "nextval('push_subscriptions_id_seq'::regclass)",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "spatial_ref_sys",
        "column_name": "srid",
        "data_type": "integer",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "spatial_ref_sys",
        "column_name": "proj4text",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "spatial_ref_sys",
        "column_name": "srtext",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "spatial_ref_sys",
        "column_name": "auth_srid",
        "data_type": "integer",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "spatial_ref_sys",
        "column_name": "auth_name",
        "data_type": "character varying",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "stripe_webhook_events",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "gen_random_uuid()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "stripe_webhook_events",
        "column_name": "stripe_event_id",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "stripe_webhook_events",
        "column_name": "event_type",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "stripe_webhook_events",
        "column_name": "processed_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "YES",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "id",
        "data_type": "uuid",
        "is_nullable": "NO",
        "column_default": "uuid_generate_v4()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "key",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "name",
        "data_type": "text",
        "is_nullable": "NO",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "description",
        "data_type": "text",
        "is_nullable": "YES",
        "column_default": null,
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "vars_schema",
        "data_type": "jsonb",
        "is_nullable": "NO",
        "column_default": "'{}'::jsonb",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "created_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "updated_at",
        "data_type": "timestamp with time zone",
        "is_nullable": "NO",
        "column_default": "now()",
        "full_definition": null
    },
    {
        "object_type": "TABLE",
        "table_schema": "public",
        "object_name": "trames",
        "column_name": "pdfkit_template",
        "data_type": "jsonb",
        "is_nullable": "YES",
        "column_default": "'{}'::jsonb",
        "full_definition": null
    }
]